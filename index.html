<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FILHAO.CELL (v34)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d50000">

    <style>
        :root { 
            --primary: #d50000;      
            --primary-dark: #b71c1c; 
            --accent: #000000;       
            --text: #212121;         
            --bg: #f5f5f5;           
            --card-bg: #ffffff;      
            --success: #2e7d32;      
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 85px; text-transform: uppercase; user-select: none; }
        
        /* HEADER */
        header { 
            background: linear-gradient(135deg, var(--accent) 30%, var(--primary) 100%); 
            color: white; padding: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            position: sticky; top: 0; z-index: 100; 
            display:flex; justify-content:space-between; align-items:center; 
            border-bottom: 3px solid var(--primary);
        }
        header h2 { font-size: 16px; font-weight: 900; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; font-style: italic; }
        .version { font-size: 9px; opacity: 0.8; font-weight: normal; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-style: normal; }

        .container { padding: 12px; max-width: 800px; margin: auto; }
        .page { display: none; animation: slideUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        /* CARDS */
        .card { background: var(--card-bg); padding: 18px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 15px; position: relative; border-left: 5px solid transparent; }
        .card:hover { border-left-color: var(--primary); transition: 0.3s; }
        
        h3 { 
            color: var(--accent); font-size: 14px; margin-bottom: 15px; 
            border-bottom: 2px solid #eee; padding-bottom: 8px; 
            display:flex; justify-content:space-between; align-items:center; font-weight: 800; 
        }

        /* BOTÃO NOVO */
        .btn-novo {
            background: var(--accent); color: white; border: none; 
            padding: 6px 16px; border-radius: 20px; font-size: 10px; font-weight: bold; 
            cursor: pointer; display: flex; align-items: center; gap: 5px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .btn-novo:active { transform: scale(0.95); background: var(--primary); }

        /* INPUTS & LABELS */
        label { font-size: 10px; font-weight: 800; color: #666; margin-top: 10px; display: block; letter-spacing: 0.5px; }
        input, textarea, select { 
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; 
            background: #fafafa; margin-top: 5px; font-size: 14px; outline: none; transition: 0.2s; font-weight: 600; color: #333;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        /* BUSCA COM LUPA */
        .search-box { position: relative; margin-top: 5px; }
        .search-box input { padding-right: 45px; margin-top: 0; }
        
        .search-btn { 
            position: absolute; right: 5px; top: 2px; bottom: 2px;
            background: var(--primary); color: white; border: none; width: 40px; 
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            z-index: 20;
        }
        .search-btn:active { background: var(--primary-dark); transform: scale(0.95); }
        
        .sugestoes { background: white; border-radius: 0 0 10px 10px; max-height: 250px; overflow-y: auto; position: absolute; top: 100%; width: 100%; z-index: 999; box-shadow: 0 10px 20px rgba(0,0,0,0.15); display: none; border: 1px solid #eee; }
        .sugestoes div.item-sug { padding: 12px; border-bottom: 1px solid #f1f1f1; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        .sugestoes div.item-sug:active { background: #f0f0f0; }
        .sug-header { background: #eee; color: #555; font-size: 10px; font-weight: 900; padding: 5px 12px; letter-spacing: 1px; }

        /* FOTOS OS */
        .os-foto-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; }
        .os-foto-slot {
            aspect-ratio: 1; background: #eee; border-radius: 8px; border: 2px dashed #ccc;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            overflow: hidden; position: relative;
        }
        .os-foto-slot img { width: 100%; height: 100%; object-fit: cover; }
        .os-foto-slot i { color: #999; font-size: 20px; }

        /* KANBAN */
        .kanban-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; align-items: start; }
        .k-col { background: #f0f0f0; padding: 5px; border-radius: 10px; min-height: 100px; }
        .k-head { font-size: 9px; font-weight: 900; text-align: center; margin-bottom: 8px; color: var(--accent); background: white; padding: 4px; border-radius: 6px; border: 1px solid #ddd; }
        
        .os-card { background: white; padding: 8px; border-radius: 8px; margin-bottom: 6px; border-top: 4px solid #ccc; font-size: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .os-card.pecas { border-top-color: var(--primary); } 
        .os-card.pgto { border-top-color: #ff9800; } 
        .os-card.retirado { border-top-color: var(--success); }
        
        .btn-mini { border: none; border-radius: 6px; padding: 4px; color: white; cursor: pointer; font-size: 9px; flex: 1; transition: 0.2s; display:flex; justify-content:center; align-items:center; }
        .btn-mini:active { transform: scale(0.9); }

        /* BOTÕES GERAIS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 15px; font-size: 13px; color: white; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); } 
        .btn-dark { background: var(--accent); } 
        .btn-info { background: #0288d1; }
        .btn-success { background: var(--success); }
        .btn-zap { background: #25D366; }
        .btn-add-mini { background: #2e7d32; color:white; border:none; border-radius:8px; width:44px; font-size:18px; cursor:pointer; margin-top:5px; }

        /* FOTOS E MODAL */
        .foto-preview { 
            width: 80px; height: 80px; border-radius: 50%; 
            background-color: #eee; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23999'%3E%3Cpath d='M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z'/%3E%3C/svg%3E");
            background-size: 40%; background-position: center; background-repeat: no-repeat;
            object-fit: cover; border: 3px solid var(--primary); margin: 10px auto; display: block; cursor: pointer; 
        }
        .foto-preview.has-img { background-image: none; }

        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; border: 2px solid var(--primary); }

        /* RANKING */
        .rank-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .rank-box { background: #fafafa; padding: 8px; border-radius: 10px; border: 1px solid #eee; }
        .rank-title { font-size: 10px; font-weight: 900; text-align: center; color: var(--primary); margin-bottom: 8px; border-bottom: 2px solid var(--primary); padding-bottom: 2px; }
        .rank-item { font-size: 9px; margin-bottom: 4px; display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }

        /* NAV */
        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 2px solid var(--primary); padding: 10px 0 25px 0; z-index: 900; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; border: none; background: none; color: #999; font-size: 9px; font-weight: bold; text-align: center; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { display: block; font-size: 22px; margin-bottom: 4px; color: var(--accent); }
        .nav-item.active i { color: var(--primary); }

        /* IMPRESSÃO (TÉRMICA 80MM) */
        @media print { 
            body * { visibility: hidden; } 
            #area-print, #area-print * { visibility: visible; }
            #area-print { 
                position: absolute; left: 0; top: 0; width: 100%; 
                font-family: 'Courier New', monospace; font-size: 12px; color: black; background: white;
                padding: 5px;
            } 
            .p-header { text-align: center; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
            .p-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
            .p-info { font-size: 10px; margin-bottom: 2px; }
            .p-line { border-bottom: 1px dashed #000; margin: 10px 0; }
            .p-table { width: 100%; text-align: left; font-size: 11px; }
            .p-table th { border-bottom: 1px solid #000; }
            .p-total { text-align: right; font-size: 16px; font-weight: bold; margin-top: 10px; }
            .p-sign { margin-top: 40px; text-align: center; border-top: 1px solid #000; padding-top: 5px; font-size: 10px; width: 80%; margin-left: auto; margin-right: auto; }
            .p-imgs { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 10px; }
            .p-imgs img { width: 45%; border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#d50000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;font-weight:bold;">
    <i class="fas fa-mobile-alt fa-3x" style="margin-bottom:15px"></i>
    <div>FILHAO.CELL</div>
</div>

<div id="area-print"></div>

<div id="modal-overlay" onclick="fecharModal(event)">
    <div class="modal-content">
        <h3 style="justify-content:center">AÇÕES</h3>
        <button class="btn" style="background:#25d366; margin-top:10px" onclick="acaoShare('zap')"><i class="fab fa-whatsapp"></i> WHATSAPP</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="acaoShare('print')"><i class="fas fa-print"></i> TÉRMICA 80MM</button>
        <button class="btn" style="background:#d32f2f; margin-top:10px" onclick="acaoShare('pdf')"><i class="fas fa-file-pdf"></i> PDF / A4</button>
    </div>
</div>

<header>
    <h2><i class="fas fa-fire"></i> FILHAO.CELL <span class="version">v34</span></h2>
    <div id="status-conn" style="font-size:10px"><i class="fas fa-wifi"></i></div>
</header>

<div class="container">

    <div id="page-vendas" class="page active">
        <div class="card">
            <h3><i class="fas fa-cash-register"></i> CAIXA</h3>
            
            <label>CLIENTE</label>
            <div class="search-box">
                <input type="text" id="v-cli" placeholder="BUSCAR CLIENTE..." onkeyup="buscar('clientes', this.value, 'sug-v-cli')">
                <button type="button" class="search-btn" onclick="buscar('clientes', document.getElementById('v-cli').value, 'sug-v-cli', false, true)"><i class="fas fa-search"></i></button>
                <div id="sug-v-cli" class="sugestoes"></div>
            </div>
            <button class="btn-novo" style="margin-top:10px" onclick="cadastrarNovoNaVenda()"><i class="fas fa-plus"></i> NOVO CLIENTE</button>

            <label style="margin-top:15px">ADICIONAR ITEM</label>
            <div class="search-box">
                <input type="text" id="v-busca" placeholder="BIPAR OU DIGITAR..." onkeyup="buscarVenda(this.value)">
                <button type="button" class="search-btn" onclick="buscarVenda(document.getElementById('v-busca').value, true)"><i class="fas fa-search"></i></button>
                <div id="sug-v-prod" class="sugestoes"></div>
            </div>

            <div style="background:#f9f9f9; border:2px dashed #e0e0e0; padding:15px; margin-top:20px; border-radius:12px">
                <div id="carrinho-lista" style="font-size:12px; color:#888; text-align:center; padding:10px">CARRINHO VAZIO</div>
                <div style="text-align:right; font-size:18px; font-weight:900; margin-top:15px; color:var(--primary); border-top:1px solid #ddd; padding-top:10px" id="v-total">TOTAL: R$ 0,00</div>
            </div>

            <div style="display:flex; gap:10px">
                <button class="btn btn-dark" style="flex:1" onclick="abrirShare('orcamento')"><i class="fas fa-share-alt"></i></button>
                <button class="btn btn-primary" style="flex:2" onclick="finalizarVenda()">FINALIZAR VENDA</button>
            </div>
        </div>
    </div>

    <div id="page-servicos" class="page">
        <div class="card">
            <h3>NOVA O.S. <button class="btn-novo" onclick="limparOS()"><i class="fas fa-file"></i> NOVA</button></h3>
            <input type="hidden" id="os-id">
            
            <label>CLIENTE</label>
            <div style="display:flex; gap:5px; align-items:flex-end">
                <div class="search-box" style="flex:1">
                    <input type="text" id="s-cli" placeholder="BUSCAR..." onkeyup="buscar('clientes', this.value, 'sug-s-cli')">
                    <button type="button" class="search-btn" onclick="buscar('clientes', document.getElementById('s-cli').value, 'sug-s-cli', false, true)"><i class="fas fa-search"></i></button>
                    <div id="sug-s-cli" class="sugestoes"></div>
                </div>
                <button class="btn-add-mini" onclick="cadastrarNovoNaOS()"><i class="fas fa-plus"></i></button>
            </div>
            
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>MODELO</label><input id="s-mod"></div>
                <div style="flex:1"><label>SENHA</label><input id="s-senha"></div>
            </div>
            
            <label>DEFEITO / OBS</label>
            <input id="s-def">
            
            <label>FOTOS DO APARELHO (MÁX 4)</label>
            <div class="os-foto-grid">
                <div class="os-foto-slot" onclick="addFotoOS(0)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(1)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(2)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(3)"><i class="fas fa-camera"></i></div>
            </div>
            <input type="file" id="os-foto-input" hidden onchange="processFotoOS(this)">

            <label>VALOR R$</label>
            <input type="number" id="s-valor">

            <button class="btn btn-primary" onclick="salvarOS()">SALVAR ORDEM</button>
        </div>

        <div class="kanban-grid">
            <div class="k-col">
                <div class="k-head" style="color:#555">ANÁLISE</div>
                <div id="k-pecas"></div>
            </div>
            <div class="k-col">
                <div class="k-head" style="color:#ff9800; font-size:8px">AGUARDANDO PAGAMENTO</div>
                <div id="k-pgto"></div>
            </div>
            <div class="k-col">
                <div class="k-head" style="color:green">PRONTO</div>
                <div id="k-retirado"></div>
            </div>
        </div>
    </div>

    <div id="page-clientes" class="page">
        <div class="card" id="form-cli">
            <h3>CLIENTES <button class="btn-novo" onclick="limparCli()"><i class="fas fa-user-plus"></i> NOVO</button></h3>
            <input type="hidden" id="c-id">
            
            <img id="c-foto-view" src="" class="foto-preview" onclick="document.getElementById('c-foto').click()">
            <input type="file" id="c-foto" hidden onchange="lerFoto(this, 'c-foto-view')">

            <input type="text" id="c-nome" placeholder="NOME COMPLETO *">
            <input type="tel" id="c-tel" placeholder="WHATSAPP" oninput="maskTel(this)">
            <div style="display:flex; gap:10px">
                <input type="text" id="c-bairro" placeholder="BAIRRO">
                <input type="text" id="c-cidade" placeholder="CIDADE">
            </div>
            
            <button class="btn btn-primary" onclick="salvarCliente()">SALVAR CLIENTE</button>
        </div>
        <div class="card">
            <h3>MEUS CLIENTES</h3>
            <div class="search-box">
                <input type="text" id="cli-search-input" placeholder="FILTRAR LISTA..." onkeyup="buscar('clientes', this.value, 'lista-clientes', true)">
                <button type="button" class="search-btn" onclick="buscar('clientes', document.getElementById('cli-search-input').value, 'lista-clientes', true, true)"><i class="fas fa-search"></i></button>
            </div>
            <div id="lista-clientes" style="margin-top:15px"></div>
        </div>
    </div>

    <div id="page-estoque" class="page">
        <div class="card">
            <h3>ITEM DE ESTOQUE <button class="btn-novo" onclick="limparEstoque()"><i class="fas fa-plus"></i> NOVO</button></h3>
            <input type="hidden" id="p-id">
            
            <img id="p-foto-view" src="" class="foto-preview" onclick="document.getElementById('p-foto').click()">
            <input type="file" id="p-foto" hidden onchange="lerFoto(this, 'p-foto-view')">

            <input type="text" id="p-nome" placeholder="DESCRIÇÃO *">
            <div style="display:flex; gap:10px">
                <input type="number" id="p-venda" placeholder="R$ VENDA *">
                <input type="number" id="p-qtd" placeholder="QTD">
            </div>
            
            <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px">
                <div id="box-custo" style="display:none; background:#ffebee; padding:10px; border-radius:8px; border:1px solid #ffcdd2">
                    <label style="margin-top:0; color:#c62828">PREÇO DE CUSTO (ADM)</label>
                    <input type="number" id="p-custo" placeholder="0.00" style="border-color:#ffcdd2">
                </div>
                <button class="btn-novo" style="width:100%; justify-content:center; background:#444; margin-top:5px" onclick="toggleCusto()">VER CUSTO</button>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px">
                <button class="btn btn-primary" onclick="salvarProduto('prod')">SALVAR PRODUTO</button>
                <button class="btn btn-dark" onclick="salvarProduto('serv')">SALVAR SERVIÇO</button>
            </div>
        </div>
        
        <div class="card">
            <div style="display:flex; gap:5px; margin-bottom:10px">
                <button class="btn-mini btn-dark" onclick="listarEstoque('prod')">PRODUTOS</button>
                <button class="btn-mini btn-dark" style="opacity:0.7" onclick="listarEstoque('serv')">SERVIÇOS</button>
            </div>
            <div id="lista-estoque"></div>
        </div>
    </div>

    <div id="page-relatorio" class="page">
        <div class="card">
            <h3>RELATÓRIOS FINANCEIROS</h3>
            <select id="r-filtro" onchange="renderRelatorio()" style="margin-bottom:15px">
                <option value="dia">HOJE</option>
                <option value="semana">ÚLTIMOS 7 DIAS</option>
                <option value="mes">MÊS ATUAL</option>
                <option value="ano">ESTE ANO</option>
            </select>
            
            <div style="background:var(--accent); color:white; padding:20px; border-radius:12px; text-align:center">
                <div style="font-size:11px; opacity:0.8">FATURAMENTO TOTAL</div>
                <div id="r-total" style="font-size:24px; font-weight:900; margin-top:5px">R$ 0,00</div>
            </div>

            <h3 style="margin-top:25px; font-size:12px; color:#666">HISTÓRICO DETALHADO</h3>
            
            <div class="search-box" style="margin-bottom:10px">
                <input type="text" id="r-search" placeholder="BUSCAR NO HISTÓRICO..." onkeyup="buscar('clientes', this.value, 'sug-r-cli'); renderRelatorio()">
                <button class="search-btn" onclick="buscar('clientes', document.getElementById('r-search').value, 'sug-r-cli', false, true)"><i class="fas fa-search"></i></button>
                <div id="sug-r-cli" class="sugestoes"></div>
            </div>

            <div id="r-hist" style="max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:5px"></div>

            <h3 style="margin-top:20px; font-size:12px; color:#666">RANKINGS DE DESEMPENHO</h3>
            <div class="rank-grid">
                <div class="rank-box">
                    <div class="rank-title">CLIENTES</div>
                    <div id="rank-cli"></div>
                </div>
                <div class="rank-box">
                    <div class="rank-title">PRODUTOS</div>
                    <div id="rank-prod"></div>
                </div>
                <div class="rank-box">
                    <div class="rank-title">SERVIÇOS</div>
                    <div id="rank-serv"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<nav>
    <button class="nav-item active" onclick="nav('vendas', this)"><i class="fas fa-shopping-cart"></i>VENDAS</button>
    <button class="nav-item" onclick="nav('servicos', this)"><i class="fas fa-wrench"></i>OS</button>
    <button class="nav-item" onclick="nav('clientes', this)"><i class="fas fa-users"></i>CLIENTES</button>
    <button class="nav-item" onclick="nav('estoque', this)"><i class="fas fa-box"></i>ESTOQUE</button>
    <button class="nav-item" onclick="nav('relatorio', this)"><i class="fas fa-chart-line"></i>RELATÓRIOS</button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeGGqXV4LOB_ENZLkj_QHOIE5_OEp29s0",
      authDomain: "filhaocell-a528e.firebaseapp.com",
      projectId: "filhaocell-a528e",
      storageBucket: "filhaocell-a528e.firebasestorage.app",
      messagingSenderId: "69033828352",
      appId: "1:69033828352:web:a0ec6bcbf797622e6838e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const SENHA = "000800"; // Senha ADM
    
    const EMPRESA = {
        nome: "FILHAO.CELL",
        cnpj: "31.926.078/0001-65",
        tel: "(81) 9 9507-4007",
        end: "Rua Jose Medeiros Rego, 09, Centro",
        cid: "Surubim - PE",
        email: "filhao.cell@gmail.com"
    };

    window.db = { clientes:[], produtos:[], servicos:[], os:[], logs:[] };
    window.carrinho = [];
    window.shareData = null;
    window.tempImg = null;
    window.retornoVenda = false;
    window.retornoOS = false;
    window.osFotos = [null, null, null, null];
    window.currentFotoIndex = 0;

    // --- CARREGAMENTO ---
    onSnapshot(collection(db, "clientes"), s => { window.db.clientes = s.docs.map(d=>({id:d.id, ...d.data()})); if(isPg('clientes')) listarCli(); });
    onSnapshot(collection(db, "produtos"), s => { window.db.produtos = s.docs.map(d=>({id:d.id, ...d.data()})); });
    onSnapshot(collection(db, "servicos_cad"), s => { window.db.servicos = s.docs.map(d=>({id:d.id, ...d.data()})); });
    onSnapshot(query(collection(db, "os_ativa"), orderBy("data", "desc")), s => { window.db.os = s.docs.map(d=>({id:d.id, ...d.data()})); renderKanban(); document.getElementById('loading').style.display='none'; });
    
    onSnapshot(query(collection(db, "logs"), orderBy("data", "desc")), s => { 
        window.db.logs = s.docs.map(d=>({id:d.id, ...d.data()})); 
        if(isPg('relatorio')) renderRelatorio();
    });

    function isPg(p){ return document.getElementById('page-'+p).classList.contains('active'); }

    // --- NAV ---
    window.nav = function(p, el) {
        if(p === 'relatorio') {
            if(prompt("SENHA ADM:") !== SENHA) return;
        }
        document.querySelectorAll('.page').forEach(d=>d.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(d=>d.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        if(el) el.classList.add('active');
        if(p==='clientes') listarCli();
        if(p==='estoque') listarEstoque('prod');
        if(p==='relatorio') renderRelatorio();
    }

    // --- BUSCAS ---
    window.buscar = function(col, txt, divId, lista=false, force=false) {
        const box = document.getElementById(divId);
        if(!window.db[col]) return alert("AGUARDE CARREGAR O SISTEMA...");
        if(!txt && !force && !lista) { box.style.display='none'; return; }
        
        let res = window.db[col].filter(i => (i.nome||'').toUpperCase().includes((txt||'').toUpperCase())).slice(0,8);
        
        if(lista) {
            if(res.length === 0) {
                document.getElementById(divId).innerHTML = '<div style="text-align:center;padding:10px;color:#999">NENHUM REGISTRO</div>';
            } else {
                document.getElementById(divId).innerHTML = res.map(renderCliCard).join('');
            }
            return;
        }
        
        if(res.length) {
            box.innerHTML = res.map(i => `<div class="item-sug" onclick="sel('${col}','${i.id}','${divId}')">${i.nome}</div>`).join('');
            box.style.display='block';
        } else {
             box.innerHTML = '<div class="item-sug" style="color:#999">NENHUM REGISTRO</div>';
             box.style.display='block';
             setTimeout(() => box.style.display='none', 3000); 
        }
    }

    window.sel = function(c, id, div) {
        const item = window.db[c].find(i=>i.id===id);
        
        if(div === 'sug-r-cli') {
            document.getElementById('r-search').value = item.nome;
            document.getElementById(div).style.display='none';
            renderRelatorio();
            return;
        }

        const inp = div.includes('v-') ? 'v-cli' : 's-cli';
        document.getElementById(inp).value = item.nome;
        document.getElementById(div).style.display='none';
    }

    // --- VENDAS ---
    window.buscarVenda = function(txt, force=false) {
        const box = document.getElementById('sug-v-prod');
        if(!txt && !force) { box.style.display='none'; return; }
        
        const prods = window.db.produtos.filter(i => (i.nome||'').toUpperCase().includes((txt||'').toUpperCase())).slice(0,5);
        const servs = window.db.servicos.filter(i => (i.nome||'').toUpperCase().includes((txt||'').toUpperCase())).slice(0,5);
        
        let html = '';
        if(prods.length > 0) {
            html += `<div class="sug-header">PRODUTOS ESTOQUE</div>`;
            html += prods.map(i => `<div class="item-sug" onclick="addCar('${i.id}','P','${i.nome}',${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');
        }
        if(servs.length > 0) {
            html += `<div class="sug-header" style="border-top:2px solid #ddd">SERVIÇOS</div>`;
            html += servs.map(i => `<div class="item-sug" onclick="addCar('${i.id}','S','${i.nome}',${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');
        }

        if(html === '') {
             box.innerHTML = '<div class="item-sug" style="color:#999">NENHUM ITEM</div>';
             box.style.display = 'block';
             setTimeout(() => box.style.display='none', 2000);
        } else {
            box.innerHTML = html;
            box.style.display = 'block';
        }
    }

    window.addCar = function(id, tipo, nome, val) {
        window.carrinho.push({ id, tipo, nome, val });
        renderCarrinho();
        document.getElementById('v-busca').value = '';
        document.getElementById('sug-v-prod').style.display='none';
        document.getElementById('v-busca').focus();
    }

    window.renderCarrinho = function() {
        const l = document.getElementById('carrinho-lista');
        if(!window.carrinho.length) { l.innerHTML = 'CARRINHO VAZIO'; document.getElementById('v-total').innerText='R$ 0,00'; return; }
        let t = 0;
        l.innerHTML = window.carrinho.map((i,x) => {
            t += i.val;
            return `<div style="display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #eee"><span>${i.nome}</span><span>R$ ${i.val} <i class="fas fa-trash" style="color:red;cursor:pointer;margin-left:5px" onclick="delCar(${x})"></i></span></div>`;
        }).join('');
        document.getElementById('v-total').innerText = 'TOTAL: R$ ' + t.toFixed(2);
    }
    
    window.delCar = function(i) { window.carrinho.splice(i,1); renderCarrinho(); }
    window.cadastrarNovoNaVenda = function() { window.retornoVenda=true; window.nav('clientes'); }
    window.cadastrarNovoNaOS = function() { window.retornoOS=true; window.nav('clientes'); }

    window.finalizarVenda = async function() {
        if(!window.carrinho.length) return alert("VAZIO");
        const cli = document.getElementById('v-cli').value || "CONSUMIDOR";
        for(let i of window.carrinho) {
            await addDoc(collection(db,"logs"), {tipo:i.tipo=='P'?'PRODUTO':'SERVICO', desc:i.nome, valor:i.val, cliente:cli, data:new Date().toISOString()});
        }
        window.shareData = {tipo:'VENDA', cliente:cli, itens:window.carrinho, total:window.carrinho.reduce((a,b)=>a+b.val,0)};
        window.carrinho=[]; renderCarrinho(); document.getElementById('v-cli').value='';
        abrirModalShare();
    }

    // --- OS ---
    
    window.addFotoOS = function(idx) {
        window.currentFotoIndex = idx;
        document.getElementById('os-foto-input').click();
    }
    window.processFotoOS = function(inp) {
        if(inp.files && inp.files[0]) {
             const r = new FileReader();
             r.onload = e => {
                 const i = new Image(); i.src = e.target.result;
                 i.onload = () => {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    let w=i.width, h=i.height; if(w>h){if(w>400){h*=400/w;w=400}}else{if(h>400){w*=400/h;h=400}};
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    const b64 = c.toDataURL('image/jpeg', 0.6);
                    window.osFotos[window.currentFotoIndex] = b64;
                    renderFotosOS();
                 }
             }
             r.readAsDataURL(inp.files[0]);
        }
    }
    function renderFotosOS() {
        const slots = document.querySelectorAll('.os-foto-slot');
        window.osFotos.forEach((f, i) => {
            if(f) slots[i].innerHTML = `<img src="${f}">`;
            else slots[i].innerHTML = `<i class="fas fa-camera"></i>`;
        });
    }

    window.salvarOS = async function() {
        const id = document.getElementById('os-id').value;
        const os = {
            cliente: document.getElementById('s-cli').value,
            modelo: document.getElementById('s-mod').value,
            defeito: document.getElementById('s-def').value,
            senha: document.getElementById('s-senha').value,
            valor: parseFloat(document.getElementById('s-valor').value||0),
            fotos: window.osFotos,
            status: 'pecas',
            data: new Date().toISOString()
        };
        if(id) await updateDoc(doc(db,"os_ativa",id), os);
        else await addDoc(collection(db,"os_ativa"), os);
        limparOS();
    }

    window.renderKanban = function() {
        const c = {pecas:'', pgto:'', retirado:''};
        const flow = ['pecas', 'pgto', 'retirado'];

        window.db.os.forEach(o => {
            const currentIdx = flow.indexOf(o.status);
            
            // Botões de Navegação (AGRUPADOS ESQUERDA)
            let navBtns = '';
            if(currentIdx > 0) navBtns += `<button class="btn-mini btn-dark" onclick="moveOS('${o.id}', -1)"><i class="fas fa-arrow-left"></i></button>`;
            if(currentIdx < 2) navBtns += `<button class="btn-mini btn-dark" onclick="moveOS('${o.id}', 1)"><i class="fas fa-arrow-right"></i></button>`;
            else navBtns += `<button class="btn-mini btn-primary" onclick="arqOS('${o.id}')"><i class="fas fa-archive"></i></button>`;

            c[o.status] += `
            <div class="os-card ${o.status}">
                <b>${o.cliente}</b>
                <div>${o.modelo}</div>
                <div style="font-weight:bold; color:var(--primary)">R$ ${o.valor}</div>
                
                <div style="display:flex; justify-content:space-between; margin-top:5px">
                   <div style="display:flex; gap:5px">
                      ${navBtns}
                   </div>
                   <div style="display:flex; gap:5px">
                      <button class="btn-mini btn-info" onclick="editOS('${o.id}')"><i class="fas fa-pen"></i></button>
                      <button class="btn-mini btn-success" onclick="shareOS('${o.id}')"><i class="fas fa-share-alt"></i></button>
                      <button class="btn-mini btn-dark" style="background:#c62828" onclick="delOS('${o.id}')"><i class="fas fa-trash"></i></button>
                   </div>
                </div>
            </div>`;
        });
        document.getElementById('k-pecas').innerHTML = c.pecas;
        document.getElementById('k-pgto').innerHTML = c.pgto;
        document.getElementById('k-retirado').innerHTML = c.retirado;
    }
    
    window.delOS = async function(id) {
        if(prompt("SENHA ADM:") !== SENHA) return;
        if(confirm("Deseja EXCLUIR permanentemente esta OS?")) {
            await deleteDoc(doc(db, "os_ativa", id));
        }
    }
    
    window.moveOS = async function(id, dir) {
        const flow = ['pecas', 'pgto', 'retirado'];
        const o = window.db.os.find(i=>i.id===id);
        const currentIdx = flow.indexOf(o.status);
        const nextIdx = currentIdx + dir;
        if(nextIdx >= 0 && nextIdx < flow.length) {
            await updateDoc(doc(db,"os_ativa",id), {status: flow[nextIdx]});
        }
    }

    window.arqOS = async function(id) {
        if(!confirm("Arquivar?")) return;
        const o = window.db.os.find(i=>i.id===id);
        await addDoc(collection(db,"logs"), {tipo:'SERVICO', desc:'OS: '+o.modelo, valor:o.valor, cliente:o.cliente, data:new Date().toISOString()});
        await deleteDoc(doc(db,"os_ativa",id));
    }
    
    window.editOS = function(id) {
        const o = window.db.os.find(i=>i.id===id);
        document.getElementById('os-id').value=id; 
        document.getElementById('s-cli').value=o.cliente;
        document.getElementById('s-mod').value=o.modelo; 
        document.getElementById('s-valor').value=o.valor;
        
        let def = o.defeito;
        let sen = o.senha || '';
        if(!sen && def && def.includes(' | S: ')) {
            const parts = def.split(' | S: '); def = parts[0]; sen = parts[1];
        }
        document.getElementById('s-def').value=def;
        document.getElementById('s-senha').value=sen;
        window.osFotos = o.fotos || [null, null, null, null];
        renderFotosOS();
    }
    
    window.shareOS = function(id) {
        const o = window.db.os.find(i=>i.id===id);
        let obsTexto = o.defeito;
        let senhaTexto = o.senha || '';
        if(!senhaTexto && obsTexto && obsTexto.includes(' | S: ')) {
             const p = obsTexto.split(' | S: '); obsTexto = p[0]; senhaTexto = p[1];
        }

        window.shareData={
            tipo:'OS', 
            cliente:o.cliente, 
            itens:[{nome:o.modelo, val:o.valor}], 
            total:o.valor,
            obs: obsTexto,
            senha: senhaTexto,
            fotos: o.fotos || []
        };
        abrirModalShare();
    }

    // --- CLIENTE/ESTOQUE ---
    window.salvarCliente = async function() {
        const id = document.getElementById('c-id').value;
        const d = { nome: document.getElementById('c-nome').value, tel: document.getElementById('c-tel').value, bairro: document.getElementById('c-bairro').value, cidade: document.getElementById('c-cidade').value, foto: window.tempImg||'' };
        if(id) await updateDoc(doc(db,"clientes",id), d);
        else await addDoc(collection(db,"clientes"), d);
        limparCli();
        if(window.retornoVenda) { window.retornoVenda=false; window.nav('vendas'); document.getElementById('v-cli').value=d.nome; }
        if(window.retornoOS) { window.retornoOS=false; window.nav('servicos'); document.getElementById('s-cli').value=d.nome; }
    }
    window.listarCli = function() { document.getElementById('lista-clientes').innerHTML = window.db.clientes.map(renderCliCard).join(''); }
    
    function renderCliCard(c) {
        const zapLink = c.tel ? `https://wa.me/55${c.tel.replace(/\D/g,'')}` : '#';
        return `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center">
            <div style="display:flex; gap:10px; align-items:center">
                ${c.foto?`<img src="${c.foto}" style="width:40px;height:40px;border-radius:50%">`:`<div style="width:40px;height:40px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center"><i class="fas fa-user"></i></div>`}
                <div>
                    <b>${c.nome}</b><br>
                    <span style="font-size:11px">${c.tel}</span>
                    <div style="font-size:9px; color:#666; font-weight:bold">${c.bairro||''} ${c.cidade?'- '+c.cidade:''}</div>
                </div>
            </div>
            <div style="display:flex; gap:5px">
                ${c.tel ? `<a href="${zapLink}" target="_blank" class="btn-mini btn-zap" style="width:25px; text-decoration:none"><i class="fab fa-whatsapp"></i></a>` : ''}
                <button class="btn-mini btn-info" onclick="edtCli('${c.id}')"><i class="fas fa-pen"></i></button> 
                <button class="btn-mini btn-dark" onclick="del('clientes','${c.id}')"><i class="fas fa-trash"></i></button>
            </div>
        </div>`;
    }
    
    window.edtCli = function(id) {
        const c = window.db.clientes.find(i=>i.id===id);
        document.getElementById('c-id').value=id; document.getElementById('c-nome').value=c.nome; document.getElementById('c-tel').value=c.tel;
        document.getElementById('c-bairro').value=c.bairro||''; document.getElementById('c-cidade').value=c.cidade||'';
        window.tempImg=c.foto; 
        const view = document.getElementById('c-foto-view');
        view.src=c.foto||''; 
        if(c.foto) view.classList.add('has-img'); else view.classList.remove('has-img');
        document.getElementById('form-cli').scrollIntoView();
    }

    window.salvarProduto = async function(t) {
        const col = t==='prod'?'produtos':'servicos_cad';
        const d = { nome: document.getElementById('p-nome').value, precoVenda: parseFloat(document.getElementById('p-venda').value||0), qtd: document.getElementById('p-qtd').value, custo: document.getElementById('p-custo').value, foto: window.tempImg||'' };
        const id = document.getElementById('p-id').value;
        if(id) await updateDoc(doc(db,col,id), d); else await addDoc(collection(db,col), d);
        limparEstoque();
    }
    window.listarEstoque = function(t) {
        const l = t==='prod'?window.db.produtos:window.db.servicos; const col=t==='prod'?'produtos':'servicos_cad';
        document.getElementById('lista-estoque').innerHTML = l.map(i => `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center"><div style="display:flex;gap:10px;align-items:center">${i.foto?`<img src="${i.foto}" style="width:40px;height:40px;border-radius:50%">`:`<div style="width:40px;height:40px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center"><i class="fas fa-box"></i></div>`}<div><b>${i.nome}</b><br>R$ ${i.precoVenda}</div></div><div><button class="btn-mini btn-info" onclick="edtProd('${col}','${i.id}')"><i class="fas fa-pen"></i></button> <button class="btn-mini btn-dark" onclick="del('${col}','${i.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('');
    }
    window.edtProd = function(col, id) {
        const i = (col=='produtos'?window.db.produtos:window.db.servicos).find(x=>x.id===id);
        document.getElementById('p-id').value=id; document.getElementById('p-nome').value=i.nome; document.getElementById('p-venda').value=i.precoVenda; document.getElementById('p-qtd').value=i.qtd||''; document.getElementById('p-custo').value=i.custo||'';
        window.tempImg=i.foto; 
        const view = document.getElementById('p-foto-view');
        view.src=i.foto||'';
        if(i.foto) view.classList.add('has-img'); else view.classList.remove('has-img');
        document.getElementById('page-estoque').querySelector('.card').scrollIntoView();
    }
    
    // --- RELATÓRIOS ---
    window.renderRelatorio = function() {
        const f = document.getElementById('r-filtro').value; const now = new Date();
        const searchTxt = document.getElementById('r-search').value.toUpperCase(); 
        
        const logs = window.db.logs.filter(l => {
            const d = new Date(l.data);
            
            // Filtro de Data
            let matchDate = false;
            if(f=='dia') matchDate = d.toDateString()===now.toDateString();
            else if(f=='semana') matchDate = (now-d) < 604800000;
            else if(f=='mes') matchDate = d.getMonth()===now.getMonth();
            else matchDate = d.getFullYear()===now.getFullYear();
            
            // Filtro de Texto
            let matchText = true;
            if(searchTxt) {
                matchText = (l.cliente && l.cliente.toUpperCase().includes(searchTxt)) || 
                            (l.desc && l.desc.toUpperCase().includes(searchTxt));
            }

            return matchDate && matchText;
        });

        let t = 0;
        document.getElementById('r-hist').innerHTML = logs.map(l => {
            t+=l.valor;
            return `<div style="padding:8px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center">
                <div style="font-size:10px"><b>${l.desc}</b><br>${l.cliente}</div>
                <div style="text-align:right">
                    <b style="color:var(--primary)">R$ ${l.valor.toFixed(2)}</b><br>
                    <i class="fas fa-share-alt" style="color:#555; cursor:pointer; margin-right:5px" onclick="shareLog('${l.id}')"></i>
                    <i class="fas fa-pen" style="color:blue; cursor:pointer; margin-right:5px" onclick="editLog('${l.id}')"></i>
                    <i class="fas fa-trash" style="color:red; cursor:pointer" onclick="del('logs','${l.id}')"></i>
                </div>
            </div>`;
        }).join('');
        document.getElementById('r-total').innerText = "R$ " + t.toFixed(2);
        
        // Ranking
        const rank = (k, d) => {
            const c={}; window.db.logs.forEach(i => { if((k=='CLI' || (k=='PROD' && i.tipo=='PRODUTO') || (k=='SERV' && i.tipo!='PRODUTO'))) { const n = k=='CLI'?i.cliente:i.desc; c[n]=(c[n]||0)+1; } });
            document.getElementById(d).innerHTML = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`<div class="rank-item"><span>${x[0]}</span><b>${x[1]}</b></div>`).join('');
        }
        rank('CLI','rank-cli'); rank('PROD','rank-prod'); rank('SERV','rank-serv');
    }

    // --- FUNÇÕES EXTRAS ---
    window.del = async function(c, id) { 
        if(c === 'logs') {
            if(!confirm("Tem certeza que deseja apagar?")) return;
            await deleteDoc(doc(db,c,id));
            return;
        }
        if(prompt("SENHA ADM:")===SENHA) await deleteDoc(doc(db,c,id)); 
    }

    window.toggleCusto = function() { if(prompt("SENHA ADM:")===SENHA) document.getElementById('box-custo').style.display='block'; }
    
    window.editLog = async function(id) {
        const l = window.db.logs.find(i=>i.id===id);
        const novoVal = prompt("NOVO VALOR:", l.valor);
        const novaDesc = prompt("NOVA DESCRIÇÃO:", l.desc);
        if(novoVal && novaDesc) await updateDoc(doc(db,"logs",id), { valor: parseFloat(novoVal), desc: novaDesc });
    }

    // --- SHARE E IMPRESSÃO ---
    window.shareLog = function(id) {
        const l = window.db.logs.find(i=>i.id===id);
        window.shareData = { tipo: 'HISTORICO', cliente: l.cliente, itens: [{nome:l.desc, val:l.valor}], total: l.valor };
        abrirModalShare();
    }

    window.abrirModalShare = function(m) {
        if(m=='orcamento' && window.carrinho.length) {
            window.shareData = { tipo: 'ORCAMENTO', cliente: document.getElementById('v-cli').value, itens: window.carrinho, total: window.carrinho.reduce((a,b)=>a+b.val,0) };
            abrirModalShare();
        }
    }
    window.abrirModalShare = function() { document.getElementById('modal-overlay').style.display='flex'; }
    window.fecharModal = function(e) { if(e.target.id=='modal-overlay') document.getElementById('modal-overlay').style.display='none'; }
    
    // --- IMPRESSÃO COM FOTOS ---
    window.acaoShare = function(tipo) {
        const d = window.shareData;
        let txt = `*${EMPRESA.nome} - ${d.tipo}*\nCLI: ${d.cliente||'Consumidor'}\n----------------\n` + d.itens.map(i=>`${i.nome} R$ ${i.val}`).join('\n');
        
        if(d.obs) txt += `\nOBS: ${d.obs}`;
        if(d.senha) txt += `\nSENHA: ${d.senha}`;
        
        txt += `\n----------------\n*TOTAL: R$ ${d.total.toFixed(2)}*`;
        
        if(tipo=='zap') window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
        
        if(tipo=='print' || tipo=='pdf') {
            let htmlPrint = `
            <div class="p-header">
                <div class="p-title">${EMPRESA.nome}</div>
                <div class="p-info">${EMPRESA.end}</div>
                <div class="p-info">${EMPRESA.cid}</div>
                <div class="p-info">CNPJ: ${EMPRESA.cnpj}</div>
                <div class="p-info">Tel: ${EMPRESA.tel}</div>
                <div class="p-info">${EMPRESA.email}</div>
            </div>
            
            <div style="text-align:center; margin-bottom:10px">
                <b>${d.tipo}</b><br>
                ${new Date().toLocaleString()}
            </div>
            
            <div style="margin-bottom:10px; font-weight:bold">
                CLIENTE: ${d.cliente || 'CONSUMIDOR'}
            </div>

            <table class="p-table">
                <thead><tr><th>ITEM</th><th style="text-align:right">R$</th></tr></thead>
                <tbody>
                    ${d.itens.map(i => `<tr><td>${i.nome}</td><td style="text-align:right">${i.val.toFixed(2)}</td></tr>`).join('')}
                </tbody>
            </table>`;
            
            if(d.obs || d.senha) {
                htmlPrint += `<div class="p-line"></div><div style="text-align:left; font-size:11px">`;
                if(d.obs) htmlPrint += `<b>OBS:</b> ${d.obs}<br>`;
                if(d.senha) htmlPrint += `<b>SENHA:</b> ${d.senha}<br>`;
                htmlPrint += `</div>`;
            }

            htmlPrint += `<div class="p-total">TOTAL: R$ ${d.total.toFixed(2)}</div>`;
            
            if(d.fotos && d.fotos.some(f=>f)) {
                htmlPrint += `<div class="p-imgs">`;
                d.fotos.forEach(f => {
                    if(f) htmlPrint += `<img src="${f}">`;
                });
                htmlPrint += `</div>`;
            }

            htmlPrint += `
            <div class="p-sign">
                ASSINATURA DO CLIENTE
            </div>
            <div style="text-align:center; margin-top:15px; font-size:9px">OBRIGADO PELA PREFERÊNCIA!</div>
            `;
            
            document.getElementById('area-print').innerHTML = htmlPrint;
            window.print();
        }
        document.getElementById('modal-overlay').style.display='none';
    }

    // --- UTIL ---
    window.limparOS = function() { 
        document.querySelectorAll('#page-servicos input').forEach(i=>i.value=''); 
        document.getElementById('os-id').value=''; 
        window.osFotos = [null, null, null, null];
        renderFotosOS();
    }
    window.limparCli = function() { document.querySelectorAll('#page-clientes input').forEach(i=>i.value=''); window.tempImg=null; 
        const v = document.getElementById('c-foto-view'); v.src=''; v.classList.remove('has-img'); document.getElementById('c-id').value=''; }
    window.limparEstoque = function() { document.querySelectorAll('#page-estoque input').forEach(i=>i.value=''); window.tempImg=null; 
        const v = document.getElementById('p-foto-view'); v.src=''; v.classList.remove('has-img'); document.getElementById('box-custo').style.display='none'; document.getElementById('p-id').value=''; }
    window.maskTel = function(v){ v.value=v.value.replace(/\D/g,"").replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d)(\d{4})$/,"$1-$2"); }
    window.lerFoto = function(inp, vId) { 
        if(inp.files && inp.files[0]) { 
            const r = new FileReader(); 
            r.onload = e => { 
                const i = new Image(); i.src=e.target.result; 
                i.onload = () => { 
                    const c = document.createElement('canvas'); const x = c.getContext('2d'); 
                    let w=i.width, h=i.height; if(w>h){if(w>300){h*=300/w;w=300}}else{if(h>300){w*=300/h;h=300}}; 
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h); 
                    window.tempImg = c.toDataURL('image/jpeg',0.6); 
                    const view = document.getElementById(vId);
                    view.src=window.tempImg; 
                    view.classList.add('has-img');
                } 
            }; 
            r.readAsDataURL(inp.files[0]); 
        } 
    }
</script>
</body>
</html>
