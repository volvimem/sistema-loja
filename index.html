<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FILHÃO.CELL (ONLINE)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003399">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <style>
        :root { --primary: #003399; --accent: #ffcc00; --success: #25d366; --bg: #f4f7fe; --warning: #ffbb33; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; }
        body { background: var(--bg); color: #333; padding-bottom: 90px; }

        header { background: var(--primary); color: white; padding: 15px; text-align: center; border-bottom: 5px solid var(--accent); }
        .container { padding: 5px; max-width: 600px; margin: auto; }

        .page { display: none; }
        .page.active { display: block; }

        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h3 { color: var(--primary); font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        label { font-size: 10px; font-weight: bold; color: #666; display: block; margin-top: 8px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px; font-size: 14px; outline: none; background: #fff; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { width: auto; padding: 5px 10px; font-size: 10px; margin: 0; }
        .btn-del { background: #ff4444; color: white; border: none; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .item-lista { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .item-info { flex: 1; margin-left: 10px; font-size: 11px; }

        .kanban-container { display: flex; gap: 4px; padding-bottom: 10px; }
        .kanban-col { flex: 1; background: #eef2f9; padding: 4px; border-radius: 6px; min-width: 0; }
        .k-title { font-size: 9px; font-weight: bold; margin-bottom: 5px; text-align: center; color: #555; white-space: nowrap; overflow: hidden; }
        .os-card { background: white; padding: 6px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid #ccc; font-size: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .os-card b { display: block; margin-bottom: 2px; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .os-card.pecas { border-left-color: #003399; }
        .os-card.pgto { border-left-color: #ffcc00; }
        .os-card.retirado { border-left-color: #25d366; }

        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary); }

        .foto-circulo { width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 5px auto; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--primary); cursor: pointer; }
        .foto-circulo img { width: 100%; height: 100%; object-fit: cover; }
        .foto-quadrada { width: 100%; height: 120px; background: #eee; border-radius: 10px; margin-top: 5px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; }
        .foto-quadrada img { width: 100%; height: 100%; object-fit: cover; }

        .search-box { position: relative; }
        .sugestoes { background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 150px; overflow-y: auto; position: absolute; width: 100%; z-index: 100; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .sugestoes div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 12px; }

        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; padding: 10px 0; z-index: 1000; }
        .nav-item { flex: 1; border: none; background: none; color: #aaa; font-size: 9px; font-weight: bold; text-align: center; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { display: block; font-size: 18px; margin-bottom: 3px; }
    </style>
</head>
<body>

<div id="loading"><i class="fas fa-spinner fa-spin"></i> CONECTANDO...</div>

<header>
    <h2>FILHÃO.CELL <span style="font-size:10px; opacity:0.6; font-weight:normal; vertical-align:middle">v13.0</span></h2>
</header>

<div class="container">

    <div id="page-servicos" class="page active">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h3><i class="fas fa-wrench"></i> NOVA O.S.</h3>
                <button class="btn btn-primary btn-sm" onclick="nav('cadastros')">+ CLIENTE</button>
            </div>
            <label>CLIENTE</label>
            <div class="search-box">
                <input type="text" id="s-cli" placeholder="BUSCAR..." onkeyup="buscar('clientes', this.value, 's-sug')">
                <div id="s-sug" class="sugestoes"></div>
            </div>
            <label>APARELHO / SENHA</label>
            <div style="display:flex; gap:10px"><input type="text" id="s-apa" placeholder="MODELO"><input type="text" id="s-pw" placeholder="SENHA"></div>
            <label>DEFEITO</label>
            <textarea id="s-def" rows="2"></textarea>
            <label>VALOR PREVISTO R$</label>
            <input type="number" id="s-valor" placeholder="0.00">
            <button class="btn btn-primary" onclick="criarOS()">ABRIR O.S.</button>
        </div>

        <h3 style="margin: 5px; color:#666; font-size:12px">ANDAMENTO DE O.S. (TEMPO REAL)</h3>
        <div class="kanban-container">
            <div class="kanban-col">
                <div class="k-title" style="color:#003399">ANÁLISE</div>
                <div id="col-pecas"></div>
            </div>
            <div class="kanban-col">
                <div class="k-title" style="color:#e6b800">AGUARD. PGTO</div>
                <div id="col-pgto"></div>
            </div>
            <div class="kanban-col">
                <div class="k-title" style="color:#009933">RETIRADO</div>
                <div id="col-retirado"></div>
            </div>
        </div>
    </div>

    <div id="page-vendas" class="page">
        <div class="card">
            <h3><i class="fas fa-shopping-cart"></i> CAIXA</h3>
            <label>CLIENTE</label>
            <div style="display:flex; gap:5px; align-items: flex-start;">
                <div class="search-box" style="flex:1">
                    <input type="text" id="v-cli" placeholder="BUSCAR..." onkeyup="buscar('clientes', this.value, 'v-sug-c')">
                    <div id="v-sug-c" class="sugestoes"></div>
                </div>
                <button class="btn btn-primary btn-sm" style="margin-top:4px; height:38px" onclick="nav('cadastros')"><i class="fas fa-plus"></i></button>
            </div>

            <label style="margin-top:15px; color:var(--primary)">BUSCAR PRODUTO</label>
            <div style="display:flex; gap:5px; align-items: flex-start;">
                <div class="search-box" style="flex:1">
                    <input type="text" id="v-busca-prod" placeholder="DIGITE O PRODUTO..." onkeyup="buscarVenda('produto', this.value)">
                    <div id="v-sug-prod" class="sugestoes"></div>
                </div>
                <button class="btn btn-primary btn-sm" style="margin-top:4px; height:38px" onclick="nav('cadastros')"><i class="fas fa-plus"></i></button>
            </div>

            <label style="margin-top:15px; color:#666">BUSCAR SERVIÇO</label>
            <div style="display:flex; gap:5px; align-items: flex-start;">
                <div class="search-box" style="flex:1">
                    <input type="text" id="v-busca-serv" placeholder="DIGITE O SERVIÇO..." onkeyup="buscarVenda('servico', this.value)">
                    <div id="v-sug-serv" class="sugestoes"></div>
                </div>
                <button class="btn btn-primary btn-sm" style="margin-top:4px; height:38px" style="background:#666" onclick="nav('cadastros')"><i class="fas fa-plus"></i></button>
            </div>

            <hr style="margin:15px 0; border-top:1px dashed #ccc">
            <label>ITEM SELECIONADO</label>
            <input type="text" id="v-desc" placeholder="..." readonly style="background:#eee; font-weight:bold">
            <label>VALOR R$</label>
            <input type="number" id="v-val">
            <button class="btn btn-success" onclick="finalizarVenda()">CONCLUIR VENDA</button>
        </div>
    </div>

    <div id="page-cadastros" class="page">
        <div class="card" style="border: 2px solid var(--accent)">
            <h3><i class="fas fa-database"></i> GERENCIAR DADOS</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px">
                <button class="btn-sm btn-primary" style="flex:1" onclick="listar('clientes')">CLIENTES</button>
                <button class="btn-sm btn-primary" style="flex:1" onclick="listar('produtos')">PRODUTOS</button>
                <button class="btn-sm btn-primary" style="flex:1" onclick="listar('servicos')">SERVIÇOS</button>
            </div>
            <div id="lista-bd" style="max-height: 250px; overflow-y: auto; background:#f9f9f9; border-radius:8px; padding:5px;">
                <div style="text-align:center; color:#999; padding:10px; font-size:11px">SELECIONE UMA OPÇÃO</div>
            </div>
        </div>

        <div class="card">
            <h3>NOVO CLIENTE</h3>
            <div class="foto-circulo" onclick="document.getElementById('f-cli').click()">
                <img id="p-cli" style="display:none"><i class="fas fa-user" id="i-cli"></i>
            </div>
            <input type="file" id="f-cli" hidden accept="image/*" onchange="resizeAndRead(this, 'p-cli', 'i-cli')">
            <input type="text" id="c-nome" placeholder="NOME COMPLETO">
            <input type="text" id="c-tel" placeholder="WHATSAPP">
            <button class="btn btn-primary" onclick="salvar('cliente')">CADASTRAR CLIENTE</button>
        </div>
        
        <div class="card">
            <h3>NOVO PRODUTO</h3>
            <div class="foto-quadrada" onclick="document.getElementById('f-prod-cad').click()">
                <img id="p-prod-cad" style="display:none"><i class="fas fa-box" id="i-prod-cad"></i>
            </div>
            <input type="file" id="f-prod-cad" hidden accept="image/*" onchange="resizeAndRead(this, 'p-prod-cad', 'i-prod-cad')">
            <input type="text" id="p-nome" placeholder="NOME PRODUTO">
            <div style="display:flex; gap:10px">
                <input type="number" id="p-custo" placeholder="CUSTO">
                <input type="number" id="p-venda" placeholder="VENDA">
            </div>
            <button class="btn btn-primary" onclick="salvar('produto')">SALVAR PRODUTO</button>
        </div>

        <div class="card">
            <h3>NOVO SERVIÇO</h3>
            <input type="text" id="serv-nome" placeholder="NOME (EX: FORMATAÇÃO)">
            <input type="number" id="serv-venda" placeholder="VALOR PADRÃO">
            <button class="btn btn-primary" style="background:#666" onclick="salvar('servico')">CADASTRAR SERVIÇO</button>
        </div>
    </div>

    <div id="page-relatorio" class="page">
        <div class="card">
            <h3 style="color:red"><i class="fas fa-lock"></i> FINANCEIRO ADM</h3>
            <div style="display:flex; justify-content:space-between; align-items:center">
                <select id="f-data" onchange="renderHist()">
                    <option value="hoje">HOJE</option>
                    <option value="semana">SEMANA</option>
                    <option value="mes">MÊS</option>
                    <option value="ano">ANO ATUAL</option>
                </select>
            </div>
            <div id="hist-render" style="margin-top:10px; font-size:11px"></div>
            <div id="fin-adm" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px; font-weight:bold; color:green;"></div>
        </div>
    </div>

</div>

<nav>
    <button class="nav-item active" onclick="nav('servicos', this)"><i class="fas fa-wrench"></i>SERVIÇOS</button>
    <button class="nav-item" onclick="nav('vendas', this)"><i class="fas fa-shopping-cart"></i>VENDAS</button>
    <button class="nav-item" onclick="nav('cadastros', this)"><i class="fas fa-plus-circle"></i>CADASTROS</button>
    <button class="nav-item" onclick="nav('relatorio', this)"><i class="fas fa-chart-line"></i>RELATÓRIO</button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeGGqXV4LOB_ENZLkj_QHOIE5_OEp29s0",
      authDomain: "filhaocell-a528e.firebaseapp.com",
      projectId: "filhaocell-a528e",
      storageBucket: "filhaocell-a528e.firebasestorage.app",
      messagingSenderId: "69033828352",
      appId: "1:69033828352:web:a0ec6bcbf797622e6838e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.dbLocal = { clientes: [], produtos: [], servicosCadastrados: [], activeOS: [], logs: [] };
    const SENHA_ADM = "000800";
    window.tipoVendaAtual = 'produto';

    const load = document.getElementById('loading');

    onSnapshot(collection(db, "clientes"), (snap) => {
        window.dbLocal.clientes = snap.docs.map(d => ({id: d.id, ...d.data()}));
        if(document.getElementById('lista-bd').innerHTML.includes('CLIENTES')) window.listar('clientes');
    });

    onSnapshot(collection(db, "produtos"), (snap) => {
        window.dbLocal.produtos = snap.docs.map(d => ({id: d.id, ...d.data()}));
        if(document.getElementById('lista-bd').innerHTML.includes('PRODUTOS')) window.listar('produtos');
    });

    onSnapshot(collection(db, "servicos_cad"), (snap) => {
        window.dbLocal.servicosCadastrados = snap.docs.map(d => ({id: d.id, ...d.data()}));
        if(document.getElementById('lista-bd').innerHTML.includes('SERVIÇOS')) window.listar('servicos');
    });

    const qOS = query(collection(db, "os_ativa"), orderBy("dataEntrada", "desc"));
    onSnapshot(qOS, (snap) => {
        window.dbLocal.activeOS = snap.docs.map(d => ({id: d.id, ...d.data()}));
        window.renderKanban();
        load.style.display = 'none';
    });

    const qLogs = query(collection(db, "logs"), orderBy("data", "desc"));
    onSnapshot(qLogs, (snap) => {
        window.dbLocal.logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
        if(document.getElementById('page-relatorio').classList.contains('active')) window.renderHist();
    });

    window.nav = function(p, b) {
        if(p === 'relatorio') {
            const pass = prompt("DIGITE A SENHA DO ADMINISTRADOR:");
            if(pass !== SENHA_ADM) { alert("ACESSO NEGADO!"); return; }
        }
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(bt => bt.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        if(!b) b = document.querySelector(`.nav-item[onclick*="${p}"]`);
        if(b) b.classList.add('active');
        
        if(p === 'servicos') window.renderKanban();
        if(p === 'relatorio') {
            document.getElementById('fin-adm').style.display = 'block';
            window.renderHist();
        }
    }

    window.resizeAndRead = function(input, imgId, iconId) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 300;
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById(imgId).src = dataUrl;
                    document.getElementById(imgId).style.display = 'block';
                    document.getElementById(iconId).style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }
    }

    window.salvar = async function(tipo) {
        try {
            if(tipo === 'cliente') {
                await addDoc(collection(db, "clientes"), {
                    nome: document.getElementById('c-nome').value,
                    tel: document.getElementById('c-tel').value,
                    foto: document.getElementById('p-cli').src
                });
                document.getElementById('c-nome').value = ''; document.getElementById('c-tel').value = '';
            } 
            else if(tipo === 'produto') {
                await addDoc(collection(db, "produtos"), {
                    nome: document.getElementById('p-nome').value,
                    precoCompra: parseFloat(document.getElementById('p-custo').value||0),
                    precoVenda: parseFloat(document.getElementById('p-venda').value||0),
                    foto: document.getElementById('p-prod-cad').src
                });
                document.getElementById('p-nome').value = ''; document.getElementById('p-custo').value = ''; document.getElementById('p-venda').value = '';
            }
            else if(tipo === 'servico') {
                await addDoc(collection(db, "servicos_cad"), {
                    nome: document.getElementById('serv-nome').value,
                    precoVenda: parseFloat(document.getElementById('serv-venda').value||0)
                });
                document.getElementById('serv-nome').value = ''; document.getElementById('serv-venda').value = '';
            }
            alert("SALVO NA NUVEM!");
        } catch(e) { console.error(e); alert("ERRO AO SALVAR"); }
    }

    window.listar = function(tipo) {
        const div = document.getElementById('lista-bd');
        div.innerHTML = "<div style='text-align:center'><i class='fas fa-spinner fa-spin'></i></div>";
        
        let dados = [];
        let labelPreco = false;
        let col = "";

        if(tipo === 'clientes') { dados = window.dbLocal.clientes; col = "clientes"; }
        if(tipo === 'produtos') { dados = window.dbLocal.produtos; col = "produtos"; labelPreco = true; }
        if(tipo === 'servicos') { dados = window.dbLocal.servicosCadastrados; col = "servicos_cad"; labelPreco = true; }

        if(dados.length === 0) { div.innerHTML = "<div style='padding:10px; text-align:center; color:#999'>VAZIO</div>"; return; }

        div.innerHTML = dados.map(item => `
            <div class="item-lista">
                ${item.foto && item.foto.length > 100 ? `<img src="${item.foto}" style="width:30px; height:30px; border-radius:50%; object-fit:cover">` : ''}
                <div class="item-info">
                    <b>${item.nome}</b><br>
                    <span style="color:#666">${labelPreco ? 'R$ ' + (item.precoVenda ? item.precoVenda.toFixed(2) : '0.00') : (item.tel || '')}</span>
                </div>
                <button class="btn-del" onclick="excluir('${col}', '${item.id}')"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
    }

    window.excluir = async function(col, id) {
        if(!confirm("APAGAR PARA SEMPRE?")) return;
        await deleteDoc(doc(db, col, id));
    }

    window.buscar = function(tipo, termo, divId) {
        const box = document.getElementById(divId);
        if(termo.length < 2) { box.innerHTML = ""; return; }
        const res = window.dbLocal[tipo].filter(i => i.nome.toLowerCase().includes(termo.toLowerCase()));
        box.innerHTML = res.map(i => `<div onclick="set('${tipo}','${i.nome}','${divId}','${i.precoVenda||''}')">${i.nome}</div>`).join('');
    }
    
    window.buscarVenda = function(tipo, termo) {
        const divId = tipo === 'produto' ? 'v-sug-prod' : 'v-sug-serv';
        const box = document.getElementById(divId);
        if(termo.length < 2) { box.innerHTML = ""; return; }
        let lista = (tipo === 'produto') ? window.dbLocal.produtos : window.dbLocal.servicosCadastrados;
        const res = lista.filter(i => i.nome.toLowerCase().includes(termo.toLowerCase()));
        box.innerHTML = res.map(i => `<div onclick="selecionarItemVenda('${tipo}', '${i.nome}', '${i.precoVenda}')">${i.nome}</div>`).join('');
    }

    window.set = function(tipo, nome, divId, preco) {
        if(divId.includes('cli')) { document.getElementById(divId.includes('v') ? 'v-cli' : 's-cli').value = nome; }
        document.getElementById(divId).innerHTML = "";
    }

    window.selecionarItemVenda = function(tipo, nome, preco) {
        if(tipo === 'produto') document.getElementById('v-busca-serv').value = '';
        else document.getElementById('v-busca-prod').value = '';
        document.getElementById('v-sug-prod').innerHTML = '';
        document.getElementById('v-sug-serv').innerHTML = '';
        
        document.getElementById('v-desc').value = nome;
        document.getElementById('v-val').value = preco;
        window.tipoVendaAtual = tipo;
    }

    window.criarOS = async function() {
        let os = {
            cliente: document.getElementById('s-cli').value,
            modelo: document.getElementById('s-apa').value,
            defeito: document.getElementById('s-def').value,
            valor: parseFloat(document.getElementById('s-valor').value || 0),
            status: 'pecas',
            dataEntrada: new Date().toISOString()
        };
        if(!os.cliente) { alert("INFORME O CLIENTE!"); return; }
        await addDoc(collection(db, "os_ativa"), os);
        alert("O.S. SALVA NA NUVEM!");
        document.getElementById('s-apa').value = ""; document.getElementById('s-def').value = ""; document.getElementById('s-valor').value = "";
    }

    window.moverOS = async function(id, novoStatus) {
        await updateDoc(doc(db, "os_ativa", id), { status: novoStatus });
    }

    window.finalizarOS = async function(id) {
        const os = window.dbLocal.activeOS.find(o => o.id === id);
        if(os) {
            await addDoc(collection(db, "logs"), {
                tipo: 'SERVIÇO',
                cliente: os.cliente,
                desc: os.modelo + " (" + os.defeito + ")",
                valor: os.valor,
                lucro: os.valor,
                data: new Date().toISOString()
            });
            await deleteDoc(doc(db, "os_ativa", id));
            alert("FINALIZADO E SINCRONIZADO!");
        }
    }

    window.renderKanban = function() {
        const colPecas = document.getElementById('col-pecas');
        const colPgto = document.getElementById('col-pgto');
        const colRetirado = document.getElementById('col-retirado');
        colPecas.innerHTML = ""; colPgto.innerHTML = ""; colRetirado.innerHTML = "";

        window.dbLocal.activeOS.forEach(os => {
            let card = `
                <div class="os-card ${os.status}">
                    <b>${os.cliente}</b>
                    ${os.modelo}
                    <br><span style="color:#777">R$ ${os.valor.toFixed(2)}</span>
                    <div style="margin-top:5px; display:flex; gap:2px">
                        ${os.status === 'pecas' ? `<button class="btn-sm btn-primary" style="flex:1" onclick="moverOS('${os.id}', 'pgto')">PRONTO</button>` : ''}
                        ${os.status === 'pgto' ? `<button class="btn-sm btn-success" style="flex:1" onclick="moverOS('${os.id}', 'retirado')">SAÍDA</button>` : ''}
                        ${os.status === 'retirado' ? `<button class="btn-sm btn-primary" style="flex:1; background:#444" onclick="finalizarOS('${os.id}')">ARQUIVAR</button>` : ''}
                        <button class="btn-sm" style="background:#ddd; width:25px" onclick="zapOS('${os.cliente}','${os.modelo}')"><i class="fab fa-whatsapp"></i></button>
                    </div>
                </div>`;
            if(os.status === 'pecas') colPecas.innerHTML += card;
            else if(os.status === 'pgto') colPgto.innerHTML += card;
            else if(os.status === 'retirado') colRetirado.innerHTML += card;
        });
    }

    window.finalizarVenda = async function() {
        let item = { 
            tipo: window.tipoVendaAtual === 'produto' ? 'VENDA' : 'SERVIÇO', 
            data: new Date().toISOString(),
            cliente: document.getElementById('v-cli').value,
            desc: document.getElementById('v-desc').value,
            valor: parseFloat(document.getElementById('v-val').value)
        };
        if(!item.desc || !item.valor) { alert("SELECIONE UM ITEM!"); return; }
        
        if(window.tipoVendaAtual === 'produto') {
            let pIdx = window.dbLocal.produtos.findIndex(p => p.nome === item.desc);
            if(pIdx !== -1) { item.lucro = item.valor - (window.dbLocal.produtos[pIdx].precoCompra || 0); }
            else { item.lucro = item.valor; }
        } else { item.lucro = item.valor; }
        
        await addDoc(collection(db, "logs"), item);
        alert("VENDA SINCRONIZADA!");
        location.reload();
    }

    window.renderHist = function() {
        const f = document.getElementById('f-data').value;
        const r = document.getElementById('hist-render');
        const h = new Date();
        let logs = window.dbLocal.logs.filter(l => {
            const d = new Date(l.data);
            if(f === 'hoje') return d.toDateString() === h.toDateString();
            if(f === 'semana') { const start = new Date(h); start.setDate(h.getDate() - h.getDay()); return d >= start; }
            if(f === 'mes') return d.getMonth() === h.getMonth();
            if(f === 'ano') return d.getFullYear() === h.getFullYear();
            return true;
        });
        r.innerHTML = logs.map(l => `<div style="padding:8px; background:#fff; margin-bottom:5px; border-radius:8px; border-left: 4px solid ${l.tipo === 'SERVIÇO' ? '#003399' : '#25d366'}"><b>${l.tipo}:</b> ${l.cliente} - ${l.desc} <span style="float:right">R$ ${l.valor?l.valor.toFixed(2):'0.00'}</span></div>`).join('');
        const fat = logs.reduce((a, b) => a + (b.valor || 0), 0);
        const luc = logs.reduce((a, b) => a + (b.lucro || 0), 0);
        document.getElementById('fin-adm').innerHTML = `TOTAL: FAT R$ ${fat.toFixed(2)} | LUC R$ ${luc.toFixed(2)}`;
    }

    window.zapOS = function(cli, mod) { window.open(`https://wa.me/5581999999999?text=Olá ${cli}, atualização sobre seu aparelho ${mod}.`); }
    
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(e => {}); }); }

</script>
</body>
</html>
