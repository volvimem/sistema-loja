<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FILH√ÉO.CELL v80 PRIV</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d50000">
    <meta name="background-color" content="#d50000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --primary: #d50000;           
            --primary-dark: #b71c1c; 
            --accent: #000000;           
            --text: #212121;             
            --bg: #f5f5f5;              
            --card-bg: #ffffff;          
            --success: #2e7d32;          
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; text-transform: uppercase; }
        
        body { background: var(--bg); color: var(--text); padding-bottom: 85px; user-select: none; }

        /* HEADER */
        header { 
            background: linear-gradient(135deg, var(--accent) 30%, var(--primary) 100%); 
            color: white; padding: 12px 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            position: sticky; top: 0; z-index: 100; 
            display:flex; justify-content:space-between; align-items:center; 
            border-bottom: 3px solid var(--primary);
        }
        header h2 { font-size: 15px; font-weight: 900; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; font-style: italic; }

        .version-btn { 
            font-size: 9px; font-weight: bold; background: rgba(255,255,255,0.2); 
            padding: 3px 8px; border-radius: 12px; margin-left: 5px; font-style: normal; 
            cursor: pointer; border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; gap: 5px;
            transition: 0.3s;
        }

        .container { padding: 10px; max-width: 800px; margin: auto; }
        .page { display: none; animation: slideUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        /* CARDS */
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 12px; position: relative; border-left: 4px solid transparent; }
        .card:hover { border-left-color: var(--primary); transition: 0.3s; }

        h3 { 
            color: var(--accent); font-size: 13px; margin-bottom: 12px; 
            border-bottom: 2px solid #eee; padding-bottom: 6px; 
            display:flex; justify-content:space-between; align-items:center; font-weight: 800; 
        }

        /* BOT√ïES PEQUENOS */
        .btn-novo {
            background: var(--accent); color: white; border: none; 
            padding: 5px 12px; border-radius: 6px; font-size: 9px; font-weight: bold; 
            cursor: pointer; display: flex; align-items: center; gap: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.2s;
        }

        label { font-size: 9px; font-weight: 800; color: #666; margin-top: 8px; display: block; letter-spacing: 0.5px; }
        
        input, textarea, select { 
            width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; 
            background: #fafafa; margin-top: 4px; font-size: 13px; outline: none; transition: 0.2s; font-weight: 600; color: #333;
            text-transform: uppercase;
        }
        input::placeholder { text-transform: uppercase; font-size: 11px; }
        input:focus { border-color: var(--primary); background: #fff; }

        .fa-lock { color: #f1c40f; margin-right: 3px; font-size: 11px; }

        /* BUSCA */
        .search-box { position: relative; margin-top: 5px; }
        .search-box input { padding-right: 40px; margin-top: 0; }
        .search-btn { 
            position: absolute; right: 4px; top: 4px; bottom: 4px;
            background: var(--primary); color: white; border: none; width: 35px; 
            border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            z-index: 20; font-size: 12px;
        }
        .clear-btn {
            position: absolute; right: 45px; top: 8px; color: #d32f2f; cursor: pointer; 
            font-size: 14px; z-index: 21; display: none;
        }

        /* SUGEST√ïES */
        .sugestoes { 
            background: white; border-radius: 0 0 10px 10px; max-height: 300px; overflow-y: auto; 
            position: absolute; top: 100%; width: 100%; z-index: 999; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); display: none; border: 1px solid #eee;
        }
        .sugestoes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
        .sugestoes div.item-sug { 
            padding: 8px; border-bottom: 1px solid #f1f1f1; border-right: 1px solid #f1f1f1;
            cursor: pointer; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; 
        }
        .sug-header { font-size: 9px; font-weight: 900; padding: 5px; text-align:center; border-bottom: 2px solid #ccc; letter-spacing: 1px; position:sticky; top:0; z-index:2; }

        /* FOTOS OS */
        .os-foto-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; }
        .os-foto-slot {
            aspect-ratio: 1; background: #eee; border-radius: 6px; border: 2px dashed #ccc;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            overflow: hidden; position: relative;
        }
        .os-foto-slot img { width: 100%; height: 100%; object-fit: cover; }
        .os-foto-slot i { color: #999; font-size: 18px; }

        /* KANBAN */
        .kanban-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; align-items: start; }
        .k-col { background: #f0f0f0; padding: 4px; border-radius: 8px; min-height: 100px; }
        .k-head { font-size: 8px; font-weight: 900; text-align: center; margin-bottom: 6px; color: var(--accent); background: white; padding: 4px; border-radius: 4px; border: 1px solid #ddd; }

        .os-card { background: white; padding: 6px; border-radius: 6px; margin-bottom: 6px; border-top: 3px solid #ccc; font-size: 9px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .os-card.pecas { border-top-color: var(--primary); } 
        .os-card.pgto { border-top-color: #ff9800; } 
        .os-card.retirado { border-top-color: var(--success); }

        /* BOT√ïES MINI */
        .btn-mini { 
            border: none; border-radius: 6px; padding: 6px 0; color: white; cursor: pointer; 
            font-size: 11px; flex: 1; transition: 0.2s; display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); min-width: 28px; text-decoration: none; 
        }
        .btn-mini:active { transform: scale(0.95); }
        .btn-mini.blue { background: #0288d1; }
        .btn-mini.red { background: #d32f2f; }
        .btn-mini.green { background: #2e7d32; }
        .btn-mini.dark { background: var(--accent); }
        .btn-mini.orange { background: #f57c00; }
        .btn-mini.zap { background: #25D366; }
        .actions-row { display: flex; gap: 6px; margin-top: 5px; width: 100%; }

        /* BOT√ïES GERAIS */
        .btn { 
            width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: 800; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; 
            margin-top: 12px; font-size: 12px; color: white; text-transform: uppercase; letter-spacing: 0.5px; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.15); 
        }
        .btn-primary { background: var(--primary); } 
        .btn-dark { background: var(--accent); } 
        .btn-info { background: #0288d1; }
        .btn-success { background: var(--success); }
        .btn-add-mini { background: #2e7d32; color:white; border:none; border-radius:6px; width:40px; font-size:16px; cursor:pointer; margin-top:4px; }

        /* FOTOS E MODAL */
        .foto-preview { 
            width: 70px; height: 70px; border-radius: 50%; background-color: #eee; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23999'%3E%3Cpath d='M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z'/%3E%3C/svg%3E");
            background-size: 40%; background-position: center; background-repeat: no-repeat;
            object-fit: cover; border: 3px solid var(--primary); margin: 8px auto; display: block; cursor: pointer; 
        }
        .foto-preview.has-img { background-image: none; }

        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 20px; border-radius: 16px; width: 85%; max-width: 300px; text-align: center; border: 2px solid var(--primary); }

        .password-container { position: relative; width: 100%; }
        .password-container input { padding-right: 40px; }
        .password-container i { position: absolute; right: 10px; top: 50%; transform: translateY(-30%); color: #777; cursor: pointer; padding: 5px; font-size: 16px; }

        /* RANKING & FINANCEIRO */
        .rank-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .rank-box { background: #fafafa; padding: 8px; border-radius: 10px; border: 1px solid #eee; }
        .rank-title { font-size: 9px; font-weight: 900; text-align: center; color: var(--primary); margin-bottom: 6px; border-bottom: 2px solid var(--primary); padding-bottom: 2px; }
        .rank-item { font-size: 8px; margin-bottom: 4px; display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }

        .fin-item { background: #fff3e0; padding: 8px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #ff9800; text-align: left; }
        .fin-val { font-weight: 900; color: #d32f2f; font-size: 11px; }
        .fin-date { font-size: 8px; color: #666; display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }

        .btn-debt { background: #d32f2f; color: white; width: 100%; border: none; padding: 10px; border-radius: 8px; font-weight: 800; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 6px rgba(211,47,47,0.3); font-size: 11px; }
        
        /* NAV */
        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 2px solid var(--primary); padding: 8px 0 20px 0; z-index: 900; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; border: none; background: none; color: #999; font-size: 8px; font-weight: bold; text-align: center; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 3px; color: var(--accent); }
        .nav-item.active i { color: var(--primary); }

        .check-log { transform: scale(1.3); margin-right: 10px; accent-color: var(--primary); }
    </style>
</head>
<body>

<div id="modal-overlay" onclick="fecharModal(event)">
    <div class="modal-content" id="modal-content-default"></div>
</div>

<div id="modal-extrato" onclick="fecharExtrato(event)" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2001; align-items:center; justify-content:center; backdrop-filter:blur(5px)">
    <div class="modal-content" style="width:90%; max-width:400px; max-height:80vh; display:flex; flex-direction:column; padding:0; overflow:hidden">
        <div style="background:var(--primary); color:white; padding:12px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:12px">
            <span id="ext-nome">CLIENTE</span>
            <i class="fas fa-times" onclick="document.getElementById('modal-extrato').style.display='none'" style="cursor:pointer"></i>
        </div>
        <div id="ext-lista" style="padding:12px; overflow-y:auto; flex:1; background:#f9f9f9"></div>
        <div id="ext-share-area" style="padding:12px; background:white; border-top:1px solid #eee; display:flex; flex-direction:column; gap:6px">
            <div id="ext-preview-box" style="border:1px solid #ccc; padding:10px; max-height:250px; overflow-y:auto; background:#fff; margin-bottom:10px; font-size:10px; display:none; color:black;"></div>
            
            <div style="font-size:9px; color:#999; text-align:center; font-weight:bold; margin-bottom:4px">COMPARTILHAR</div>
            <button class="btn" style="background:#25d366; margin:0; padding:8px" onclick="shareExtrato('zap')"><i class="fab fa-whatsapp"></i> WHATSAPP</button>
            <button class="btn" style="background:#0277bd; margin:0; padding:8px" onclick="shareExtrato('bluetooth')"><i class="fab fa-bluetooth"></i> BLUETOOTH (RAWBT)</button>
        </div>
    </div>
</div>

<header>
    <h2><i class="fas fa-fire"></i> FILH√ÉO.CELL <div class="version-btn" onclick="forcarAtualizacao()">v80 PRIV <i class="fas fa-sync-alt"></i></div></h2>
    <div id="status-conn" style="font-size:10px"><i class="fas fa-wifi"></i></div>
</header>

<div class="container">
    <div id="page-vendas" class="page active">
        <div class="card">
            <h3>
                <i class="fas fa-cash-register"></i> CAIXA
                <button class="btn-novo" onclick="limparVendas()"><i class="fas fa-eraser"></i> LIMPAR</button>
            </h3>
            <label>CLIENTE</label>
            <div class="search-box">
                <input type="text" id="v-cli" placeholder="BUSCAR CLIENTE..." onkeyup="buscar('clientes', this.value, 'sug-v-cli')">
                <button type="button" class="search-btn" onclick="toggleSearch('cli', 'v-cli', 'sug-v-cli')"><i class="fas fa-search"></i></button>
                <div id="sug-v-cli" class="sugestoes"></div>
            </div>
            <button class="btn-novo" style="margin-top:10px" onclick="cadastrarNovoNaVenda()"><i class="fas fa-plus"></i> NOVO CLIENTE</button>

            <label style="margin-top:15px">ADICIONAR ITEM</label>
            <div class="search-box">
                <input type="text" id="v-busca" placeholder="BIPAR OU DIGITAR..." onkeyup="buscarVenda(this.value)">
                <i class="fas fa-times clear-btn" id="v-clear-btn" onclick="limparBuscaVenda()"></i>
                <button type="button" class="search-btn" onclick="toggleSearch('venda', 'v-busca', 'sug-v-prod')"><i class="fas fa-search"></i></button>
                <div id="sug-v-prod" class="sugestoes"></div>
            </div>

            <div style="background:#f9f9f9; border:2px dashed #e0e0e0; padding:10px; margin-top:15px; border-radius:10px">
                <div style="font-size:9px; color:#999; text-align:center; margin-bottom:5px">ITENS DO CARRINHO</div>
                <div id="carrinho-lista" style="font-size:11px; color:#888; text-align:center; padding:10px">VAZIO</div>
                <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid #ddd">
                    <label style="margin:0; font-size:10px; color:#d32f2f; font-weight:bold">DESCONTO (R$):</label>
                    <input type="number" id="v-desc" placeholder="0.00" style="width:80px; margin:0; border-color:#d32f2f; color:#d32f2f; font-weight:bold; text-align:right" onkeyup="renderCarrinho()">
                </div>
                <div style="text-align:right; font-size:16px; font-weight:900; margin-top:8px; color:var(--primary);" id="v-total">TOTAL: R$ 0,00</div>
            </div>
            <button class="btn btn-primary" style="margin-top:15px; width:100%" onclick="finalizarVenda()">FINALIZAR VENDA</button>
        </div>
    </div>

    <div id="page-servicos" class="page">
        <div class="card">
            <h3>NOVA O.S. <button class="btn-novo" onclick="limparOS()"><i class="fas fa-eraser"></i> LIMPAR</button></h3>
            <input type="hidden" id="os-id"><input type="hidden" id="os-status-orig">
            <label>CLIENTE</label>
            <div style="display:flex; gap:5px; align-items:flex-end">
                <div class="search-box" style="flex:1">
                    <input type="text" id="s-cli" placeholder="BUSCAR..." onkeyup="buscar('clientes', this.value, 'sug-s-cli')">
                    <button type="button" class="search-btn" onclick="toggleSearch('cli', 's-cli', 'sug-s-cli')"><i class="fas fa-search"></i></button>
                    <div id="sug-s-cli" class="sugestoes"></div>
                </div>
                <button class="btn-add-mini" onclick="cadastrarNovoNaOS()"><i class="fas fa-plus"></i></button>
            </div>
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>MODELO</label><input id="s-mod"></div>
                <div style="flex:1"><label>SENHA</label><input id="s-senha"></div>
            </div>
            <label>DEFEITO / OBS</label><input id="s-def">
            
            <label>FOTOS DO APARELHO</label>
            <div class="os-foto-grid">
                <div class="os-foto-slot" onclick="addFotoOS(0)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(1)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(2)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(3)"><i class="fas fa-camera"></i></div>
            </div>
            <input type="file" id="os-foto-input" hidden onchange="processFotoOS(this)">

            <label>ADICIONAR PE√áA/SERVI√áO</label>
            <div class="search-box">
                <input type="text" id="s-busca-item" placeholder="BUSCAR PE√áA..." onkeyup="buscarItemOS(this.value)">
                <button type="button" class="search-btn" onclick="toggleSearch('os', 's-busca-item', 'sug-os-item')"><i class="fas fa-search"></i></button>
                <div id="sug-os-item" class="sugestoes"></div>
            </div>

            <div style="background:#f9f9f9; border:2px dashed #e0e0e0; padding:10px; margin-top:15px; border-radius:10px">
                <div id="os-lista-itens"></div>
                <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid #ddd">
                    <label style="margin:0; font-size:10px; color:#d32f2f; font-weight:bold">DESCONTO (R$):</label>
                    <input type="number" id="s-desc" placeholder="0.00" style="width:80px; margin:0; border-color:#d32f2f; color:#d32f2f; font-weight:bold; text-align:right" onkeyup="renderItemsOS()">
                </div>
                <div style="text-align:right; font-size:15px; font-weight:900; margin-top:8px; color:var(--primary);" id="s-total-display">TOTAL: R$ 0,00</div>
            </div>
            <button class="btn btn-primary" onclick="salvarOS()">SALVAR ORDEM</button>
        </div>

        <div style="padding: 0 5px; margin-bottom: 8px; display:flex; gap:5px">
            <div class="search-box" style="flex:1"><input type="text" id="busca-kanban" placeholder="üîç LOCALIZAR OS..." onkeyup="renderKanban()" style="background:white; border:2px solid #ddd; font-weight:bold"></div>
            <button class="btn-mini dark" onclick="verHistoricoOS()"><i class="fas fa-history"></i></button>
        </div>
        <div class="kanban-grid">
            <div class="k-col"><div class="k-head" style="color:#555">AN√ÅLISE</div><div id="k-pecas"></div></div>
            <div class="k-col"><div class="k-head" style="color:#ff9800; font-size:8px">AGUARDANDO PAGAMENTO</div><div id="k-pgto"></div></div>
            <div class="k-col"><div class="k-head" style="color:green">PRONTO</div><div id="k-retirado"></div></div>
        </div>
    </div>

    <div id="page-clientes" class="page">
        <div class="card" id="form-cli">
            <h3>CLIENTES <button class="btn-novo" onclick="limparCli()"><i class="fas fa-user-plus"></i> NOVO</button></h3>
            <input type="hidden" id="c-id">
            <img id="c-foto-view" src="" class="foto-preview" onclick="document.getElementById('c-foto').click()">
            <input type="file" id="c-foto" hidden onchange="lerFoto(this, 'c-foto-view')">
            <input type="text" id="c-nome" placeholder="NOME COMPLETO *">
            <input type="tel" id="c-tel" placeholder="WHATSAPP (81) 9..." oninput="maskTel(this)">
            <div style="display:flex; gap:10px"><input type="text" id="c-bairro" placeholder="BAIRRO"><input type="text" id="c-cidade" placeholder="CIDADE"></div>
            <button class="btn btn-primary" onclick="salvarCliente()">SALVAR CLIENTE</button>
        </div>
        <div class="card">
            <button class="btn-debt" onclick="abrirCarteiraDevedores()">
                <i class="fas fa-book" style="font-size:16px"></i> CARTEIRA DE DEVEDORES
            </button>
            <div class="search-box">
                <input type="text" id="cli-search-input" placeholder="FILTRAR LISTA..." onkeyup="buscar('clientes', this.value, 'lista-clientes', true)">
                <button type="button" class="search-btn" onclick="toggleSearch('listacli', 'cli-search-input', 'lista-clientes')"><i class="fas fa-search"></i></button>
            </div>
            <div id="lista-clientes" style="margin-top:15px"></div>
        </div>
    </div>

    <div id="page-estoque" class="page">
        <div class="card">
            <h3>ITEM DE ESTOQUE <button class="btn-novo" onclick="limparEstoque()"><i class="fas fa-eraser"></i> LIMPAR</button></h3>
            <input type="hidden" id="p-id">
            <img id="p-foto-view" src="" class="foto-preview" onclick="document.getElementById('p-foto').click()">
            <input type="file" id="p-foto" hidden onchange="lerFoto(this, 'p-foto-view')">
            <input type="text" id="p-nome" placeholder="DESCRI√á√ÉO (OBRIGAT√ìRIO) *">
            <div style="display:flex; gap:10px"><input type="number" id="p-venda" placeholder="R$ VENDA *"><input type="number" id="p-qtd" placeholder="QTD"></div>
            <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px">
                <label style="margin-top:0; color:#c62828"><i class="fas fa-lock"></i> PRE√áO DE CUSTO</label>
                <div style="display:flex; gap:5px">
                    <input type="number" id="p-custo" placeholder="0.00" style="border-color:#ffcdd2">
                    <button id="btn-ver-custo" class="btn-mini dark" style="flex:0; width:40px" onclick="revelarCusto()"><i class="fas fa-eye"></i></button>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px">
                <button class="btn btn-primary" onclick="salvarProduto('prod')">SALVAR PRODUTO</button>
                <button class="btn btn-dark" onclick="salvarProduto('serv')">SALVAR SERVI√áO</button>
            </div>
        </div>
        <div class="card">
            <div style="display:flex; gap:5px; margin-bottom:10px">
                <button class="btn-mini dark" onclick="listarEstoque('prod')">PRODUTOS</button>
                <button class="btn-mini dark" style="opacity:0.7" onclick="listarEstoque('serv')">SERVI√áOS</button>
            </div>
            <div id="lista-estoque"></div>
        </div>
    </div>

    <div id="page-relatorio" class="page">
        <div class="card" style="position:relative">
            <i class="fas fa-eye" id="eye-rel" onclick="togglePriv()" style="position:absolute; top:12px; right:12px; color:var(--primary); font-size:16px; cursor:pointer; padding:5px; z-index:10"></i>
            <h3>RELAT√ìRIOS FINANCEIROS</h3>
            <select id="r-filtro" onchange="renderRelatorio()" style="margin-bottom:12px">
                <option value="dia">HOJE</option>
                <option value="semana">√öLTIMOS 7 DIAS</option>
                <option value="mes">M√äS ATUAL</option>
                <option value="ano">ESTE ANO</option>
            </select>
            <div style="background:var(--accent); color:white; padding:15px; border-radius:10px; text-align:center">
                <div style="font-size:10px; opacity:0.8">FATURAMENTO TOTAL</div>
                <div id="r-total" style="font-size:20px; font-weight:900; margin-top:4px">****</div>
                
                <div style="font-size:10px; opacity:0.8; margin-top:8px; border-top:1px solid rgba(255,255,255,0.2); padding-top:4px">LUCRO ESTIMADO</div>
                <div id="r-lucro" style="font-size:16px; font-weight:900; color:#b2fab4">****</div>
            </div>

            <h3 style="margin-top:20px; font-size:11px; color:#666">CLIENTES ATENDIDOS</h3>
            <div class="search-box" style="margin-bottom:8px">
                <input type="text" id="r-search" placeholder="üîç BUSCAR CLIENTE..." onkeyup="renderRelatorio()" style="background:white; border:2px solid #ddd">
                <div id="sug-r-cli" class="sugestoes"></div>
            </div>
            <div id="r-hist" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:5px"></div>

            <h3 style="margin-top:15px; font-size:11px; color:#666">RANKINGS</h3>
            <div class="rank-grid">
                <div class="rank-box"><div class="rank-title">CLIENTES</div><div id="rank-cli"></div></div>
                <div class="rank-box"><div class="rank-title">PRODUTOS</div><div id="rank-prod"></div></div>
                <div class="rank-box"><div class="rank-title">SERVI√áOS</div><div id="rank-serv"></div></div>
            </div>
        </div>
    </div>
</div>

<nav>
    <button class="nav-item active" onclick="nav('vendas', this)"><i class="fas fa-shopping-cart"></i>VENDAS</button>
    <button class="nav-item" onclick="nav('servicos', this)"><i class="fas fa-wrench"></i>OS</button>
    <button class="nav-item" onclick="nav('clientes', this)"><i class="fas fa-users"></i>CLIENTES</button>
    <button class="nav-item" onclick="nav('estoque', this)"><i class="fas fa-box"></i>ESTOQUE</button>
    <button class="nav-item" onclick="nav('relatorio', this)"><i class="fas fa-chart-line"></i>RELAT√ìRIOS</button>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDeGGqXV4LOB_ENZLkj_QHOIE5_OEp29s0",
  authDomain: "filhaocell-a528e.firebaseapp.com",
  projectId: "filhaocell-a528e",
  storageBucket: "filhaocell-a528e.firebasestorage.app",
  messagingSenderId: "69033828352",
  appId: "1:69033828352:web:a0ec6bcbf797622e6838e5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const SENHA = "0800"; 
const EMPRESA = { nome: "FILH√ÉO.CELL", cnpj: "31.926.078/0001-65", tel: "(81) 9 9507-4007", end: "Rua Jose Medeiros Rego, 09, Centro", cid: "Surubim - PE", email: "filhao.cell@gmail.com" };

window.db = { clientes:[], produtos:[], servicos:[], os:[], logs:[], dividas:[], os_hist:[] };
window.carrinho = []; window.carrinhoOS = []; window.shareData = null; window.tempImg = null; window.retornoVenda = false; window.retornoOS = false; window.osFotos = [null, null, null, null]; window.currentFotoIndex = 0; window.extratoAtual = null; window.editingDateId = null;
window.callbackSenha = null; window.verValores = false;

onSnapshot(collection(db, "clientes"), s => { window.db.clientes = s.docs.map(d=>({id:d.id, ...d.data()})); if(isPg('clientes')) listarCli(); });
onSnapshot(collection(db, "produtos"), s => { window.db.produtos = s.docs.map(d=>({id:d.id, ...d.data()})); if(isPg('estoque')) listarEstoque('prod'); });
onSnapshot(collection(db, "servicos_cad"), s => { window.db.servicos = s.docs.map(d=>({id:d.id, ...d.data()})); if(isPg('estoque')) listarEstoque('serv'); });
onSnapshot(query(collection(db, "os_ativa"), orderBy("data", "desc")), s => { window.db.os = s.docs.map(d=>({id:d.id, ...d.data()})); renderKanban(); });
onSnapshot(query(collection(db, "logs"), orderBy("data", "desc")), s => { window.db.logs = s.docs.map(d=>({id:d.id, ...d.data()})); if(isPg('relatorio')) renderRelatorio(); });
onSnapshot(collection(db, "dividas"), s => { window.db.dividas = s.docs.map(d=>({id:d.id, ...d.data()})); });
onSnapshot(query(collection(db, "os_historico"), orderBy("data", "desc")), s => { window.db.os_hist = s.docs.map(d=>({id:d.id, ...d.data()})); });

function isPg(p){ return document.getElementById('page-'+p).classList.contains('active'); }

window.abrirModalSenha = function(callback) {
    window.callbackSenha = callback;
    document.getElementById('modal-overlay').style.display = 'flex';
    document.getElementById('modal-content-default').innerHTML = `
        <h3 style="justify-content:center; border:none; margin-bottom:5px">ADMINISTRADOR</h3>
        <i class="fas fa-user-shield" style="font-size:26px; color:var(--primary); margin-bottom:12px; display:block"></i>
        <div class="password-container">
            <input type="password" id="input-senha-adm" placeholder="SENHA" onkeydown="if(event.key==='Enter') verificarSenha()">
            <i class="fas fa-eye" onclick="togglePass()" id="eye-icon"></i>
        </div>
        <button class="btn btn-primary" onclick="verificarSenha()" style="margin-top:12px">CONFIRMAR</button>
        <button class="btn" style="background:#666; margin-top:5px" onclick="fecharModal({target:{id:'modal-overlay'}})">CANCELAR</button>
    `;
    setTimeout(() => document.getElementById('input-senha-adm').focus(), 100);
}

window.togglePass = function() {
    const inp = document.getElementById('input-senha-adm');
    const ico = document.getElementById('eye-icon');
    if (inp.type === "password") { inp.type = "text"; ico.classList.remove('fa-eye'); ico.classList.add('fa-eye-slash'); ico.style.color = "var(--primary)"; } 
    else { inp.type = "password"; ico.classList.remove('fa-eye-slash'); ico.classList.add('fa-eye'); ico.style.color = "#777"; }
}

window.verificarSenha = function() {
    const digitada = document.getElementById('input-senha-adm').value;
    if (digitada === SENHA) { 
        if (window.callbackSenha) window.callbackSenha(); 
    } 
    else { alert("SENHA INCORRETA"); document.getElementById('input-senha-adm').value = ''; }
}

window.nav = function(p, el) {
    if(p === 'relatorio') { 
        abrirModalSenha(() => {
            document.getElementById('modal-overlay').style.display='none'; 
            document.querySelectorAll('.page').forEach(d=>d.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(d=>d.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            if(el) el.classList.add('active');
            window.verValores = false; 
            document.getElementById('eye-rel').classList.remove('fa-eye-slash');
            document.getElementById('eye-rel').classList.add('fa-eye');
            renderRelatorio();
        });
        return;
    }
    document.querySelectorAll('.page').forEach(d=>d.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(d=>d.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    if(el) el.classList.add('active');
    if(p==='clientes') listarCli();
    if(p==='estoque') listarEstoque('prod');
}
window.forcarAtualizacao = async function() { if(!confirm("Atualizar sistema?")) return; window.location.reload(true); }

window.toggleSearch = function(tipo, inpId, boxId) {
    const box = document.getElementById(boxId); const val = document.getElementById(inpId).value;
    if(tipo === 'listacli') { if(box.innerHTML.trim()!==''){box.innerHTML='';} else {buscar('clientes', val, boxId, true, true);} return; }
    if(box.style.display === 'block') { box.style.display = 'none'; } else {
        if(tipo === 'cli') buscar('clientes', val, boxId, false, true);
        if(tipo === 'venda') buscarVenda(val, true);
        if(tipo === 'os') buscarItemOS(val, true);
    }
}
window.buscar = function(col, txt, divId, lista=false, force=false) {
    const box = document.getElementById(divId); if(!window.db[col]) return;
    if(!txt && !force && !lista) { box.style.display='none'; return; }
    let source = window.db[col].sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));
    if(txt) source = source.filter(i => (i.nome||'').toUpperCase().includes(txt.toUpperCase()));
    if(!lista) source = source.slice(0, 50);
    if(lista) { if(source.length===0){document.getElementById(divId).innerHTML='<div style="text-align:center;padding:10px;color:#999">VAZIO</div>';} else {document.getElementById(divId).innerHTML=source.map(renderCliCard).join('');} return; }
    if(source.length) { box.innerHTML = source.map(i => `<div class="item-sug" onclick="sel('${col}','${i.id}','${divId}')">${i.nome}</div>`).join(''); box.style.display='block'; box.classList.remove('sugestoes-grid'); } 
    else { box.innerHTML = '<div class="item-sug" style="color:#999">VAZIO</div>'; box.style.display='block'; setTimeout(() => box.style.display='none', 2000); }
}
window.sel = function(c, id, div) {
    const item = window.db[c].find(i=>i.id===id);
    if(div === 'sug-r-cli') { document.getElementById('r-search').value = item.nome; document.getElementById(div).style.display='none'; renderRelatorio(); return; }
    const inp = div.includes('v-') ? 'v-cli' : 's-cli'; document.getElementById(inp).value = item.nome; document.getElementById(div).style.display='none';
}

// BUSCAS VENDAS
window.buscarVenda = function(txt, force=false) {
    const box = document.getElementById('sug-v-prod'); 
    const clearBtn = document.getElementById('v-clear-btn');
    if(txt) clearBtn.style.display = 'block'; else clearBtn.style.display = 'none';
    if(!txt && !force) { box.style.display='none'; return; }
    const term = (txt||'').toUpperCase();
    const prods = window.db.produtos.filter(i => (i.nome||'').toUpperCase().includes(term)).sort((a,b)=>a.nome.localeCompare(b.nome));
    const servs = window.db.servicos.filter(i => (i.nome||'').toUpperCase().includes(term)).sort((a,b)=>a.nome.localeCompare(b.nome));
    let html = `<div class="sug-header">ITENS</div><div class="sugestoes-grid">`;
    html += prods.map(i => `<div class="item-sug" onclick="addCar('${i.id}','P','${i.nome}',${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');
    html += servs.map(i => `<div class="item-sug" onclick="addCar('${i.id}','S','${i.nome}',${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');
    html += `</div>`;
    if(!prods.length && !servs.length) { box.innerHTML='<div class="item-sug">VAZIO</div>'; box.style.display='block'; setTimeout(()=>box.style.display='none',2000); } else { box.innerHTML=html; box.style.display='block'; }
}
window.limparBuscaVenda = function() {
    document.getElementById('v-busca').value = '';
    document.getElementById('sug-v-prod').style.display='none';
    document.getElementById('v-clear-btn').style.display = 'none';
    document.getElementById('v-busca').focus();
}

window.limparVendas = function() {
    document.getElementById('v-cli').value = ''; document.getElementById('v-busca').value = ''; document.getElementById('v-desc').value = '';
    document.getElementById('sug-v-cli').style.display='none'; document.getElementById('sug-v-prod').style.display='none'; document.getElementById('v-clear-btn').style.display = 'none';
}

window.addCar = function(id, tipo, nome, val) {
    const exist = window.carrinho.find(x => x.id === id);
    if(exist) { exist.qtd++; exist.val += val; } else { window.carrinho.push({ id, tipo, nome, val, qtd: 1, unit: val, garantia: 'SEM GARANTIA' }); }
    renderCarrinho(); limparBuscaVenda();
}
window.renderCarrinho = function() {
    const l = document.getElementById('carrinho-lista'); if(!window.carrinho.length) { l.innerHTML='VAZIO'; document.getElementById('v-total').innerText='TOTAL: R$ 0,00'; return; }
    let subtotal = 0;
    l.innerHTML = window.carrinho.map((i,x) => {
        subtotal += i.val;
        return `<div style="padding:8px; border-bottom:1px solid #eee; background:white; border-radius:8px; margin-bottom:4px"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="flex:1; font-weight:bold">${i.qtd}x ${i.nome}</span><span style="font-weight:bold; color:var(--primary)">R$ ${i.val.toFixed(2)}</span></div><div style="display:flex; align-items:center; gap:5px; margin-top:5px;"><label style="margin:0; font-size:9px">GAR:</label><select style="padding:2px; font-size:10px; width:auto;" onchange="setGarantiaCar(${x}, this.value)"><option value="SEM GARANTIA" ${i.garantia=='SEM GARANTIA'?'selected':''}>SEM</option><option value="30 DIAS" ${i.garantia=='30 DIAS'?'selected':''}>30 D</option><option value="90 DIAS" ${i.garantia=='90 DIAS'?'selected':''}>90 D</option><option value="1 ANO" ${i.garantia=='1 ANO'?'selected':''}>1 ANO</option></select></div><div class="actions-row"><button class="btn-mini blue" onclick="editItemVenda(${x})"><i class="fas fa-pen"></i></button><button class="btn-mini red" onclick="delCar(${x})"><i class="fas fa-trash"></i></button></div></div>`;
    }).join('');
    const desc = parseFloat(document.getElementById('v-desc').value) || 0;
    document.getElementById('v-total').innerText = 'TOTAL: R$ ' + (subtotal - desc).toFixed(2);
}
window.setGarantiaCar = function(idx, val) { window.carrinho[idx].garantia = val; }
window.editItemVenda = function(index) { const i=window.carrinho[index]; const n=prompt(`Valor TOTAL ${i.nome} (${i.qtd}x):`, i.val); if(n!==null){const v=parseFloat(n); if(!isNaN(v)){window.carrinho[index].val=v; renderCarrinho();}} }
window.delCar = function(i) { window.carrinho.splice(i,1); renderCarrinho(); }
window.cadastrarNovoNaVenda = function() { window.retornoVenda=true; window.nav('clientes'); }
window.cadastrarNovoNaOS = function() { window.retornoOS=true; window.nav('clientes'); }

window.finalizarVenda = async function() {
    if(!window.carrinho.length) return alert("VAZIO");
    
    // BLOQUEIO NOME VAZIO
    const cliField = document.getElementById('v-cli').value.trim();
    if(!cliField) return alert("ERRO: DIGITE O NOME DO CLIENTE!");
    
    const cli = cliField.toUpperCase();
    const desc = parseFloat(document.getElementById('v-desc').value) || 0;
    const sub = window.carrinho.reduce((a,b)=>a+b.val,0);
    const total = sub - desc;

    let valorPago = parseFloat(prompt(`TOTAL: R$ ${total.toFixed(2)}\n\nQuanto o cliente vai pagar AGORA?`, total));
    if(isNaN(valorPago)) return;
    if(valorPago < 0) valorPago = 0;
    
    for(let i of window.carrinho) {
        await addDoc(collection(db,"logs"), { tipo: i.tipo=='P'?'PRODUTO':'SERVICO', desc: i.nome, valor: i.val, qtd: i.qtd||1, garantia: i.garantia, cliente: cli, data: new Date().toISOString() });
    }
    if(desc>0) await addDoc(collection(db,"logs"), {tipo:'DESCONTO', desc:'DESCONTO', valor: -desc, cliente:cli, data:new Date().toISOString()});

    let msgFiado = "";
    if(valorPago < total) {
        const restante = total - valorPago;
        await addDoc(collection(db,"dividas"), {
            cliente: cli,
            valor_total: total,
            valor_pago: valorPago,
            restante: restante,
            data_venda: new Date().toISOString(),
            data_lembrete: "",
            itens: window.carrinho.map(i=>`${i.qtd}x ${i.nome}`).join(', ')
        });
        msgFiado = `\n\nATEN√á√ÉO: D√âBITO DE R$ ${restante.toFixed(2)} REGISTRADO!`;
    }

    window.shareData = { tipo:'VENDA', cliente:cli, itens:window.carrinho, subtotal: sub, desconto: desc, total: total };
    window.carrinho=[]; document.getElementById('v-cli').value=''; document.getElementById('v-desc').value=''; renderCarrinho();
    alert("VENDA FINALIZADA!" + msgFiado);
    abrirModalShare();
}

// OS
window.addFotoOS = function(idx) { window.currentFotoIndex = idx; document.getElementById('os-foto-input').click(); }
window.processFotoOS = function(inp) {
    if(inp.files && inp.files[0]) { const r = new FileReader(); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const x = c.getContext('2d'); let w=i.width, h=i.height; if(w>h){if(w>400){h*=400/w;w=400}}else{if(h>400){w*=400/h;h=400}}; c.width=w; c.height=h; x.drawImage(i,0,0,w,h); window.osFotos[window.currentFotoIndex] = c.toDataURL('image/jpeg', 0.6); const slots = document.querySelectorAll('.os-foto-slot'); window.osFotos.forEach((f, i) => { if(f) slots[i].innerHTML = `<img src="${f}">`; else slots[i].innerHTML = `<i class="fas fa-camera"></i>`; }); } }; r.readAsDataURL(inp.files[0]); }
}

window.buscarItemOS = function(txt, force=false) {
    const box = document.getElementById('sug-os-item'); if(!txt && !force) { box.style.display='none'; return; }
    const term = (txt||'').toUpperCase();
    const prods = window.db.produtos.filter(i => (i.nome||'').toUpperCase().includes(term)).sort((a,b)=>a.nome.localeCompare(b.nome));
    const servs = window.db.servicos.filter(i => (i.nome||'').toUpperCase().includes(term)).sort((a,b)=>a.nome.localeCompare(b.nome));
    
    let html = `<div style="display:flex; width:100%">`;
    html += `<div style="width:50%; border-right:1px solid #ccc"><div class="sug-header" style="background:#e3f2fd; color:#0d47a1">PE√áAS / PRODUTOS</div><div style="display:flex; flex-direction:column;">`;
    if(prods.length > 0) {
         html += prods.map(i => `<div class="item-sug" onclick="addItemOS('${i.id}', 'P', '${i.nome}', ${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');
    } else { html += `<div class="item-sug" style="color:#ccc; text-align:center">NENHUM</div>`; }
    html += `</div></div>`;

    html += `<div style="width:50%"><div class="sug-header" style="background:#fce4ec; color:#880e4f">SERVI√áOS</div><div style="display:flex; flex-direction:column;">`;
    if(servs.length > 0) {
        html += servs.map(i => `<div class="item-sug" onclick="addItemOS('${i.id}', 'S', '${i.nome}', ${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');
    } else { html += `<div class="item-sug" style="color:#ccc; text-align:center">NENHUM</div>`; }
    html += `</div></div></div>`;
    box.innerHTML = html; box.style.display='block';
}

window.addItemOS = function(id, tipo, nome, val) {
    const exist = window.carrinhoOS.find(x => x.nome === nome);
    if(exist) { exist.qtd = (exist.qtd || 1) + 1; exist.val += val; } else { window.carrinhoOS.push({id, tipo, nome, val, qtd: 1, unit: val, garantia: '90 DIAS'}); }
    renderItemsOS(); document.getElementById('s-busca-item').value = ''; document.getElementById('sug-os-item').style.display='none'; 
}
window.renderItemsOS = function() {
    const l = document.getElementById('os-lista-itens'); if(!window.carrinhoOS.length) { l.innerHTML = 'VAZIO'; document.getElementById('s-total-display').innerText='TOTAL: R$ 0,00'; return; }
    let subtotal = 0;
    l.innerHTML = window.carrinhoOS.map((i,x) => {
        subtotal += i.val;
        return `<div style="padding:8px; border-bottom:1px solid #eee; background:white; border-radius:8px; margin-bottom:4px"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="flex:1;cursor:pointer; font-weight:bold">${i.qtd||1}x ${i.nome}</span><span style="font-weight:bold; color:var(--primary)">R$ ${i.val.toFixed(2)}</span></div><div style="display:flex; align-items:center; gap:5px; margin-top:5px;"><label style="margin:0; font-size:9px">GAR:</label><select style="padding:2px; font-size:10px; width:auto;" onchange="setGarantiaOS(${x}, this.value)"><option value="SEM GARANTIA" ${i.garantia=='SEM GARANTIA'?'selected':''}>SEM</option><option value="30 DIAS" ${i.garantia=='30 DIAS'?'selected':''}>30 D</option><option value="90 DIAS" ${i.garantia=='90 DIAS'?'selected':''}>90 D</option><option value="1 ANO" ${i.garantia=='1 ANO'?'selected':''}>1 ANO</option></select></div><div class="actions-row"><button class="btn-mini blue" onclick="editItemOS(${x})"><i class="fas fa-pen"></i></button><button class="btn-mini red" onclick="delItemOS(${x})"><i class="fas fa-trash"></i></button></div></div>`;
    }).join('');
    const desc = parseFloat(document.getElementById('s-desc').value) || 0;
    document.getElementById('s-total-display').innerText = 'TOTAL: R$ ' + (subtotal - desc).toFixed(2);
}
window.setGarantiaOS = function(idx, val) { window.carrinhoOS[idx].garantia = val; }
window.editItemOS = function(index) { const i=window.carrinhoOS[index]; const n=prompt(`Valor TOTAL ${i.nome}:`, i.val); if(n!==null){const v=parseFloat(n); if(!isNaN(v)){window.carrinhoOS[index].val=v; renderItemsOS();}} }
window.delItemOS = function(i) { window.carrinhoOS.splice(i,1); renderItemsOS(); }

window.salvarOS = async function() {
    const id = document.getElementById('os-id').value; 

    // BLOQUEIO NOME VAZIO
    const cliField = document.getElementById('s-cli').value.trim();
    if(!cliField) return alert("ERRO: OBRIGAT√ìRIO NOME DO CLIENTE NA O.S.!");

    const sub = window.carrinhoOS.reduce((a,b)=>a+b.val,0); 
    const desc = parseFloat(document.getElementById('s-desc').value) || 0;
    let numOS = 0;

    if(!id) {
        const configRef = doc(db, "config", "contador");
        const configSnap = await getDoc(configRef);
        if (configSnap.exists()) { numOS = configSnap.data().last + 1; await updateDoc(configRef, { last: numOS }); } 
        else { numOS = 1; await setDoc(configRef, { last: 1 }); }
    }

    const os = { cliente: cliField.toUpperCase(), modelo: document.getElementById('s-mod').value.toUpperCase(), defeito: document.getElementById('s-def').value.toUpperCase(), senha: document.getElementById('s-senha').value.toUpperCase(), valor: sub - desc, desconto: desc, itens: window.carrinhoOS, fotos: window.osFotos, status: document.getElementById('os-status-orig').value || 'pecas', data: new Date().toISOString() };
    if(!id) os.num = numOS;
    if(id) await updateDoc(doc(db,"os_ativa",id), os); else await addDoc(collection(db,"os_ativa"), os);
    limparOS(); alert("SALVO! OS N¬∫ " + (id ? "ATUALIZADA" : numOS));
}

window.limparOS = function() {
    document.getElementById('os-id').value = ''; document.getElementById('s-cli').value = ''; document.getElementById('s-mod').value = '';
    document.getElementById('s-senha').value = ''; document.getElementById('s-def').value = ''; document.getElementById('s-desc').value = '';
    window.carrinhoOS = []; window.osFotos = [null,null,null,null]; renderItemsOS(); 
    const slots = document.querySelectorAll('.os-foto-slot'); slots.forEach(s => s.innerHTML = '<i class="fas fa-camera"></i>');
}

window.renderKanban = function() {
    const c = {pecas:'', pgto:'', retirado:''}; const flow = ['pecas', 'pgto', 'retirado']; const term = document.getElementById('busca-kanban') ? document.getElementById('busca-kanban').value.toUpperCase() : '';
    window.db.os.forEach(o => {
        if(term) { const t = (o.cliente+' '+o.modelo+' '+o.status).toUpperCase(); if(!t.includes(term)) return; }
        const idx = flow.indexOf(o.status);
        let nav = '';
        if(idx > 0) nav += `<button class="btn-mini dark" onclick="moveOS('${o.id}', -1)"><i class="fas fa-arrow-left"></i></button>`;
        if(idx < 2) nav += `<button class="btn-mini dark" onclick="moveOS('${o.id}', 1)"><i class="fas fa-arrow-right"></i></button>`;
        else nav += `<button class="btn-mini primary" style="background:var(--primary)" onclick="arqOS('${o.id}')"><i class="fas fa-archive"></i></button>`;
        const numDisplay = o.num ? `<b>#${o.num}</b> - ` : '';
        c[o.status] += `<div class="os-card ${o.status}"><div>${numDisplay}<b>${o.cliente}</b></div><div>${o.modelo}</div><div style="font-weight:bold; color:var(--primary)">R$ ${o.valor.toFixed(2)}</div><div class="actions-row">${nav}</div><div class="actions-row"><button class="btn-mini blue" onclick="editOS('${o.id}')"><i class="fas fa-pen"></i></button><button class="btn-mini zap" onclick="shareOS('${o.id}')"><i class="fas fa-share-alt"></i></button><button class="btn-mini red" onclick="delOS('${o.id}')"><i class="fas fa-trash"></i></button></div></div>`;
    });
    document.getElementById('k-pecas').innerHTML = c.pecas; document.getElementById('k-pgto').innerHTML = c.pgto; document.getElementById('k-retirado').innerHTML = c.retirado;
}
window.delOS = async function(id) { abrirModalSenha(async () => { document.getElementById('modal-overlay').style.display='none'; if(confirm("EXCLUIR OS?")) await deleteDoc(doc(db, "os_ativa", id)); }); }
window.moveOS = async function(id, dir) { const o = window.db.os.find(i=>i.id===id); const idx = ['pecas', 'pgto', 'retirado'].indexOf(o.status) + dir; await updateDoc(doc(db,"os_ativa",id), {status: ['pecas', 'pgto', 'retirado'][idx]}); }

window.arqOS = async function(id) {
    if(!confirm("Arquivar?")) return; const o = window.db.os.find(i=>i.id===id);
    // SALVAR NO HISTORICO
    await setDoc(doc(db, "os_historico", id), o);
    
    // GERAR LOG FINANCEIRO
    if(o.itens && o.itens.length>0) { 
        for(let i of o.itens) {
            let tipoLog = 'SERVICO';
            if (i.tipo === 'P' || i.tipo === 'PRODUTO') { tipoLog = 'PRODUTO'; } else if (i.tipo === 'S' || i.tipo === 'SERVICO') { tipoLog = 'SERVICO'; } else { const isProdName = window.db.produtos.some(p => p.nome === i.nome); tipoLog = isProdName ? 'PRODUTO' : 'SERVICO'; }
            await addDoc(collection(db,"logs"), {tipo: tipoLog, desc: i.nome, valor: i.val, qtd: i.qtd||1, garantia: i.garantia, cliente: o.cliente, data: new Date().toISOString()}); 
        } 
    } else { await addDoc(collection(db,"logs"), {tipo:'SERVICO', desc: 'OS: '+o.modelo, valor: o.valor, qtd: 1, cliente: o.cliente, data: new Date().toISOString()}); }
    if(o.desconto>0) await addDoc(collection(db,"logs"), {tipo:'DESCONTO', desc: 'DESCONTO OS', valor: -o.desconto, cliente: o.cliente, data: new Date().toISOString()});
    
    await deleteDoc(doc(db,"os_ativa",id));
}

window.verHistoricoOS = function() {
    let html = '';
    if(window.db.os_hist.length === 0) html = '<div style="padding:20px;text-align:center;color:#999">VAZIO</div>';
    else {
        html = window.db.os_hist.map(o => {
            return `<div class="fin-item" style="background:white; border-left-color:#666">
                <div class="fin-date">${new Date(o.data).toLocaleDateString()} - #${o.num||'S/N'}</div>
                <b>${o.cliente}</b> - ${o.modelo}<br>
                R$ ${o.valor.toFixed(2)}
                <button class="btn-mini blue" style="margin-top:5px; width:100%" onclick="reabrirOS('${o.id}')">REABRIR (CORRIGIR)</button>
            </div>`;
        }).join('');
    }
    document.getElementById('ext-nome').innerText = "HIST√ìRICO OS";
    document.getElementById('ext-lista').innerHTML = html;
    document.getElementById('ext-share-area').style.display = 'none';
    document.getElementById('modal-extrato').style.display = 'flex';
}

window.reabrirOS = async function(id) {
    if(!confirm("REABRIR OS?\n\nEla voltar√° para o status 'PRONTO' para corre√ß√µes.")) return;
    const o = window.db.os_hist.find(x => x.id === id);
    if(o) {
        o.status = 'retirado'; // Define como Pronto/Retirado
        await setDoc(doc(db, "os_ativa", id), o);
        await deleteDoc(doc(db, "os_historico", id));
        alert("OS REABERTA E PRONTA PARA CORRE√á√ÉO!");
        document.getElementById('modal-extrato').style.display = 'none';
    }
}

window.editOS = function(id) {
    const o = window.db.os.find(i=>i.id===id); document.getElementById('os-id').value=id; document.getElementById('s-cli').value=o.cliente; document.getElementById('s-mod').value=o.modelo; document.getElementById('os-status-orig').value = o.status;
    document.getElementById('s-def').value=o.defeito; document.getElementById('s-senha').value=o.senha; document.getElementById('s-desc').value = o.desconto || '';
    window.carrinhoOS = (o.itens && Array.isArray(o.itens)) ? o.itens : (o.valor>0?[{nome: 'Servi√ßo Antigo', val: o.valor, qtd: 1, garantia: '90 DIAS', tipo:'S'}]:[]);
    renderItemsOS(); window.osFotos = o.fotos || [null, null, null, null];
    const slots = document.querySelectorAll('.os-foto-slot'); window.osFotos.forEach((f, i) => { if(f) slots[i].innerHTML = `<img src="${f}">`; else slots[i].innerHTML = `<i class="fas fa-camera"></i>`; });
    document.getElementById('page-servicos').scrollIntoView();
}
window.shareOS = function(id) {
    const o = window.db.os.find(i=>i.id===id); const it = (o.itens && o.itens.length) ? o.itens : [{nome:o.modelo, val:o.valor, qtd:1, garantia:'90 DIAS'}];
    const sub = it.reduce((a,b)=>a+b.val,0); const desc = o.desconto || 0; const numDisplay = o.num ? `N¬∫ ${o.num}` : 'S/N';
    window.shareData={ tipo:'OS '+numDisplay, cliente:o.cliente, itens: it, subtotal: sub, desconto: desc, total: o.valor, obs: o.defeito, senha: o.senha, fotos: o.fotos || [] };
    abrirModalShare();
}
window.maskTel = function(o) { let v = o.value.replace(/\D/g,""); if(v.length > 11) v = v.substring(0,11); if(v.length >= 2) v = "(" + v.substring(0,2) + ") " + v.substring(2); if(v.length >= 7) v = v.substring(0,10) + "-" + v.substring(10); o.value = v; }

window.salvarCliente = async function() {
    const id = document.getElementById('c-id').value; const d = { nome: document.getElementById('c-nome').value.toUpperCase(), tel: document.getElementById('c-tel').value, bairro: document.getElementById('c-bairro').value.toUpperCase(), cidade: document.getElementById('c-cidade').value.toUpperCase(), foto: window.tempImg||'' };
    if(id) await updateDoc(doc(db,"clientes",id), d); else await addDoc(collection(db,"clientes"), d);
    limparCli();
    if(window.retornoVenda) { window.retornoVenda=false; window.nav('vendas'); document.getElementById('v-cli').value=d.nome; }
    else if(window.retornoOS) { window.retornoOS=false; window.nav('servicos'); document.getElementById('s-cli').value=d.nome; }
}
window.listarCli = function() { document.getElementById('lista-clientes').innerHTML = window.db.clientes.map(renderCliCard).join(''); }
window.limparCli = function() { document.getElementById('c-id').value = ''; document.getElementById('c-nome').value = ''; document.getElementById('c-tel').value = ''; document.getElementById('c-bairro').value = ''; document.getElementById('c-cidade').value = ''; window.tempImg = null; document.getElementById('c-foto-view').src = ''; document.getElementById('c-foto-view').classList.remove('has-img'); }
function renderCliCard(c) {
    const zap = c.tel ? `https://wa.me/55${c.tel.replace(/\D/g,'')}` : '#';
    // Bot√µes reduzidos inline
    return `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center"><div style="display:flex; gap:10px; align-items:center">${c.foto?`<img src="${c.foto}" style="width:40px;height:40px;border-radius:50%">`:`<div style="width:40px;height:40px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center"><i class="fas fa-user"></i></div>`}<div><b>${c.nome}</b><br><span style="font-size:11px">${c.tel}</span><div style="font-size:9px; color:#666; font-weight:bold">${c.bairro||''} ${c.cidade?'- '+c.cidade:''}</div></div></div><div class="actions-row" style="width:auto; gap:5px; justify-content:flex-end">${c.tel?`<a href="${zap}" target="_blank" class="btn-mini zap" style="padding:5px; font-size:12px; width:30px; flex:none"><i class="fab fa-whatsapp"></i></a>`:''} <button class="btn-mini blue" style="padding:5px; font-size:12px; width:30px; flex:none" onclick="edtCli('${c.id}')"><i class="fas fa-pen"></i></button> <button class="btn-mini red" style="padding:5px; font-size:12px; width:30px; flex:none" onclick="del('clientes','${c.id}')"><i class="fas fa-trash"></i></button></div></div>`;
}
window.edtCli = function(id) { const c=window.db.clientes.find(i=>i.id===id); document.getElementById('c-id').value=id; document.getElementById('c-nome').value=c.nome; document.getElementById('c-tel').value=c.tel; document.getElementById('c-bairro').value=c.bairro||''; document.getElementById('c-cidade').value=c.cidade||''; window.tempImg=c.foto; const view=document.getElementById('c-foto-view'); view.src=c.foto||''; if(c.foto) view.classList.add('has-img'); else view.classList.remove('has-img'); document.getElementById('form-cli').scrollIntoView(); }

// FUN√á√ïES DE D√çVIDAS
window.abrirCarteiraDevedores = function() {
    // Agrupa por cliente
    const devedores = {};
    window.db.dividas.forEach(d => {
        if(d.restante > 0.01) {
            if(!devedores[d.cliente]) devedores[d.cliente] = 0;
            devedores[d.cliente] += d.restante;
        }
    });

    const lista = Object.entries(devedores).sort((a,b)=>b[1]-a[1]);
    let html = '';
    
    if(lista.length === 0) html = '<div style="text-align:center; padding:20px; color:#999">NINGU√âM DEVENDO!</div>';
    else {
        html = lista.map(([nome, total]) => {
            return `<div class="fin-item" style="display:flex; justify-content:space-between; align-items:center; background:white; border-left-color:red">
                <div>
                    <b>${nome}</b><br>
                    <span style="color:red; font-weight:bold">R$ ${total.toFixed(2)}</span>
                </div>
                <button class="btn-mini green" style="max-width:50px" onclick="gerenciarDividas('${nome}')"><i class="fas fa-eye"></i></button>
            </div>`;
        }).join('');
    }

    document.getElementById('ext-nome').innerText = "CARTEIRA DE DEVEDORES";
    document.getElementById('ext-lista').innerHTML = html;
    document.getElementById('ext-share-area').style.display = 'none';
    document.getElementById('ext-preview-box').style.display = 'none'; // Esconde preview extrato
    document.getElementById('modal-extrato').style.display = 'flex';
}

window.gerenciarDividas = function(nome) {
    const dividas = window.db.dividas.filter(d => d.cliente === nome && d.restante > 0.01).sort((a,b)=>new Date(a.data_venda)-new Date(b.data_venda));
    let html = '';
    if(dividas.length === 0) html = '<div style="text-align:center; padding:20px; color:#999">NENHUM D√âBITO PENDENTE</div>';
    else {
        html = dividas.map(d => {
            const date = new Date(d.data_venda).toLocaleDateString('pt-BR');
            // FIX DATA: Tratar data_lembrete como string para evitar fuso hor√°rio
            const dataLembretePt = d.data_lembrete ? d.data_lembrete.split('-').reverse().join('/') : '';
            const lembrete = dataLembretePt ? `<span style="color:red"><i class="fas fa-bell"></i> ${dataLembretePt}</span>` : '';
            return `<div class="fin-item">
                <div class="fin-date">${date} - ${d.itens}</div>
                <div style="display:flex; justify-content:space-between">
                    <div>TOTAL: R$ ${d.valor_total.toFixed(2)}<br>PAGO: R$ ${d.valor_pago.toFixed(2)}</div>
                    <div style="text-align:right">
                        <div class="fin-val">RESTANTE: R$ ${d.restante.toFixed(2)}</div>
                        ${lembrete}
                    </div>
                </div>
                <div class="actions-row" style="margin-top:10px">
                    <button class="btn-mini green" onclick="abaterDivida('${d.id}', '${nome}', ${d.restante})">PAGAR</button>
                    <button class="btn-mini blue" onclick="agendarLembrete('${d.id}', '${nome}', '${dataLembretePt}')">LEMBRETE</button>
                </div>
            </div>`;
        }).join('');
    }
    document.getElementById('ext-nome').innerText = "FINANCEIRO: " + nome;
    document.getElementById('ext-lista').innerHTML = html;
    document.getElementById('ext-share-area').style.display = 'none';
    document.getElementById('ext-preview-box').style.display = 'none'; // Esconde preview extrato
    document.getElementById('modal-extrato').style.display = 'flex';
}

// MASCARAS
window.maskMoney = function(o) {
    let v = o.value.replace(/\D/g, "");
    v = (v/100).toFixed(2) + "";
    v = v.replace(".", ",");
    v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    o.value = v;
}

window.maskDate = function(o) {
    let v = o.value.replace(/\D/g, "").slice(0,8);
    if (v.length > 4) v = v.slice(0,2) + '-' + v.slice(2,4) + '-' + v.slice(4);
    else if (v.length > 2) v = v.slice(0,2) + '-' + v.slice(2);
    o.value = v;
}

window.abaterDivida = function(id, nome, max) {
    document.getElementById('modal-extrato').style.display = 'none'; // Fecha lista
    document.getElementById('modal-overlay').style.display = 'flex'; // Abre a√ß√£o
    document.getElementById('modal-content-default').innerHTML = `
        <h3 style="justify-content:center">PAGAR D√çVIDA</h3>
        <div style="font-size:12px; margin-bottom:10px">${nome}</div>
        <div style="color:red; font-weight:bold; font-size:10px; margin-bottom:5px">RESTANTE: R$ ${max.toFixed(2)}</div>
        <input type="tel" id="input-pagar-val" placeholder="0,00" oninput="maskMoney(this)" style="font-size:24px; text-align:center; font-weight:bold; color:#2e7d32">
        <button class="btn btn-primary" onclick="confirmarAbater('${id}', '${nome}', ${max})">CONFIRMAR</button>
        <button class="btn" style="background:#666; margin-top:5px" onclick="fecharModal({target:{id:'modal-overlay'}})">CANCELAR</button>
    `;
    setTimeout(()=>document.getElementById('input-pagar-val').focus(),100);
}

window.confirmarAbater = async function(id, nome, max) {
    const raw = document.getElementById('input-pagar-val').value;
    const val = parseFloat(raw.replace(/\./g,'').replace(',','.'));
    if(!val || val <= 0 || val > max) return alert("Valor inv√°lido");

    const div = window.db.dividas.find(d => d.id === id);
    const novoPago = div.valor_pago + val;
    const novoRestante = div.restante - val;
    await updateDoc(doc(db,"dividas",id), { valor_pago: novoPago, restante: novoRestante });
    await addDoc(collection(db,"logs"), { tipo: 'PAGAMENTO D√çVIDA', desc: 'ABATIMENTO: '+nome, valor: val, qtd: 1, cliente: nome, data: new Date().toISOString() });
    
    alert("PAGAMENTO REGISTRADO!");
    document.getElementById('modal-overlay').style.display='none';
    gerenciarDividas(nome); // Reabre lista atualizada
}

window.agendarLembrete = function(id, nome, dataAtual='') {
    document.getElementById('modal-extrato').style.display = 'none'; // Fecha lista
    document.getElementById('modal-overlay').style.display = 'flex'; // Abre a√ß√£o
    
    // Define se √© novo ou edi√ß√£o
    const titulo = dataAtual ? "EDITAR LEMBRETE" : "NOVO LEMBRETE";
    const valorInicial = dataAtual ? `value="${dataAtual}"` : "";

    document.getElementById('modal-content-default').innerHTML = `
        <h3 style="justify-content:center">${titulo}</h3>
        <div style="font-size:12px; margin-bottom:10px">${nome}</div>
        <input type="tel" id="input-lembrete-date" ${valorInicial} placeholder="DD-MM-AAAA" oninput="maskDate(this)" maxlength="10" style="font-size:20px; text-align:center; font-weight:bold">
        <div style="font-size:9px; color:#666; margin-top:5px"><i class="fas fa-clock"></i> Hor√°rio padr√£o: 09:00 e 13:00</div>
        <button class="btn btn-primary" onclick="confirmarLembrete('${id}', '${nome}')">SALVAR</button>
        <button class="btn" style="background:#666; margin-top:5px" onclick="fecharModal({target:{id:'modal-overlay'}})">CANCELAR</button>
    `;
    setTimeout(()=>document.getElementById('input-lembrete-date').focus(),100);
}

window.confirmarLembrete = async function(id, nome) {
    const raw = document.getElementById('input-lembrete-date').value; // DD-MM-AAAA
    if(raw.length !== 10) return alert("Data inv√°lida");
    // Converter para ISO AAAA-MM-DD
    const parts = raw.split('-');
    const iso = `${parts[2]}-${parts[1]}-${parts[0]}`;
    
    await updateDoc(doc(db,"dividas",id), { data_lembrete: iso });
    alert("LEMBRETE DEFINIDO!");
    document.getElementById('modal-overlay').style.display='none';
    gerenciarDividas(nome); // Reabre lista atualizada
}

window.salvarProduto = async function(t) {
    const nome = document.getElementById('p-nome').value.toUpperCase(); 
    if(!nome) return alert("NOME OBRIGAT√ìRIO");
    const col = t==='prod'?'produtos':'servicos_cad';
    const d = { nome: nome, precoVenda: parseFloat(document.getElementById('p-venda').value||0), qtd: document.getElementById('p-qtd').value, custo: document.getElementById('p-custo').value, foto: window.tempImg||'' };
    const id = document.getElementById('p-id').value;
    if(id) await updateDoc(doc(db,col,id), d); else await addDoc(collection(db,col), d);
    limparEstoque();
}
window.limparEstoque = function() { document.getElementById('p-id').value = ''; document.getElementById('p-nome').value = ''; document.getElementById('p-venda').value = ''; document.getElementById('p-qtd').value = ''; document.getElementById('p-custo').value = ''; window.tempImg = null; document.getElementById('p-foto-view').src = ''; document.getElementById('p-foto-view').classList.remove('has-img'); }
window.listarEstoque = function(t) {
    const l = t==='prod'?window.db.produtos:window.db.servicos; const col=t==='prod'?'produtos':'servicos_cad';
    document.getElementById('lista-estoque').innerHTML = l.map(i => `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center"><div style="display:flex;gap:10px;align-items:center">${i.foto?`<img src="${i.foto}" style="width:40px;height:40px;border-radius:50%">`:`<div style="width:40px;height:40px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center"><i class="fas fa-box"></i></div>`}<div><b>${i.nome}</b><br>R$ ${i.precoVenda}</div></div><div class="actions-row" style="width:auto; gap:5px"><button class="btn-mini blue" onclick="edtProd('${col}','${i.id}')"><i class="fas fa-pen"></i></button> <button class="btn-mini red" onclick="del('${col}','${i.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('');
}
window.edtProd = function(col, id) { const i=(col=='produtos'?window.db.produtos:window.db.servicos).find(x=>x.id===id); document.getElementById('p-id').value=id; document.getElementById('p-nome').value=i.nome; document.getElementById('p-venda').value=i.precoVenda; document.getElementById('p-qtd').value=i.qtd||''; document.getElementById('p-custo').value=i.custo||''; document.getElementById('p-custo').type='password'; document.getElementById('btn-ver-custo').style.display='block'; window.tempImg=i.foto; const view=document.getElementById('p-foto-view'); view.src=i.foto||''; if(i.foto) view.classList.add('has-img'); else view.classList.remove('has-img'); document.getElementById('page-estoque').querySelector('.card').scrollIntoView(); }
window.revelarCusto = function() { abrirModalSenha(() => { document.getElementById('modal-overlay').style.display='none'; document.getElementById('p-custo').type = 'number'; document.getElementById('btn-ver-custo').style.display = 'none'; }); }

window.togglePriv = function() {
    window.verValores = !window.verValores;
    const ico = document.getElementById('eye-rel');
    if(window.verValores) { ico.classList.remove('fa-eye'); ico.classList.add('fa-eye-slash'); ico.classList.add('fa-eye'); }
    else { ico.classList.remove('fa-eye-slash'); ico.classList.add('fa-eye'); }
    renderRelatorio();
}

window.renderRelatorio = function() {
    const f = document.getElementById('r-filtro').value; const now = new Date(); const searchTxt = document.getElementById('r-search').value.toUpperCase(); 
    const logsFiltrados = window.db.logs.filter(l => {
        const d = new Date(l.data); let matchDate = false;
        if(f=='dia') matchDate = d.toDateString()===now.toDateString(); else if(f=='semana') matchDate = (now-d) < 604800000; else if(f=='mes') matchDate = d.getMonth()===now.getMonth(); else matchDate = d.getFullYear()===now.getFullYear();
        let matchText = true; if(searchTxt) { matchText = (l.cliente && l.cliente.toUpperCase().includes(searchTxt)); }
        return matchDate && matchText;
    });
    
    // CALCULOS
    let totalGeral = 0;
    let lucroGeral = 0;
    const clientesMap = {}; 

    logsFiltrados.forEach(l => {
        totalGeral += l.valor; 
        
        let custoItem = 0;
        if(l.tipo === 'PRODUTO' || l.tipo === 'P') {
            const prod = window.db.produtos.find(p => p.nome === l.desc);
            if(prod && prod.custo) custoItem = parseFloat(prod.custo) * (l.qtd || 1);
        }
        lucroGeral += (l.valor - custoItem);

        if(!clientesMap[l.cliente]) { clientesMap[l.cliente] = { nome: l.cliente, total: 0, count: 0 }; }
        clientesMap[l.cliente].total += l.valor; clientesMap[l.cliente].count++;
    });

    const clientesArray = Object.values(clientesMap).sort((a,b) => b.total - a.total);
    document.getElementById('r-hist').innerHTML = clientesArray.map(c => `<div style="padding:10px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center"><div style="font-size:10px"><b>${c.nome}</b><br><span style="color:#777">${c.count} mov.</span></div><div style="text-align:right"><b style="color:var(--primary); font-size:11px">R$ ${c.total.toFixed(2)}</b><br><div class="actions-row" style="justify-content:flex-end"><button class="btn-mini green" onclick="abrirExtratoCliente('${c.nome}')"><i class="fas fa-eye"></i></button> <button class="btn-mini blue" onclick="abrirOpcoesEdicao('${c.nome}')"><i class="fas fa-pen"></i></button></div></div></div>`).join('');
    if(clientesArray.length === 0) document.getElementById('r-hist').innerHTML = '<div style="text-align:center; padding:20px; color:#ccc">NENHUM DADO ENCONTRADO</div>';
    
    document.getElementById('r-total').innerText = window.verValores ? "R$ " + totalGeral.toFixed(2) : "****";
    document.getElementById('r-lucro').innerText = window.verValores ? "R$ " + lucroGeral.toFixed(2) : "****";
    
    const rank = (k, d) => {
        const c={}; 
        window.db.logs.forEach(i => { 
            const isProd = (i.tipo === 'PRODUTO' || i.tipo === 'P'); 
            const isServ = (i.tipo === 'SERVICO' || i.tipo === 'S'); 
            const qtd = i.qtd || 1;
            if(k === 'CLI') { const n = i.cliente; c[n] = (c[n]||0) + 1; }
            else if(k === 'PROD' && isProd) { const n = i.desc; c[n] = (c[n]||0) + qtd; }
            else if(k === 'SERV' && isServ) { const n = i.desc; c[n] = (c[n]||0) + qtd; }
        });
        document.getElementById(d).innerHTML = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`<div class="rank-item"><span>${x[0]}</span><b>${x[1]}</b></div>`).join('');
    }
    rank('CLI','rank-cli'); rank('PROD','rank-prod'); rank('SERV','rank-serv');
}

window.abrirOpcoesEdicao = function(nome) { document.getElementById('modal-overlay').style.display = 'flex'; document.getElementById('modal-content-default').innerHTML = `<h3 style="justify-content:center">EDITAR</h3><div style="font-size:11px; text-align:center; margin-bottom:12px; font-weight:bold; color:var(--primary)">${nome}</div><button class="btn btn-primary" onclick="editarClienteRapido('${nome}')"><i class="fas fa-user-edit"></i> DADOS CLIENTE</button><button class="btn btn-dark" style="margin-top:10px" onclick="editarMovimentacaoCliente('${nome}')"><i class="fas fa-list-ul"></i> MOVIMENTA√á√ïES</button><button class="btn" style="background:#666; margin-top:10px" onclick="fecharModal({target:{id:'modal-overlay'}})">CANCELAR</button>`; }
window.editarClienteRapido = function(nome) { fecharModal({target:{id:'modal-overlay'}}); const cli = window.db.clientes.find(c => c.nome === nome); if(cli) { window.nav('clientes'); window.edtCli(cli.id); } else { if(confirm("Cliente n√£o encontrado. Cadastrar?")) { window.nav('clientes'); document.getElementById('c-nome').value = nome; } } }

window.editarMovimentacaoCliente = function(nome) {
    fecharModal({target:{id:'modal-overlay'}});
    const logs = window.db.logs.filter(l => l.cliente === nome).sort((a,b) => new Date(b.data) - new Date(a.data));
    let html = `<div style="padding:10px; background:#ffebee; border-bottom:1px solid #d32f2f; text-align:center; color:#d32f2f; font-weight:bold; font-size:10px">
                    <button id="btn-del-sel" class="btn" style="background:#d32f2f; padding:8px; display:none; margin-bottom:10px" onclick="excluirSelecionados('${nome}')"><i class="fas fa-trash"></i> EXCLUIR SELECIONADOS</button>
                    CLIQUE NO L√ÅPIS PARA EDITAR DATA
                </div>`;
    logs.forEach(i => {
         const dataVal = i.data.split('T')[0];
         html += `<div style="background:white; padding:8px; border-bottom:1px solid #eee; display:flex; align-items:center;">
            <input type="checkbox" class="check-log" value="${i.id}" onchange="toggleBtnDelete()">
            <div style="flex:1">
                <div id="date-display-${i.id}" style="display:flex; align-items:center; gap:5px; font-size:9px; color:#555">
                    <span>${new Date(i.data).toLocaleDateString('pt-BR')}</span>
                    <i class="fas fa-pencil-alt" style="cursor:pointer; color:orange" onclick="toggleEditDate('${i.id}')"></i>
                </div>
                <div id="date-edit-${i.id}" style="display:none; align-items:center; gap:5px;">
                    <input type="date" id="input-date-${i.id}" value="${dataVal}" style="font-size:9px; padding:2px; width:auto">
                    <i class="fas fa-check-circle" style="cursor:pointer; color:green; font-size:12px" onclick="saveNewDate('${i.id}', '${nome}')"></i>
                </div>
                <b style="font-size:10px">${i.desc}</b>
            </div>
            <div style="text-align:right">
                <b style="font-size:10px">R$ ${i.valor.toFixed(2)}</b><br>
                <div class="actions-row" style="width:auto; gap:5px">
                    <button class="btn-mini blue" onclick="refazerVendaLog('${i.id}', '${i.desc}', ${i.valor})"><i class="fas fa-undo"></i> REFAZER</button>
                </div>
            </div>
         </div>`;
    });
    document.getElementById('ext-nome').innerText = "EDITAR: " + nome; 
    document.getElementById('ext-lista').innerHTML = html; 
    document.getElementById('ext-share-area').style.display = 'none'; 
    document.getElementById('ext-preview-box').style.display = 'none'; 
    document.getElementById('modal-extrato').style.display = 'flex';
}

window.refazerVendaLog = function(id, desc, val) {
    if(!confirm("REABRIR ESTA VENDA?\n\nIsso adicionar√° o item ao carrinho de vendas para voc√™ corrigir.\n\nDepois voc√™ pode excluir este registro antigo se quiser.")) return;
    document.getElementById('modal-extrato').style.display = 'none';
    const tipo = (val < 0) ? 'D' : 'P'; // Se negativo √© desconto, se nao produto
    if(tipo === 'D') document.getElementById('v-desc').value = Math.abs(val);
    else window.addCar('REOPEN', 'P', desc, val);
    window.nav('vendas');
}

window.toggleBtnDelete = function() {
    const checked = document.querySelectorAll('.check-log:checked');
    document.getElementById('btn-del-sel').style.display = checked.length > 0 ? 'block' : 'none';
}

window.excluirSelecionados = async function(nome) {
    const checked = document.querySelectorAll('.check-log:checked');
    if(!confirm(`Excluir ${checked.length} itens selecionados?`)) return;
    for(const cb of checked) { await deleteDoc(doc(db, "logs", cb.value)); }
    alert("Exclu√≠dos!");
    window.editarMovimentacaoCliente(nome); 
}

window.toggleEditDate = function(id) { document.getElementById(`date-display-${id}`).style.display='none'; document.getElementById(`date-edit-${id}`).style.display='flex'; }
window.saveNewDate = async function(id, nome) { 
    const nova = document.getElementById(`input-date-${id}`).value; 
    if(nova){ 
        await updateDoc(doc(db,"logs",id), { data: new Date(nova).toISOString() }); 
        alert("DATA ATUALIZADA!"); renderRelatorio(); window.editarMovimentacaoCliente(nome); 
    } 
}

window.delLog = async function(id) { 
    if(!confirm("Excluir este lan√ßamento permanentemente?")) return;
    await deleteDoc(doc(db, "logs", id)); 
    alert("Exclu√≠do!"); 
    document.getElementById('modal-extrato').style.display='none'; 
    renderRelatorio(); 
}

window.abrirExtratoCliente = function(nome) {
    const logs = window.db.logs.filter(l => l.cliente === nome).sort((a,b) => new Date(b.data) - new Date(a.data));
    const porData = {}; let totalExtrato = 0;
    logs.forEach(l => { const dStr = new Date(l.data).toLocaleDateString('pt-BR'); if(!porData[dStr]) porData[dStr] = []; porData[dStr].push(l); totalExtrato += l.valor; });
    let html = '';
    for (const [data, itens] of Object.entries(porData)) {
        html += `<div style="margin-bottom:12px; background:white; padding:8px; border-radius:8px; border:1px solid #eee"><div style="font-weight:bold; color:var(--primary); font-size:10px; border-bottom:1px solid #eee; padding-bottom:4px; margin-bottom:4px"><i class="far fa-calendar-alt"></i> ${data}</div>`;
        let subDia = 0;
        itens.forEach(i => {
            subDia += i.valor; const isDesc = (i.tipo === 'DESCONTO'); const color = isDesc ? 'color:red' : 'color:black'; 
            const qtdTxt = (!isDesc && (i.qtd > 1 || i.qtd === 1)) ? `<b>${i.qtd||1}x</b> ` : '';
            html += `<div style="display:flex; justify-content:space-between; font-size:9px; margin-bottom:2px; ${color}"><span>${qtdTxt}${i.desc}</span><span style="font-weight:bold">${i.valor < 0 ? '' : 'R$ '}${i.valor.toFixed(2)}</span></div>`;
        });
        html += `<div style="text-align:right; font-size:9px; font-weight:900; color:#555; margin-top:4px; border-top:1px dashed #ccc; padding-top:2px">TOTAL DIA: R$ ${subDia.toFixed(2)}</div></div>`;
    }
    window.extratoAtual = { cliente: nome, html: html, dados: porData, total: totalExtrato };
    document.getElementById('ext-nome').innerText = nome; 
    document.getElementById('ext-lista').innerHTML = html + `<div style="text-align:center; font-size:16px; font-weight:900; margin-top:15px; color:var(--primary)">TOTAL GERAL: R$ ${totalExtrato.toFixed(2)}</div>`;
    
    // PREVIEW DO EXTRATO
    let prevHtml = `<div style="text-align:center; font-weight:bold; border-bottom:1px dashed #000; margin-bottom:5px">${EMPRESA.nome}<br>EXTRATO</div>`;
    prevHtml += html.replace(/background:white/g, "background:none").replace(/border:1px solid #eee/g, "border:none");
    prevHtml += `<div style="text-align:right; font-weight:bold; margin-top:10px; border-top:1px dashed #000">TOTAL: R$ ${totalExtrato.toFixed(2)}</div>`;
    document.getElementById('ext-preview-box').innerHTML = prevHtml;
    document.getElementById('ext-preview-box').style.display = 'block';

    document.getElementById('ext-share-area').style.display = 'flex'; 
    document.getElementById('modal-extrato').style.display = 'flex';
}

window.montarHtmlCupom = function(d) {
    let html = `<div style="font-family:'Courier New', monospace; text-align:center; width:380px; margin:0 auto; background:white; color:black; padding:10px; border:1px solid #fff">
        <div style="font-weight:bold; font-size:18px; margin-bottom:5px">${EMPRESA.nome}</div>
        <div style="font-size:12px">${EMPRESA.end}</div>
        <div style="font-size:12px">${EMPRESA.cid}</div>
        <div style="font-size:12px">CNPJ: ${EMPRESA.cnpj}</div>
        <div style="font-size:12px">Tel: ${EMPRESA.tel}</div>
        <div style="border-bottom:1px dashed #000; margin:5px 0"></div>
        <div style="font-size:12px; font-weight:bold">${d.tipo}</div>
        <div style="font-size:12px">${new Date().toLocaleString()}</div>
        <div style="font-size:12px">CLI: ${d.cliente || 'CONSUMIDOR'}</div>
        <div style="border-bottom:1px dashed #000; margin:5px 0"></div>
        <table style="width:100%; font-size:12px; text-align:left">
            <thead><tr><th>QTD</th><th>ITEM</th><th style="text-align:right">R$</th></tr></thead>
            <tbody>
                ${d.itens.map(i => `<tr><td style="vertical-align:top">${i.qtd||1}x</td><td>${i.nome}<br><small>GAR: ${i.garantia||'--'}</small></td><td style="text-align:right; vertical-align:top">${i.val.toFixed(2)}</td></tr>`).join('')}
            </tbody>
        </table>
        <div style="border-bottom:1px dashed #000; margin:5px 0"></div>
        <div style="display:flex; justify-content:space-between; font-size:14px"><span>SUBTOTAL:</span><span>R$ ${d.subtotal.toFixed(2)}</span></div>`;
    if(d.desconto > 0) html += `<div style="display:flex; justify-content:space-between; font-size:14px"><span>DESCONTO:</span><span>- R$ ${d.desconto.toFixed(2)}</span></div>`;
    html += `<div style="font-size:18px; font-weight:bold; margin-top:5px; text-align:right">TOTAL: R$ ${d.total.toFixed(2)}</div>`;
    if(d.obs) html += `<div style="margin-top:5px; text-align:left; font-size:12px; border:1px solid #000; padding:2px"><b>OBS:</b> ${d.obs}</div>`;
    html += `<div style="margin-top:40px; border-top:1px solid #000; width:80%; margin-left:auto; margin-right:auto"></div>
             <div style="font-size:10px; text-align:center">ASSINATURA DO CLIENTE</div>
             <div style="margin-top:10px; font-size:10px; text-align:center">OBRIGADO PELA PREFER√äNCIA!</div>
    </div>`;
    return html;
}

window.abrirModalShare = function() {
    const d = window.shareData;
    const htmlCupom = montarHtmlCupom(d);
    
    document.getElementById('modal-content-default').innerHTML = `
        <h3 style="justify-content:center">COMPROVANTE</h3>
        <div id="cupom-preview" style="background:white; border:1px solid #ccc; margin-bottom:10px; max-height:300px; overflow-y:auto; overflow-x:hidden; display:flex; justify-content:center">
            ${htmlCupom}
        </div>
        <button class="btn" style="background:#25d366; margin-top:5px" onclick="acaoShare('zap')"><i class="fab fa-whatsapp"></i> WHATSAPP</button>
        <button class="btn" style="background:#0277bd; margin-top:5px" onclick="acaoShare('bluetooth')"><i class="fab fa-bluetooth"></i> BLUETOOTH (RAWBT)</button>
        <button class="btn" style="background:#666; margin-top:5px" onclick="fecharModal({target:{id:'modal-overlay'}})">FECHAR</button>
    `; 
    document.getElementById('modal-overlay').style.display='flex'; 
}

window.acaoShare = function(tipo) {
    const d = window.shareData; 
    
    // ZAP
    if(tipo=='zap') { 
        document.getElementById('modal-overlay').style.display='none';
        let txt = `*${EMPRESA.nome}*\n*${d.tipo}*\nDATA: ${new Date().toLocaleString()}\nCLI: ${d.cliente||'Consumidor'}\n----------------\n` + d.itens.map(i=>`${i.qtd||1}x ${i.nome} ... R$ ${i.val.toFixed(2)} ${i.garantia?'('+i.garantia+')':''}`).join('\n') + `\n----------------\n`;
        if(d.desconto > 0) txt += `SUBTOTAL: R$ ${d.subtotal.toFixed(2)}\nDESCONTO: -R$ ${d.desconto.toFixed(2)}\n`; txt += `*TOTAL FINAL: R$ ${d.total.toFixed(2)}*`; if(d.obs) txt += `\nOBS: ${d.obs}`;
        const cliName = d.cliente || '';
        const cliObj = window.db.clientes.find(c => c.nome.toUpperCase() === cliName.toUpperCase());
        let phone = ''; if(cliObj && cliObj.tel) phone = cliObj.tel.replace(/\D/g, '');
        let urlZap = `whatsapp://send?text=${encodeURIComponent(txt)}`; 
        if(phone.length >= 10) urlZap = `whatsapp://send?phone=55${phone}&text=${encodeURIComponent(txt)}`; 
        window.location.href = urlZap; 
    }
    // BLUETOOTH (RAWBT) - VIA IMAGEM
    if(tipo=='bluetooth') {
        // Usa o html2canvas para converter o DIV do cupom em uma imagem PNG base64
        // Pega o primeiro filho do preview box que √© o container principal do cupom
        const element = document.getElementById('cupom-preview').firstElementChild;
        
        html2canvas(element, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            const imgData = canvas.toDataURL('image/png').split(',')[1]; 
            // Envia para RawBT como imagem base64
            const rawbtUrl = 'rawbt:base64,' + imgData;
            window.location.href = rawbtUrl;
            document.getElementById('modal-overlay').style.display='none';
        }).catch(err => {
            alert("Erro ao gerar imagem para impress√£o: " + err);
        });
    }
}

window.shareExtrato = function(tipo) {
    if(!window.extratoAtual) return; const d = window.extratoAtual;
    if(tipo === 'zap') document.getElementById('modal-extrato').style.display='none';
    
    if(tipo === 'zap') {
        let txt = `*EXTRATO - ${EMPRESA.nome}*\nCLI: ${d.cliente}\n\n`;
        for (const [data, itens] of Object.entries(d.dados)) {
            txt += `*${data}*\n`;
            itens.forEach(i => { const qtd = (i.qtd > 1 && i.tipo !== 'DESCONTO') ? `${i.qtd}x ` : ''; txt += `- ${qtd}${i.desc}: R$ ${i.valor.toFixed(2)}\n`; });
            txt += `\n`;
        }
        txt += `*TOTAL GERAL: R$ ${d.total.toFixed(2)}*`;
        const cliObj = window.db.clientes.find(c => c.nome.toUpperCase() === d.cliente.toUpperCase());
        let phone = ''; if(cliObj && cliObj.tel) phone = cliObj.tel.replace(/\D/g, '');
        let urlZap = `whatsapp://send?text=${encodeURIComponent(txt)}`;
        if(phone.length >= 10) urlZap = `whatsapp://send?phone=55${phone}&text=${encodeURIComponent(txt)}`;
        window.location.href = urlZap;
    } 
    else if(tipo === 'bluetooth') {
        // Tenta imprimir o extrato como texto simples pois pode ser muito longo para imagem
        let btTxt = `${EMPRESA.nome}%0AEXTRATO DE CLIENTE%0ACLIENTE: ${d.cliente}%0A--------------------------------%0A`;
        for (const [data, itens] of Object.entries(d.dados)) {
            btTxt += `[${data}]%0A`;
            itens.forEach(i => { const qtd = (i.qtd > 1 && i.tipo !== 'DESCONTO') ? `${i.qtd}x ` : ''; btTxt += `${qtd}${i.desc}: R$ ${i.valor.toFixed(2)}%0A`; });
            btTxt += `%0A`;
        }
        btTxt += `--------------------------------%0ATOTAL GERAL: R$ ${d.total.toFixed(2)}%0A--------------------------------%0A%0A%0A`;
        window.location.href = 'rawbt:' + btTxt;
    }
}

window.fecharExtrato = function(e) { if(e.target.id === 'modal-extrato') document.getElementById('modal-extrato').style.display = 'none'; }
window.del = async function(c, id) { 
    if(c === 'logs') { if(!confirm("Apagar?")) return; await deleteDoc(doc(db,c,id)); return; } 
    abrirModalSenha(async () => { document.getElementById('modal-overlay').style.display='none'; await deleteDoc(doc(db,c,id)); }); 
}
window.fecharModal = function(e) { if(e.target.id=='modal-overlay') document.getElementById('modal-overlay').style.display='none'; }
</script>
</body>
</html>
