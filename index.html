<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FILHÃO.CELL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003399">
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <style>
        :root { --primary: #003399; --accent: #ffcc00; --success: #25d366; --bg: #f4f7fe; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; }
        body { background: var(--bg); color: #333; padding-bottom: 90px; }

        header { background: var(--primary); color: white; padding: 15px; text-align: center; border-bottom: 5px solid var(--accent); }
        .container { padding: 10px; max-width: 600px; margin: auto; }

        .page { display: none; }
        .page.active { display: block; }

        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h3 { color: var(--primary); font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        label { font-size: 10px; font-weight: bold; color: #666; display: block; margin-top: 8px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 4px; font-size: 14px; outline: none; background: #fff; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { width: auto; padding: 5px 10px; font-size: 10px; margin: 0; }

        .foto-circulo { width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 5px auto; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--primary); cursor: pointer; }
        .foto-circulo img { width: 100%; height: 100%; object-fit: cover; }
        .foto-quadrada { width: 100%; height: 120px; background: #eee; border-radius: 10px; margin-top: 5px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; }
        .foto-quadrada img { width: 100%; height: 100%; object-fit: cover; }

        .search-box { position: relative; }
        .sugestoes { background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 150px; overflow-y: auto; position: absolute; width: 100%; z-index: 100; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .sugestoes div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 12px; }

        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; padding: 10px 0; z-index: 1000; }
        .nav-item { flex: 1; border: none; background: none; color: #aaa; font-size: 9px; font-weight: bold; text-align: center; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { display: block; font-size: 18px; margin-bottom: 3px; }
    </style>
</head>
<body>

<header><h2>FILHÃO.CELL</h2></header>

<div class="container">

    <div id="page-servicos" class="page active">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h3><i class="fas fa-wrench"></i> ORDEM DE SERVIÇO</h3>
                <button class="btn btn-primary btn-sm" onclick="nav('cadastros')">+ CLIENTE</button>
            </div>
            <label>BUSCAR CLIENTE</label>
            <div class="search-box">
                <input type="text" id="s-cli" placeholder="NOME..." onkeyup="buscar('clientes', this.value, 's-sug')">
                <div id="s-sug" class="sugestoes"></div>
            </div>
            <label>APARELHO E SENHA</label>
            <div style="display:flex; gap:10px"><input type="text" id="s-apa" placeholder="MODELO"><input type="text" id="s-pw" placeholder="SENHA"></div>
            <label>DEFEITO</label>
            <textarea id="s-def" rows="2"></textarea>
            <label>FOTO DO APARELHO</label>
            <div class="foto-quadrada" onclick="document.getElementById('f-apa').click()">
                <img id="p-apa" style="display:none"><i class="fas fa-camera" id="i-apa"></i>
            </div>
            <input type="file" id="f-apa" hidden accept="image/*" onchange="read(this, 'p-apa', 'i-apa')">
            <button class="btn btn-primary" onclick="registrar('S')">SALVAR O.S.</button>
            <button class="btn btn-success" onclick="zap()"><i class="fab fa-whatsapp"></i> ENVIAR ZAP</button>
        </div>
    </div>

    <div id="page-vendas" class="page">
        <div class="card">
            <h3><i class="fas fa-shopping-cart"></i> NOVA VENDA</h3>
            <label>CLIENTE</label>
            <div style="display:flex; gap:5px; align-items: flex-start;">
                <div class="search-box" style="flex:1">
                    <input type="text" id="v-cli" placeholder="BUSCAR..." onkeyup="buscar('clientes', this.value, 'v-sug-c')">
                    <div id="v-sug-c" class="sugestoes"></div>
                </div>
                <button class="btn btn-primary btn-sm" style="margin-top:4px; height:38px" onclick="nav('cadastros')"><i class="fas fa-plus"></i></button>
            </div>
            <label>PRODUTO</label>
            <div style="display:flex; gap:5px; align-items: flex-start;">
                <div class="search-box" style="flex:1">
                    <input type="text" id="v-prod" placeholder="BUSCAR..." onkeyup="buscar('produtos', this.value, 'v-sug-p')">
                    <div id="v-sug-p" class="sugestoes"></div>
                </div>
                <button class="btn btn-primary btn-sm" style="margin-top:4px; height:38px" onclick="nav('cadastros')"><i class="fas fa-plus"></i></button>
            </div>
            <label>VALOR R$</label>
            <input type="number" id="v-val">
            <button class="btn btn-success" onclick="registrar('V')">CONCLUIR VENDA</button>
        </div>
    </div>

    <div id="page-cadastros" class="page">
        <div class="card">
            <h3>NOVO CLIENTE</h3>
            <div class="foto-circulo" onclick="document.getElementById('f-cli').click()">
                <img id="p-cli" style="display:none"><i class="fas fa-user" id="i-cli"></i>
            </div>
            <input type="file" id="f-cli" hidden accept="image/*" onchange="read(this, 'p-cli', 'i-cli')">
            <input type="text" id="c-nome" placeholder="NOME COMPLETO">
            <input type="text" id="c-tel" placeholder="WHATSAPP">
            <button class="btn btn-primary" onclick="salvar('cliente')">CADASTRAR CLIENTE</button>
        </div>
        <div class="card">
            <h3>NOVO PRODUTO (RESTRITO ADM)</h3>
            <div class="foto-quadrada" onclick="document.getElementById('f-prod-cad').click()">
                <img id="p-prod-cad" style="display:none"><i class="fas fa-box" id="i-prod-cad"></i>
            </div>
            <input type="file" id="f-prod-cad" hidden accept="image/*" onchange="read(this, 'p-prod-cad', 'i-prod-cad')">
            <input type="text" id="p-nome" placeholder="NOME PRODUTO">
            <div style="display:flex; gap:10px">
                <input type="number" id="p-custo" placeholder="CUSTO">
                <input type="number" id="p-venda" placeholder="VENDA">
            </div>
            <button class="btn btn-primary" onclick="validarAdm(() => salvar('produto'))">SALVAR PRODUTO</button>
        </div>
    </div>

    <div id="page-relatorio" class="page">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <select id="f-data" onchange="renderHist()">
                    <option value="hoje">HOJE</option>
                    <option value="semana">SEMANA</option>
                    <option value="mes">MÊS</option>
                    <option value="ano">ANO ATUAL</option> </select>
                <button class="btn btn-primary btn-sm" onclick="validarAdm(liberarFinanceiro)">VER LUCRO</button>
            </div>
            <div id="hist-render" style="margin-top:10px; font-size:11px"></div>
            <div id="fin-adm" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px; font-weight:bold; color:green; display:none"></div>
        </div>
    </div>

</div>

<nav>
    <button class="nav-item active" onclick="nav('servicos', this)"><i class="fas fa-wrench"></i>SERVIÇOS</button>
    <button class="nav-item" onclick="nav('vendas', this)"><i class="fas fa-shopping-cart"></i>VENDAS</button>
    <button class="nav-item" onclick="nav('cadastros', this)"><i class="fas fa-plus-circle"></i>CADASTROS</button>
    <button class="nav-item" onclick="nav('relatorio', this)"><i class="fas fa-chart-line"></i>RELATÓRIO</button>
</nav>

<script>
    let db = JSON.parse(localStorage.getItem('filhao_v7')) || { clientes: [], produtos: [], logs: [] };
    const SENHA_ADM = "000800";

    function validarAdm(callback) {
        const p = prompt("DIGITE A SENHA DO ADMINISTRADOR:");
        if(p === SENHA_ADM) { callback(); } else { alert("ACESSO NEGADO!"); }
    }

    function liberarFinanceiro() {
        document.getElementById('fin-adm').style.display = 'block';
        renderHist();
    }

    function read(input, imgId, iconId) {
        if (input.files && input.files[0]) {
            let r = new FileReader();
            r.onload = (e) => {
                document.getElementById(imgId).src = e.target.result;
                document.getElementById(imgId).style.display = 'block';
                document.getElementById(iconId).style.display = 'none';
            };
            r.readAsDataURL(input.files[0]);
        }
    }

    function nav(p, b) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(bt => bt.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        if(!b) b = document.querySelector(`.nav-item[onclick*="${p}"]`);
        if(b) b.classList.add('active');
        if(p === 'relatorio') {
            document.getElementById('fin-adm').style.display = 'none';
            renderHist();
        }
    }

    function buscar(tipo, termo, divId) {
        const box = document.getElementById(divId);
        if(termo.length < 2) { box.innerHTML = ""; return; }
        const res = db[tipo].filter(i => i.nome.toLowerCase().includes(termo.toLowerCase()));
        box.innerHTML = res.map(i => `<div onclick="set('${tipo}','${i.nome}','${divId}','${i.precoVenda||''}')">${i.nome}</div>`).join('');
    }

    function set(tipo, nome, divId, preco) {
        if(divId.includes('cli')) { document.getElementById(divId.includes('v') ? 'v-cli' : 's-cli').value = nome; }
        if(divId.includes('p')) { document.getElementById('v-prod').value = nome; document.getElementById('v-val').value = preco; }
        document.getElementById(divId).innerHTML = "";
    }

    function salvar(tipo) {
        if(tipo === 'cliente') {
            db.clientes.push({ nome: document.getElementById('c-nome').value, tel: document.getElementById('c-tel').value, foto: document.getElementById('p-cli').src });
        } else if(tipo === 'produto') {
            db.produtos.push({ nome: document.getElementById('p-nome').value, precoCompra: parseFloat(document.getElementById('p-custo').value||0), precoVenda: parseFloat(document.getElementById('p-venda').value||0), foto: document.getElementById('p-prod-cad').src });
        }
        localStorage.setItem('filhao_v7', JSON.stringify(db));
        alert("SALVO COM SUCESSO!");
        location.reload();
    }

    function registrar(tipo) {
        let item = { tipo: tipo === 'S' ? 'SERVIÇO' : 'VENDA', data: new Date().toISOString() };
        if(tipo === 'S') {
            item.cliente = document.getElementById('s-cli').value; item.desc = document.getElementById('s-apa').value; item.senha = document.getElementById('s-pw').value;
        } else {
            item.cliente = document.getElementById('v-cli').value; item.desc = document.getElementById('v-prod').value; item.valor = parseFloat(document.getElementById('v-val').value);
            let pIdx = db.produtos.findIndex(p => p.nome === item.desc);
            if(pIdx !== -1) { item.lucro = (item.valor || 0) - (db.produtos[pIdx].precoCompra || 0); }
        }
        if(!item.cliente || !item.desc) { alert("PREENCHA OS CAMPOS!"); return; }
        db.logs.push(item); 
        localStorage.setItem('filhão_v8', JSON.stringify(db)); 
        alert("CONCLUÍDO!");
        if(tipo === 'V') location.reload();
    }

    function renderHist() {
        const f = document.getElementById('f-data').value;
        const r = document.getElementById('hist-render');
        const h = new Date();
        let logs = db.logs.filter(l => {
            const d = new Date(l.data);
            if(f === 'hoje') return d.toDateString() === h.toDateString();
            if(f === 'semana') {
                const start = new Date(h); start.setDate(h.getDate() - h.getDay());
                return d >= start;
            }
            if(f === 'mes') return d.getMonth() === h.getMonth();
            if(f === 'ano') return d.getFullYear() === h.getFullYear(); // LÓGICA DO ANO
            return true;
        });
        
        r.innerHTML = logs.reverse().map(l => `
            <div style="padding:8px; background:#fff; margin-bottom:5px; border-radius:8px; border-left: 4px solid ${l.tipo === 'SERVIÇO' ? '#003399' : '#25d366'}">
                <b>${l.tipo}:</b> ${l.cliente} - ${l.desc} <span style="float:right">R$ ${l.valor?l.valor.toFixed(2):'0.00'}</span>
            </div>`).join('');

        const fat = logs.reduce((a, b) => a + (b.valor || 0), 0);
        const luc = logs.reduce((a, b) => a + (b.lucro || 0), 0);
        document.getElementById('fin-adm').innerHTML = `TOTAL: FAT R$ ${fat.toFixed(2)} | LUC R$ ${luc.toFixed(2)}`;
    }

    function zap() {
        const msg = `*FILHÃO.CELL*\nCLIENTE: ${document.getElementById('s-cli').value}\nAPARELHO: ${document.getElementById('s-apa').value}\nSENHA: ${document.getElementById('s-pw').value}`;
        window.open(`https://wa.me/5581999999999?text=${encodeURIComponent(msg)}`);
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(e => {}); });
    }
</script>
</body>
</html>
