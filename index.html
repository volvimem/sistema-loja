<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FILH√ÉO.CELL (v51)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d50000">

    <style>
        :root { 
            --primary: #d50000;      
            --primary-dark: #b71c1c; 
            --accent: #000000;        
            --text: #212121;          
            --bg: #f5f5f5;            
            --card-bg: #ffffff;       
            --success: #2e7d32;       
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 85px; text-transform: uppercase; user-select: none; }

        /* HEADER */
        header { 
            background: linear-gradient(135deg, var(--accent) 30%, var(--primary) 100%); 
            color: white; padding: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            position: sticky; top: 0; z-index: 100; 
            display:flex; justify-content:space-between; align-items:center; 
            border-bottom: 3px solid var(--primary);
        }
        header h2 { font-size: 16px; font-weight: 900; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; font-style: italic; }

        /* BOT√ÉO DE VERS√ÉO */
        .version-btn { 
            font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.2); 
            padding: 4px 8px; border-radius: 12px; margin-left: 5px; font-style: normal; 
            cursor: pointer; border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; gap: 5px;
            transition: 0.3s;
        }
        .version-btn:active { background: white; color: var(--primary); transform: scale(0.95); }

        .container { padding: 12px; max-width: 800px; margin: auto; }
        .page { display: none; animation: slideUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        /* CARDS */
        .card { background: var(--card-bg); padding: 18px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 15px; position: relative; border-left: 5px solid transparent; }
        .card:hover { border-left-color: var(--primary); transition: 0.3s; }

        h3 { 
            color: var(--accent); font-size: 14px; margin-bottom: 15px; 
            border-bottom: 2px solid #eee; padding-bottom: 8px; 
            display:flex; justify-content:space-between; align-items:center; font-weight: 800; 
        }

        /* BOT√ÉO NOVO */
        .btn-novo {
            background: var(--accent); color: white; border: none; 
            padding: 6px 16px; border-radius: 20px; font-size: 10px; font-weight: bold; 
            cursor: pointer; display: flex; align-items: center; gap: 5px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .btn-novo:active { transform: scale(0.95); background: var(--primary); }

        /* INPUTS & LABELS */
        label { font-size: 10px; font-weight: 800; color: #666; margin-top: 10px; display: block; letter-spacing: 0.5px; }
        input, textarea, select { 
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; 
            background: #fafafa; margin-top: 5px; font-size: 14px; outline: none; transition: 0.2s; font-weight: 600; color: #333;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        /* BUSCA COM LUPA */
        .search-box { position: relative; margin-top: 5px; }
        .search-box input { padding-right: 45px; margin-top: 0; }

        .search-btn { 
            position: absolute; right: 5px; top: 2px; bottom: 2px;
            background: var(--primary); color: white; border: none; width: 40px; 
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            z-index: 20;
        }
        .search-btn:active { background: var(--primary-dark); transform: scale(0.95); }

        .sugestoes { background: white; border-radius: 0 0 10px 10px; max-height: 250px; overflow-y: auto; position: absolute; top: 100%; width: 100%; z-index: 999; box-shadow: 0 10px 20px rgba(0,0,0,0.15); display: none; border: 1px solid #eee; }
        .sugestoes div.item-sug { padding: 12px; border-bottom: 1px solid #f1f1f1; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        .sugestoes div.item-sug:active { background: #f0f0f0; }
        .sug-header { background: #eee; color: #555; font-size: 10px; font-weight: 900; padding: 5px 12px; letter-spacing: 1px; }

        /* FOTOS OS */
        .os-foto-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; }
        .os-foto-slot {
            aspect-ratio: 1; background: #eee; border-radius: 8px; border: 2px dashed #ccc;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            overflow: hidden; position: relative;
        }
        .os-foto-slot img { width: 100%; height: 100%; object-fit: cover; }
        .os-foto-slot i { color: #999; font-size: 20px; }

        /* KANBAN */
        .kanban-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; align-items: start; }
        .k-col { background: #f0f0f0; padding: 5px; border-radius: 10px; min-height: 100px; }
        .k-head { font-size: 9px; font-weight: 900; text-align: center; margin-bottom: 8px; color: var(--accent); background: white; padding: 4px; border-radius: 6px; border: 1px solid #ddd; }

        .os-card { background: white; padding: 8px; border-radius: 8px; margin-bottom: 6px; border-top: 4px solid #ccc; font-size: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .os-card.pecas { border-top-color: var(--primary); } 
        .os-card.pgto { border-top-color: #ff9800; } 
        .os-card.retirado { border-top-color: var(--success); }

        .btn-mini { border: none; border-radius: 6px; padding: 4px; color: white; cursor: pointer; font-size: 9px; flex: 1; transition: 0.2s; display:flex; justify-content:center; align-items:center; }
        .btn-mini:active { transform: scale(0.9); }

        /* BOT√ïES GERAIS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 15px; font-size: 13px; color: white; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); } 
        .btn-dark { background: var(--accent); } 
        .btn-info { background: #0288d1; }
        .btn-success { background: var(--success); }
        .btn-zap { background: #25D366; }
        .btn-add-mini { background: #2e7d32; color:white; border:none; border-radius:8px; width:44px; font-size:18px; cursor:pointer; margin-top:5px; }

        /* FOTOS E MODAL */
        .foto-preview { 
            width: 80px; height: 80px; border-radius: 50%; 
            background-color: #eee; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23999'%3E%3Cpath d='M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z'/%3E%3C/svg%3E");
            background-size: 40%; background-position: center; background-repeat: no-repeat;
            object-fit: cover; border: 3px solid var(--primary); margin: 10px auto; display: block; cursor: pointer; 
        }
        .foto-preview.has-img { background-image: none; }

        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; border: 2px solid var(--primary); }

        /* RANKING */
        .rank-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .rank-box { background: #fafafa; padding: 8px; border-radius: 10px; border: 1px solid #eee; }
        .rank-title { font-size: 10px; font-weight: 900; text-align: center; color: var(--primary); margin-bottom: 8px; border-bottom: 2px solid var(--primary); padding-bottom: 2px; }
        .rank-item { font-size: 9px; margin-bottom: 4px; display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }

        /* NAV */
        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 2px solid var(--primary); padding: 10px 0 25px 0; z-index: 900; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; border: none; background: none; color: #999; font-size: 9px; font-weight: bold; text-align: center; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { display: block; font-size: 22px; margin-bottom: 4px; color: var(--accent); }
        .nav-item.active i { color: var(--primary); }

        /* √ÅREA DE IMPRESS√ÉO */
        #area-print { display: none; } 

        @media print { 
            body * { visibility: hidden; } 
            #area-print, #area-print * { visibility: visible; }
            #area-print { 
                display: block !important; 
                position: absolute; left: 0; top: 0; width: 100%; 
                font-family: 'Courier New', monospace; font-size: 12px; color: black; background: white;
                padding: 5px;
                min-height: 100vh;
                z-index: 9999;
            } 
            .p-header { text-align: center; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
            .p-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
            .p-info { font-size: 10px; margin-bottom: 2px; }
            .p-line { border-bottom: 1px dashed #000; margin: 10px 0; }
            .p-table { width: 100%; text-align: left; font-size: 11px; }
            .p-table th { border-bottom: 1px solid #000; }
            .p-total { text-align: right; font-size: 16px; font-weight: bold; margin-top: 10px; }
            .p-sign { margin-top: 40px; text-align: center; border-top: 1px solid #000; padding-top: 5px; font-size: 10px; width: 80%; margin-left: auto; margin-right: auto; }
        }
    </style>
</head>
<body>

<div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#d50000;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;font-weight:bold;">
    <div>FILH√ÉO.CELL</div>
</div>

<div id="area-print"></div>

<div id="modal-overlay" onclick="fecharModal(event)">
    <div class="modal-content" id="modal-content-default">
        </div>
</div>

<div id="modal-extrato" onclick="fecharExtrato(event)" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2001; align-items:center; justify-content:center; backdrop-filter:blur(5px)">
    <div class="modal-content" style="width:90%; max-width:400px; max-height:80vh; display:flex; flex-direction:column; padding:0; overflow:hidden">
        <div style="background:var(--primary); color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center">
            <span id="ext-nome">CLIENTE</span>
            <i class="fas fa-times" onclick="document.getElementById('modal-extrato').style.display='none'" style="cursor:pointer"></i>
        </div>
        
        <div id="ext-lista" style="padding:15px; overflow-y:auto; flex:1; background:#f9f9f9">
            </div>

        <div style="padding:15px; background:white; border-top:1px solid #eee; display:flex; flex-direction:column; gap:8px">
            <div style="font-size:10px; color:#999; text-align:center; font-weight:bold; margin-bottom:5px">COMPARTILHAR EXTRATO</div>
            <button class="btn" style="background:#25d366; margin:0; padding:10px" onclick="shareExtrato('zap')"><i class="fab fa-whatsapp"></i> WHATSAPP</button>
            <div style="display:flex; gap:8px">
                <button class="btn" style="background:#333; margin:0; padding:10px; flex:1" onclick="shareExtrato('print')"><i class="fas fa-print"></i> 80MM</button>
                <button class="btn" style="background:#d32f2f; margin:0; padding:10px; flex:1" onclick="shareExtrato('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
        </div>
    </div>
</div>

<header>
    <h2><i class="fas fa-fire"></i> FILH√ÉO.CELL <div class="version-btn" onclick="forcarAtualizacao()">v51 <i class="fas fa-sync-alt"></i></div></h2>
    <div id="status-conn" style="font-size:10px"><i class="fas fa-wifi"></i></div>
</header>

<div class="container">

    <div id="page-vendas" class="page active">
        <div class="card">
            <h3><i class="fas fa-cash-register"></i> CAIXA</h3>
            
            <label>CLIENTE</label>
            <div class="search-box">
                <input type="text" id="v-cli" placeholder="BUSCAR CLIENTE..." onkeyup="buscar('clientes', this.value, 'sug-v-cli')">
                <button type="button" class="search-btn" onclick="toggleSearch('cli', 'v-cli', 'sug-v-cli')"><i class="fas fa-search"></i></button>
                <div id="sug-v-cli" class="sugestoes"></div>
            </div>
            <button class="btn-novo" style="margin-top:10px" onclick="cadastrarNovoNaVenda()"><i class="fas fa-plus"></i> NOVO CLIENTE</button>

            <label style="margin-top:15px">ADICIONAR ITEM</label>
            <div class="search-box">
                <input type="text" id="v-busca" placeholder="BIPAR OU DIGITAR..." onkeyup="buscarVenda(this.value)">
                <button type="button" class="search-btn" onclick="toggleSearch('venda', 'v-busca', 'sug-v-prod')"><i class="fas fa-search"></i></button>
                <div id="sug-v-prod" class="sugestoes"></div>
            </div>

            <div style="background:#f9f9f9; border:2px dashed #e0e0e0; padding:15px; margin-top:20px; border-radius:12px">
                <div style="font-size:10px; color:#999; text-align:center; margin-bottom:5px">CLIQUE NO L√ÅPIS PARA ALTERAR O VALOR</div>
                <div id="carrinho-lista" style="font-size:12px; color:#888; text-align:center; padding:10px">CARRINHO VAZIO</div>
                
                <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px; margin-top:15px; padding-top:10px; border-top:1px solid #ddd">
                    <label style="margin:0; font-size:11px; color:#d32f2f; font-weight:bold">DESCONTO (R$):</label>
                    <input type="number" id="v-desc" placeholder="0.00" style="width:100px; margin:0; border-color:#d32f2f; color:#d32f2f; font-weight:bold; text-align:right" onkeyup="renderCarrinho()">
                </div>

                <div style="text-align:right; font-size:18px; font-weight:900; margin-top:10px; color:var(--primary);" id="v-total">TOTAL: R$ 0,00</div>
            </div>

            <button class="btn btn-primary" style="margin-top:15px; width:100%" onclick="finalizarVenda()">FINALIZAR VENDA</button>
        </div>
    </div>

    <div id="page-servicos" class="page">
        <div class="card">
            <h3>NOVA O.S. <button class="btn-novo" onclick="limparOS()"><i class="fas fa-file"></i> NOVA</button></h3>
            <input type="hidden" id="os-id">
            <input type="hidden" id="os-status-orig">
            
            <label>CLIENTE</label>
            <div style="display:flex; gap:5px; align-items:flex-end">
                <div class="search-box" style="flex:1">
                    <input type="text" id="s-cli" placeholder="BUSCAR..." onkeyup="buscar('clientes', this.value, 'sug-s-cli')">
                    <button type="button" class="search-btn" onclick="toggleSearch('cli', 's-cli', 'sug-s-cli')"><i class="fas fa-search"></i></button>
                    <div id="sug-s-cli" class="sugestoes"></div>
                </div>
                <button class="btn-add-mini" onclick="cadastrarNovoNaOS()"><i class="fas fa-plus"></i></button>
            </div>
            
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>MODELO</label><input id="s-mod"></div>
                <div style="flex:1"><label>SENHA</label><input id="s-senha"></div>
            </div>
            
            <label>DEFEITO / OBS</label>
            <input id="s-def">

            <label>GARANTIA</label>
            <select id="s-garantia">
                <option value="90 DIAS">90 DIAS (3 MESES)</option>
                <option value="30 DIAS">30 DIAS (1 M√äS)</option>
                <option value="180 DIAS">180 DIAS (6 MESES)</option>
                <option value="1 ANO">1 ANO</option>
                <option value="SEM GARANTIA">SEM GARANTIA</option>
            </select>
            
            <label>FOTOS DO APARELHO (M√ÅX 4)</label>
            <div class="os-foto-grid">
                <div class="os-foto-slot" onclick="addFotoOS(0)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(1)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(2)"><i class="fas fa-camera"></i></div>
                <div class="os-foto-slot" onclick="addFotoOS(3)"><i class="fas fa-camera"></i></div>
            </div>
            <input type="file" id="os-foto-input" hidden onchange="processFotoOS(this)">

            <label>ADICIONAR PE√áA/SERVI√áO</label>
            <div class="search-box">
                <input type="text" id="s-busca-item" placeholder="BUSCAR PE√áA..." onkeyup="buscarItemOS(this.value)">
                <button type="button" class="search-btn" onclick="toggleSearch('os', 's-busca-item', 'sug-os-item')"><i class="fas fa-search"></i></button>
                <div id="sug-os-item" class="sugestoes"></div>
            </div>

            <div style="background:#f9f9f9; border:2px dashed #e0e0e0; padding:10px; margin-top:15px; border-radius:12px">
                <div style="font-size:10px; color:#999; text-align:center; margin-bottom:5px">CLIQUE NO L√ÅPIS PARA ALTERAR O VALOR</div>
                <div id="os-lista-itens"></div>
                
                <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px; margin-top:15px; padding-top:10px; border-top:1px solid #ddd">
                    <label style="margin:0; font-size:11px; color:#d32f2f; font-weight:bold">DESCONTO (R$):</label>
                    <input type="number" id="s-desc" placeholder="0.00" style="width:100px; margin:0; border-color:#d32f2f; color:#d32f2f; font-weight:bold; text-align:right" onkeyup="renderItemsOS()">
                </div>

                <div style="text-align:right; font-size:16px; font-weight:900; margin-top:10px; color:var(--primary);" id="s-total-display">TOTAL: R$ 0,00</div>
            </div>

            <button class="btn btn-primary" onclick="salvarOS()">SALVAR ORDEM</button>
        </div>

        <div style="padding: 0 5px; margin-bottom: 10px;">
            <div class="search-box">
                <input type="text" id="busca-kanban" placeholder="üîç LOCALIZAR OS (CLIENTE, MODELO, STATUS)..." onkeyup="renderKanban()" style="background:white; border:2px solid #ddd; font-weight:bold">
            </div>
        </div>

        <div class="kanban-grid">
            <div class="k-col">
                <div class="k-head" style="color:#555">AN√ÅLISE</div>
                <div id="k-pecas"></div>
            </div>
            <div class="k-col">
                <div class="k-head" style="color:#ff9800; font-size:8px">AGUARDANDO PAGAMENTO</div>
                <div id="k-pgto"></div>
            </div>
            <div class="k-col">
                <div class="k-head" style="color:green">PRONTO</div>
                <div id="k-retirado"></div>
            </div>
        </div>
    </div>

    <div id="page-clientes" class="page">
        <div class="card" id="form-cli">
            <h3>CLIENTES <button class="btn-novo" onclick="limparCli()"><i class="fas fa-user-plus"></i> NOVO</button></h3>
            <input type="hidden" id="c-id">
            
            <img id="c-foto-view" src="" class="foto-preview" onclick="document.getElementById('c-foto').click()">
            <input type="file" id="c-foto" hidden onchange="lerFoto(this, 'c-foto-view')">

            <input type="text" id="c-nome" placeholder="NOME COMPLETO *">
            <input type="tel" id="c-tel" placeholder="WHATSAPP" oninput="maskTel(this)">
            <div style="display:flex; gap:10px">
                <input type="text" id="c-bairro" placeholder="BAIRRO">
                <input type="text" id="c-cidade" placeholder="CIDADE">
            </div>
            
            <button class="btn btn-primary" onclick="salvarCliente()">SALVAR CLIENTE</button>
        </div>
        <div class="card">
            <h3>MEUS CLIENTES</h3>
            <div class="search-box">
                <input type="text" id="cli-search-input" placeholder="FILTRAR LISTA..." onkeyup="buscar('clientes', this.value, 'lista-clientes', true)">
                <button type="button" class="search-btn" onclick="toggleSearch('listacli', 'cli-search-input', 'lista-clientes')"><i class="fas fa-search"></i></button>
            </div>
            <div id="lista-clientes" style="margin-top:15px"></div>
        </div>
    </div>

    <div id="page-estoque" class="page">
        <div class="card">
            <h3>ITEM DE ESTOQUE <button class="btn-novo" onclick="limparEstoque()"><i class="fas fa-plus"></i> NOVO</button></h3>
            <input type="hidden" id="p-id">
            
            <img id="p-foto-view" src="" class="foto-preview" onclick="document.getElementById('p-foto').click()">
            <input type="file" id="p-foto" hidden onchange="lerFoto(this, 'p-foto-view')">

            <input type="text" id="p-nome" placeholder="DESCRI√á√ÉO *">
            <div style="display:flex; gap:10px">
                <input type="number" id="p-venda" placeholder="R$ VENDA *">
                <input type="number" id="p-qtd" placeholder="QTD">
            </div>
            
            <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px">
                <label style="margin-top:0; color:#c62828"><i class="fas fa-lock"></i> PRE√áO DE CUSTO</label>
                <div style="display:flex; gap:5px">
                    <input type="number" id="p-custo" placeholder="0.00" style="border-color:#ffcdd2">
                    <button id="btn-ver-custo" class="btn-dark" style="width:50px; border-radius:10px; display:none" onclick="revelarCusto()"><i class="fas fa-eye"></i></button>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px">
                <button class="btn btn-primary" onclick="salvarProduto('prod')">SALVAR PRODUTO</button>
                <button class="btn btn-dark" onclick="salvarProduto('serv')">SALVAR SERVI√áO</button>
            </div>
        </div>
        
        <div class="card">
            <div style="display:flex; gap:5px; margin-bottom:10px">
                <button class="btn-mini btn-dark" onclick="listarEstoque('prod')">PRODUTOS</button>
                <button class="btn-mini btn-dark" style="opacity:0.7" onclick="listarEstoque('serv')">SERVI√áOS</button>
            </div>
            <div id="lista-estoque"></div>
        </div>
    </div>

    <div id="page-relatorio" class="page">
        <div class="card">
            <h3>RELAT√ìRIOS FINANCEIROS</h3>
            <select id="r-filtro" onchange="renderRelatorio()" style="margin-bottom:15px">
                <option value="dia">HOJE</option>
                <option value="semana">√öLTIMOS 7 DIAS</option>
                <option value="mes">M√äS ATUAL</option>
                <option value="ano">ESTE ANO</option>
            </select>
            
            <div style="background:var(--accent); color:white; padding:20px; border-radius:12px; text-align:center">
                <div style="font-size:11px; opacity:0.8">FATURAMENTO TOTAL (L√çQUIDO)</div>
                <div id="r-total" style="font-size:24px; font-weight:900; margin-top:5px">R$ 0,00</div>
            </div>

            <h3 style="margin-top:25px; font-size:12px; color:#666">CLIENTES ATENDIDOS</h3>
            
            <div class="search-box" style="margin-bottom:10px">
                <input type="text" id="r-search" placeholder="üîç BUSCAR CLIENTE..." onkeyup="renderRelatorio()" style="background:white; border:2px solid #ddd">
                <div id="sug-r-cli" class="sugestoes"></div>
            </div>

            <div id="r-hist" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:5px"></div>

            <h3 style="margin-top:20px; font-size:12px; color:#666">RANKINGS DE DESEMPENHO</h3>
            <div class="rank-grid">
                <div class="rank-box">
                    <div class="rank-title">CLIENTES</div>
                    <div id="rank-cli"></div>
                </div>
                <div class="rank-box">
                    <div class="rank-title">PRODUTOS</div>
                    <div id="rank-prod"></div>
                </div>
                <div class="rank-box">
                    <div class="rank-title">SERVI√áOS</div>
                    <div id="rank-serv"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<nav>
    <button class="nav-item active" onclick="nav('vendas', this)"><i class="fas fa-shopping-cart"></i>VENDAS</button>
    <button class="nav-item" onclick="nav('servicos', this)"><i class="fas fa-wrench"></i>OS</button>
    <button class="nav-item" onclick="nav('clientes', this)"><i class="fas fa-users"></i>CLIENTES</button>
    <button class="nav-item" onclick="nav('estoque', this)"><i class="fas fa-box"></i>ESTOQUE</button>
    <button class="nav-item" onclick="nav('relatorio', this)"><i class="fas fa-chart-line"></i>RELAT√ìRIOS</button>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDeGGqXV4LOB_ENZLkj_QHOIE5_OEp29s0",
  authDomain: "filhaocell-a528e.firebaseapp.com",
  projectId: "filhaocell-a528e",
  storageBucket: "filhaocell-a528e.firebasestorage.app",
  messagingSenderId: "69033828352",
  appId: "1:69033828352:web:a0ec6bcbf797622e6838e5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const SENHA = "0800"; 

const EMPRESA = {
    nome: "FILH√ÉO.CELL",
    cnpj: "31.926.078/0001-65",
    tel: "(81) 9 9507-4007",
    end: "Rua Jose Medeiros Rego, 09, Centro",
    cid: "Surubim - PE",
    email: "filhao.cell@gmail.com"
};

window.db = { clientes:[], produtos:[], servicos:[], os:[], logs:[] };
window.carrinho = [];
window.carrinhoOS = [];
window.shareData = null;
window.tempImg = null;
window.retornoVenda = false;
window.retornoOS = false;
window.osFotos = [null, null, null, null];
window.currentFotoIndex = 0;
window.extratoAtual = null;
window.clienteEmEdicao = null; // Para controlar a edi√ß√£o avan√ßada

// --- CARREGAMENTO ---
onSnapshot(collection(db, "clientes"), s => { window.db.clientes = s.docs.map(d=>({id:d.id, ...d.data()})); if(isPg('clientes')) listarCli(); });
onSnapshot(collection(db, "produtos"), s => { window.db.produtos = s.docs.map(d=>({id:d.id, ...d.data()})); });
onSnapshot(collection(db, "servicos_cad"), s => { window.db.servicos = s.docs.map(d=>({id:d.id, ...d.data()})); });
onSnapshot(query(collection(db, "os_ativa"), orderBy("data", "desc")), s => { window.db.os = s.docs.map(d=>({id:d.id, ...d.data()})); renderKanban(); document.getElementById('loading').style.display='none'; });

onSnapshot(query(collection(db, "logs"), orderBy("data", "desc")), s => { 
    window.db.logs = s.docs.map(d=>({id:d.id, ...d.data()})); 
    if(isPg('relatorio')) renderRelatorio();
});

function isPg(p){ return document.getElementById('page-'+p).classList.contains('active'); }

// --- NAV ---
window.nav = function(p, el) {
    if(p === 'relatorio') {
        if(prompt("SENHA ADM:") !== SENHA) return;
    }
    document.querySelectorAll('.page').forEach(d=>d.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(d=>d.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    if(el) el.classList.add('active');
    if(p==='clientes') listarCli();
    if(p==='estoque') listarEstoque('prod');
    if(p==='relatorio') renderRelatorio();
}

// --- ATUALIZA√á√ÉO FOR√áADA ---
window.forcarAtualizacao = async function() {
    if(!confirm("Deseja for√ßar a atualiza√ß√£o para a vers√£o mais recente? Isso recarregar√° o sistema.")) return;
    if ('serviceWorker' in navigator) { const r = await navigator.serviceWorker.getRegistrations(); for(let x of r) await x.unregister(); }
    if ('caches' in window) { const k = await caches.keys(); for(let x of k) await caches.delete(x); }
    window.location.reload(true);
}

// --- BUSCA TOGGLE ---
window.toggleSearch = function(tipo, inpId, boxId) {
    const box = document.getElementById(boxId);
    const val = document.getElementById(inpId).value;

    if(tipo === 'listacli') {
         if(box.innerHTML.trim() !== '') { box.innerHTML = ''; } 
         else { buscar('clientes', val, boxId, true, true); }
         return;
    }

    if(box.style.display === 'block') {
        box.style.display = 'none'; 
    } else {
        if(tipo === 'cli') buscar('clientes', val, boxId, false, true);
        if(tipo === 'venda') buscarVenda(val, true);
        if(tipo === 'os') buscarItemOS(val, true);
    }
}

// --- BUSCAS ---
window.buscar = function(col, txt, divId, lista=false, force=false) {
    const box = document.getElementById(divId);
    if(!window.db[col]) return alert("AGUARDE CARREGAR O SISTEMA...");
    if(!txt && !force && !lista) { box.style.display='none'; return; }
    
    let res = window.db[col].filter(i => (i.nome||'').toUpperCase().includes((txt||'').toUpperCase())).slice(0,8);
    
    if(lista) {
        if(res.length === 0) { document.getElementById(divId).innerHTML = '<div style="text-align:center;padding:10px;color:#999">NENHUM REGISTRO</div>'; } 
        else { document.getElementById(divId).innerHTML = res.map(renderCliCard).join(''); }
        return;
    }
    
    if(res.length) {
        box.innerHTML = res.map(i => `<div class="item-sug" onclick="sel('${col}','${i.id}','${divId}')">${i.nome}</div>`).join('');
        box.style.display='block';
    } else {
         box.innerHTML = '<div class="item-sug" style="color:#999">NENHUM REGISTRO</div>';
         box.style.display='block';
         setTimeout(() => box.style.display='none', 3000); 
    }
}

window.sel = function(c, id, div) {
    const item = window.db[c].find(i=>i.id===id);
    if(div === 'sug-r-cli') {
        document.getElementById('r-search').value = item.nome;
        document.getElementById(div).style.display='none';
        renderRelatorio();
        return;
    }
    const inp = div.includes('v-') ? 'v-cli' : 's-cli';
    document.getElementById(inp).value = item.nome;
    document.getElementById(div).style.display='none';
}

// --- VENDAS ---
window.buscarVenda = function(txt, force=false) {
    const box = document.getElementById('sug-v-prod');
    if(!txt && !force) { box.style.display='none'; return; }
    
    const prods = window.db.produtos.filter(i => (i.nome||'').toUpperCase().includes((txt||'').toUpperCase())).slice(0,5);
    const servs = window.db.servicos.filter(i => (i.nome||'').toUpperCase().includes((txt||'').toUpperCase())).slice(0,5);
    
    let html = '';
    if(prods.length) html += `<div class="sug-header">PRODUTOS ESTOQUE</div>` + prods.map(i => `<div class="item-sug" onclick="addCar('${i.id}','P','${i.nome}',${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');
    if(servs.length) html += `<div class="sug-header" style="border-top:2px solid #ddd">SERVI√áOS</div>` + servs.map(i => `<div class="item-sug" onclick="addCar('${i.id}','S','${i.nome}',${i.precoVenda})"><span>${i.nome}</span> <b>R$ ${i.precoVenda}</b></div>`).join('');

    if(html === '') { box.innerHTML = '<div class="item-sug" style="color:#999">NENHUM ITEM</div>'; box.style.display = 'block'; setTimeout(() => box.style.display='none', 2000); } 
    else { box.innerHTML = html; box.style.display = 'block'; }
}

window.addCar = function(id, tipo, nome, val) {
    // AGREGAR SE J√Å EXISTIR
    const exist = window.carrinho.find(x => x.id === id);
    if(exist) {
        exist.qtd++;
        exist.val += val;
    } else {
        window.carrinho.push({ id, tipo, nome, val, qtd: 1, unit: val });
    }
    renderCarrinho();
    document.getElementById('v-busca').value = '';
    document.getElementById('sug-v-prod').style.display='none';
    document.getElementById('v-busca').focus();
}

window.renderCarrinho = function() {
    const l = document.getElementById('carrinho-lista');
    if(!window.carrinho.length) { l.innerHTML = 'CARRINHO VAZIO'; document.getElementById('v-total').innerText='TOTAL: R$ 0,00'; return; }
    
    let subtotal = 0;
    l.innerHTML = window.carrinho.map((i,x) => {
        subtotal += i.val;
        return `<div style="display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #eee; align-items:center">
            <span onclick="editItemVenda(${x})" style="flex:1; cursor:pointer">${i.qtd}x ${i.nome}</span>
            <span onclick="editItemVenda(${x})" style="cursor:pointer; display:flex; align-items:center; gap:5px; font-weight:bold; color:var(--primary)">
                <i class="fas fa-pen" style="font-size:10px; color:#555"></i> R$ ${i.val.toFixed(2)}
            </span>
            <i class="fas fa-trash" style="color:red;cursor:pointer;margin-left:10px" onclick="delCar(${x})"></i>
        </div>`;
    }).join('');
    
    const desconto = parseFloat(document.getElementById('v-desc').value) || 0;
    const totalFinal = subtotal - desconto;
    document.getElementById('v-total').innerText = 'TOTAL: R$ ' + totalFinal.toFixed(2);
}

window.editItemVenda = function(index) {
    const item = window.carrinho[index];
    const novoVal = prompt(`Alterar valor TOTAL de ${item.nome} (Qtd: ${item.qtd}):`, item.val);
    if(novoVal !== null) {
        const v = parseFloat(novoVal);
        if(!isNaN(v)) { window.carrinho[index].val = v; renderCarrinho(); }
    }
}

window.delCar = function(i) { window.carrinho.splice(i,1); renderCarrinho(); }
window.cadastrarNovoNaVenda = function() { window.retornoVenda=true; window.nav('clientes'); }
window.cadastrarNovoNaOS = function() { window.retornoOS=true; window.nav('clientes'); }

window.finalizarVenda = async function() {
    if(!window.carrinho.length) return alert("VAZIO");
    const cli = document.getElementById('v-cli').value || "CONSUMIDOR";
    const desconto = parseFloat(document.getElementById('v-desc').value) || 0;
    
    // Salva Itens COM QUANTIDADE
    for(let i of window.carrinho) {
        await addDoc(collection(db,"logs"), {
            tipo: i.tipo=='P'?'PRODUTO':'SERVICO', 
            desc: i.nome, 
            valor: i.val, 
            qtd: i.qtd || 1,
            cliente: cli, 
            data: new Date().toISOString()
        });
    }
    // Salva Desconto se houver
    if(desconto > 0) {
        await addDoc(collection(db,"logs"), {tipo:'DESCONTO', desc:'DESCONTO PROMOCIONAL', valor: -desconto, cliente:cli, data:new Date().toISOString()});
    }

    const subtotal = window.carrinho.reduce((a,b)=>a+b.val,0);

    window.shareData = {
        tipo:'VENDA', 
        cliente:cli, 
        itens:window.carrinho, 
        subtotal: subtotal, 
        desconto: desconto,
        total: subtotal - desconto
    };
    
    window.carrinho=[]; 
    document.getElementById('v-cli').value='';
    document.getElementById('v-desc').value='';
    renderCarrinho();
    
    abrirModalShare();
}

// --- OS ---
window.addFotoOS = function(idx) { window.currentFotoIndex = idx; document.getElementById('os-foto-input').click(); }
window.processFotoOS = function(inp) {
    if(inp.files && inp.files[0]) {
         const r = new FileReader(); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const x = c.getContext('2d'); let w=i.width, h=i.height; if(w>h){if(w>400){h*=400/w;w=400}}else{if(h>400){w*=400/h;h=400}}; c.width=w; c.height=h; x.drawImage(i,0,0,w,h); window.osFotos[window.currentFotoIndex] = c.toDataURL('image/jpeg', 0.6); renderFotosOS(); } }; r.readAsDataURL(inp.files[0]);
    }
}
function renderFotosOS() {
    const slots = document.querySelectorAll('.os-foto-slot');
    window.osFotos.forEach((f, i) => { if(f) slots[i].innerHTML = `<img src="${f}">`; else slots[i].innerHTML = `<i class="fas fa-camera"></i>`; });
}

window.buscarItemOS = function(txt, force=false) {
    const box = document.getElementById('sug-os-item');
    if(!txt && !force) { box.style.display='none'; return; }
    
    const term = (txt||'').toUpperCase();
    const prods = window.db.produtos.filter(i => (i.nome||'').toUpperCase().includes(term)).slice(0,5);
    const servs = window.db.servicos.filter(i => (i.nome||'').toUpperCase().includes(term)).slice(0,5);
    
    let html = '';
    if(prods.length) html += `<div class="sug-header">PRODUTOS</div>` + prods.map(i => `<div class="item-sug" onclick="addItemOS('${i.nome}', ${i.precoVenda})">${i.nome} - R$ ${i.precoVenda}</div>`).join('');
    if(servs.length) html += `<div class="sug-header">SERVI√áOS</div>` + servs.map(i => `<div class="item-sug" onclick="addItemOS('${i.nome}', ${i.precoVenda})">${i.nome} - R$ ${i.precoVenda}</div>`).join('');
    
    if(html) { box.innerHTML = html; box.style.display='block'; } else { box.style.display='none'; }
}

window.addItemOS = function(nome, val) {
    const exist = window.carrinhoOS.find(x => x.nome === nome);
    if(exist) {
        exist.qtd = (exist.qtd || 1) + 1;
        exist.val += val;
    } else {
        window.carrinhoOS.push({nome, val, qtd: 1, unit: val}); 
    }
    renderItemsOS(); 
    document.getElementById('s-busca-item').value = ''; 
    document.getElementById('sug-os-item').style.display='none'; 
}

window.renderItemsOS = function() {
    const l = document.getElementById('os-lista-itens');
    if(!window.carrinhoOS.length) { l.innerHTML = '<div style="text-align:center;color:#ccc;font-size:10px">NENHUM ITEM</div>'; document.getElementById('s-total-display').innerText='TOTAL: R$ 0,00'; return; }
    
    let subtotal = 0;
    l.innerHTML = window.carrinhoOS.map((i,x) => {
        subtotal += i.val;
        return `<div style="display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #eee;align-items:center;font-size:12px">
            <span onclick="editItemOS(${x})" style="flex:1;cursor:pointer">${i.qtd||1}x ${i.nome}</span>
            <span onclick="editItemOS(${x})" style="cursor:pointer; display:flex; align-items:center; gap:5px; font-weight:bold; color:var(--primary)">
                <i class="fas fa-pen" style="font-size:10px; color:#555"></i> R$ ${i.val.toFixed(2)}
            </span>
            <i class="fas fa-trash" style="color:red;cursor:pointer;margin-left:8px" onclick="delItemOS(${x})"></i>
        </div>`;
    }).join('');
    
    const desconto = parseFloat(document.getElementById('s-desc').value) || 0;
    const totalFinal = subtotal - desconto;
    document.getElementById('s-total-display').innerText = 'TOTAL: R$ ' + totalFinal.toFixed(2);
}

window.editItemOS = function(index) {
    const item = window.carrinhoOS[index];
    const novoVal = prompt(`Alterar valor TOTAL de ${item.nome}:`, item.val);
    if(novoVal !== null) { const v = parseFloat(novoVal); if(!isNaN(v)) { window.carrinhoOS[index].val = v; renderItemsOS(); } }
}
window.delItemOS = function(i) { window.carrinhoOS.splice(i,1); renderItemsOS(); }

window.salvarOS = async function() {
    const id = document.getElementById('os-id').value;
    const statusOrig = document.getElementById('os-status-orig').value;
    const subtotal = window.carrinhoOS.reduce((a,b)=>a+b.val,0);
    const desconto = parseFloat(document.getElementById('s-desc').value) || 0;
    
    const os = {
        cliente: document.getElementById('s-cli').value,
        modelo: document.getElementById('s-mod').value,
        defeito: document.getElementById('s-def').value,
        garantia: document.getElementById('s-garantia').value, // SALVANDO GARANTIA
        senha: document.getElementById('s-senha').value,
        valor: subtotal - desconto, // Valor Final
        desconto: desconto,         // Salva desconto
        itens: window.carrinhoOS, 
        fotos: window.osFotos,
        status: statusOrig || 'pecas',
        data: new Date().toISOString()
    };
    if(id) await updateDoc(doc(db,"os_ativa",id), os); else await addDoc(collection(db,"os_ativa"), os);
    
    alert("OS SALVA COM SUCESSO!");
    limparOS();
    
    // Recarrega a p√°gina para limpar tudo
    window.location.reload(); 
}

// FUN√á√ÉO KANBAN COM BUSCA
window.renderKanban = function() {
    const c = {pecas:'', pgto:'', retirado:''};
    const flow = ['pecas', 'pgto', 'retirado'];
    const termoBusca = document.getElementById('busca-kanban') ? document.getElementById('busca-kanban').value.toUpperCase() : '';

    window.db.os.forEach(o => {
        // L√ìGICA DE FILTRO
        if(termoBusca) {
            const txt = (o.cliente + ' ' + o.modelo + ' ' + o.status).toUpperCase();
            if(!txt.includes(termoBusca)) return; 
        }

        const currentIdx = flow.indexOf(o.status);
        let navBtns = '';
        if(currentIdx > 0) navBtns += `<button class="btn-mini btn-dark" onclick="moveOS('${o.id}', -1)"><i class="fas fa-arrow-left"></i></button>`;
        if(currentIdx < 2) navBtns += `<button class="btn-mini btn-dark" onclick="moveOS('${o.id}', 1)"><i class="fas fa-arrow-right"></i></button>`;
        else navBtns += `<button class="btn-mini btn-primary" onclick="arqOS('${o.id}')"><i class="fas fa-archive"></i></button>`;

        c[o.status] += `
        <div class="os-card ${o.status}">
            <b>${o.cliente}</b>
            <div>${o.modelo}</div>
            <div style="font-weight:bold; color:var(--primary)">R$ ${o.valor.toFixed(2)}</div>
            <div style="display:flex; justify-content:space-between; margin-top:5px">
                   <div style="display:flex; gap:5px">${navBtns}</div>
                   <div style="display:flex; gap:5px">
                      <button class="btn-mini btn-info" onclick="editOS('${o.id}')"><i class="fas fa-pen"></i></button>
                      <button class="btn-mini btn-success" onclick="shareOS('${o.id}')"><i class="fas fa-share-alt"></i></button>
                      <button class="btn-mini btn-dark" style="background:#c62828" onclick="delOS('${o.id}')"><i class="fas fa-trash"></i></button>
                   </div>
            </div>
        </div>`;
    });
    document.getElementById('k-pecas').innerHTML = c.pecas;
    document.getElementById('k-pgto').innerHTML = c.pgto;
    document.getElementById('k-retirado').innerHTML = c.retirado;
}

window.delOS = async function(id) {
    if(prompt("SENHA ADM:") !== SENHA) return;
    if(confirm("Deseja EXCLUIR permanentemente esta OS?")) { await deleteDoc(doc(db, "os_ativa", id)); }
}

window.moveOS = async function(id, dir) {
    const flow = ['pecas', 'pgto', 'retirado'];
    const o = window.db.os.find(i=>i.id===id);
    const nextIdx = flow.indexOf(o.status) + dir;
    if(nextIdx >= 0 && nextIdx < flow.length) await updateDoc(doc(db,"os_ativa",id), {status: flow[nextIdx]});
}

// ARQUIVAR OS - AGORA SALVA ITEM POR ITEM NO RANKING
window.arqOS = async function(id) {
    if(!confirm("Arquivar?")) return;
    const o = window.db.os.find(i=>i.id===id);
    
    // Se tem itens definidos, salva um por um
    if (o.itens && o.itens.length > 0) {
        for(let item of o.itens) {
            await addDoc(collection(db,"logs"), {
                tipo:'SERVICO', 
                desc: item.nome, 
                valor: item.val, 
                qtd: item.qtd || 1,
                cliente: o.cliente, 
                data: new Date().toISOString()
            });
        }
    } else {
        // Fallback para OS antigas sem itens detalhados
        await addDoc(collection(db,"logs"), {
            tipo:'SERVICO', 
            desc: 'Servi√ßo OS: ' + o.modelo, 
            valor: o.valor, 
            qtd: 1,
            cliente: o.cliente, 
            data: new Date().toISOString()
        });
    }

    // Salva Desconto separadamente se houver
    if (o.desconto > 0) {
        await addDoc(collection(db,"logs"), {
            tipo:'DESCONTO', 
            desc: 'DESCONTO OS', 
            valor: -o.desconto, 
            cliente: o.cliente, 
            data: new Date().toISOString()
        });
    }

    await deleteDoc(doc(db,"os_ativa",id));
}

window.editOS = function(id) {
    const o = window.db.os.find(i=>i.id===id);
    document.getElementById('os-id').value=id; 
    document.getElementById('s-cli').value=o.cliente;
    document.getElementById('s-mod').value=o.modelo; 
    document.getElementById('os-status-orig').value = o.status;
    
    let def = o.defeito; let sen = o.senha || '';
    if(!sen && def && def.includes(' | S: ')) { const p = def.split(' | S: '); def = p[0]; sen = p[1]; }
    document.getElementById('s-def').value=def;
    document.getElementById('s-senha').value=sen;
    
    // Carrega Desconto
    document.getElementById('s-desc').value = o.desconto || '';

    // Carrega Garantia
    document.getElementById('s-garantia').value = o.garantia || '90 DIAS';

    if(o.itens && Array.isArray(o.itens)) window.carrinhoOS = o.itens;
    else window.carrinhoOS = o.valor > 0 ? [{nome: 'Servi√ßo/Pe√ßa (Antigo)', val: o.valor, qtd: 1}] : [];
    
    renderItemsOS();
    window.osFotos = o.fotos || [null, null, null, null];
    renderFotosOS();
    
    document.getElementById('page-servicos').scrollIntoView();
}

window.shareOS = function(id) {
    const o = window.db.os.find(i=>i.id===id);
    let obsTexto = o.defeito; let senhaTexto = o.senha || '';
    if(!senhaTexto && obsTexto && obsTexto.includes(' | S: ')) { const p = obsTexto.split(' | S: '); obsTexto = p[0]; senhaTexto = p[1]; }

    const itensList = (o.itens && o.itens.length) ? o.itens : [{nome:o.modelo, val:o.valor, qtd:1}];
    const subtotal = itensList.reduce((a,b)=>a+b.val,0);
    const desc = o.desconto || 0;

    window.shareData={
        tipo:'OS', 
        cliente:o.cliente, 
        itens: itensList, 
        subtotal: subtotal, 
        desconto: desc,
        total: o.valor, 
        obs: obsTexto,
        senha: senhaTexto,
        garantia: o.garantia || '90 DIAS', // Pega garantia
        fotos: o.fotos || []
    };
    abrirModalShare();
}

// --- CLIENTE/ESTOQUE ---
window.salvarCliente = async function() {
    const id = document.getElementById('c-id').value;
    const d = { nome: document.getElementById('c-nome').value, tel: document.getElementById('c-tel').value, bairro: document.getElementById('c-bairro').value, cidade: document.getElementById('c-cidade').value, foto: window.tempImg||'' };
    if(id) await updateDoc(doc(db,"clientes",id), d); else await addDoc(collection(db,"clientes"), d);
    limparCli();
    if(window.retornoVenda) { window.retornoVenda=false; window.nav('vendas'); document.getElementById('v-cli').value=d.nome; }
    if(window.retornoOS) { window.retornoOS=false; window.nav('servicos'); document.getElementById('s-cli').value=d.nome; }
}
window.listarCli = function() { document.getElementById('lista-clientes').innerHTML = window.db.clientes.map(renderCliCard).join(''); }

function renderCliCard(c) {
    const zapLink = c.tel ? `https://wa.me/55${c.tel.replace(/\D/g,'')}` : '#';
    return `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center">
        <div style="display:flex; gap:10px; align-items:center">
            ${c.foto?`<img src="${c.foto}" style="width:40px;height:40px;border-radius:50%">`:`<div style="width:40px;height:40px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center"><i class="fas fa-user"></i></div>`}
            <div>
                <b>${c.nome}</b><br>
                <span style="font-size:11px">${c.tel}</span>
                <div style="font-size:9px; color:#666; font-weight:bold">${c.bairro||''} ${c.cidade?'- '+c.cidade:''}</div>
            </div>
        </div>
        <div style="display:flex; gap:5px">
            ${c.tel ? `<a href="${zapLink}" target="_blank" class="btn-mini btn-zap" style="width:25px; text-decoration:none"><i class="fab fa-whatsapp"></i></a>` : ''}
            <button class="btn-mini btn-info" onclick="edtCli('${c.id}')"><i class="fas fa-pen"></i></button> 
            <button class="btn-mini btn-dark" onclick="del('clientes','${c.id}')"><i class="fas fa-trash"></i></button>
        </div>
    </div>`;
}

window.edtCli = function(id) {
    const c = window.db.clientes.find(i=>i.id===id);
    document.getElementById('c-id').value=id; document.getElementById('c-nome').value=c.nome; document.getElementById('c-tel').value=c.tel;
    document.getElementById('c-bairro').value=c.bairro||''; document.getElementById('c-cidade').value=c.cidade||'';
    window.tempImg=c.foto; 
    const view = document.getElementById('c-foto-view'); view.src=c.foto||''; 
    if(c.foto) view.classList.add('has-img'); else view.classList.remove('has-img');
    document.getElementById('form-cli').scrollIntoView();
}

window.salvarProduto = async function(t) {
    const col = t==='prod'?'produtos':'servicos_cad';
    const d = { nome: document.getElementById('p-nome').value, precoVenda: parseFloat(document.getElementById('p-venda').value||0), qtd: document.getElementById('p-qtd').value, custo: document.getElementById('p-custo').value, foto: window.tempImg||'' };
    const id = document.getElementById('p-id').value;
    if(id) await updateDoc(doc(db,col,id), d); else await addDoc(collection(db,col), d);
    limparEstoque();
}
window.listarEstoque = function(t) {
    const l = t==='prod'?window.db.produtos:window.db.servicos; const col=t==='prod'?'produtos':'servicos_cad';
    document.getElementById('lista-estoque').innerHTML = l.map(i => `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center"><div style="display:flex;gap:10px;align-items:center">${i.foto?`<img src="${i.foto}" style="width:40px;height:40px;border-radius:50%">`:`<div style="width:40px;height:40px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center"><i class="fas fa-box"></i></div>`}<div><b>${i.nome}</b><br>R$ ${i.precoVenda}</div></div><div><button class="btn-mini btn-info" onclick="edtProd('${col}','${i.id}')"><i class="fas fa-pen"></i></button> <button class="btn-mini btn-dark" onclick="del('${col}','${i.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('');
}
window.edtProd = function(col, id) {
    const i = (col=='produtos'?window.db.produtos:window.db.servicos).find(x=>x.id===id);
    document.getElementById('p-id').value=id; document.getElementById('p-nome').value=i.nome; document.getElementById('p-venda').value=i.precoVenda; document.getElementById('p-qtd').value=i.qtd||''; document.getElementById('p-custo').value=i.custo||'';
    document.getElementById('p-custo').type = 'password'; document.getElementById('btn-ver-custo').style.display = 'block';
    window.tempImg=i.foto; const view = document.getElementById('p-foto-view'); view.src=i.foto||''; if(i.foto) view.classList.add('has-img'); else view.classList.remove('has-img'); document.getElementById('page-estoque').querySelector('.card').scrollIntoView();
}
window.revelarCusto = function() { if(prompt("SENHA ADM:") === SENHA) { document.getElementById('p-custo').type = 'number'; document.getElementById('btn-ver-custo').style.display = 'none'; } }

// --- RELAT√ìRIOS (L√ìGICA AGRUPADA POR CLIENTE) ---
window.renderRelatorio = function() {
    const f = document.getElementById('r-filtro').value; const now = new Date();
    const searchTxt = document.getElementById('r-search').value.toUpperCase(); 
    
    // Filtra primeiro
    const logsFiltrados = window.db.logs.filter(l => {
        const d = new Date(l.data);
        let matchDate = false;
        if(f=='dia') matchDate = d.toDateString()===now.toDateString();
        else if(f=='semana') matchDate = (now-d) < 604800000;
        else if(f=='mes') matchDate = d.getMonth()===now.getMonth();
        else matchDate = d.getFullYear()===now.getFullYear();
        
        let matchText = true;
        if(searchTxt) {
            matchText = (l.cliente && l.cliente.toUpperCase().includes(searchTxt));
        }
        return matchDate && matchText;
    });

    // Agrupa por Cliente
    const clientesMap = {};
    let totalGeral = 0;

    logsFiltrados.forEach(l => {
        totalGeral += l.valor;
        if(!clientesMap[l.cliente]) {
            clientesMap[l.cliente] = { nome: l.cliente, total: 0, count: 0, ids: [] };
        }
        clientesMap[l.cliente].total += l.valor;
        clientesMap[l.cliente].count++;
        clientesMap[l.cliente].ids.push(l.id);
    });

    // Converte para array e ordena
    const clientesArray = Object.values(clientesMap).sort((a,b) => b.total - a.total);

    document.getElementById('r-hist').innerHTML = clientesArray.map(c => {
        return `<div style="padding:10px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center">
            <div style="font-size:11px">
                <b>${c.nome}</b><br>
                <span style="color:#777">${c.count} movimenta√ß√µes</span>
            </div>
            <div style="text-align:right">
                <b style="color:var(--primary); font-size:12px">R$ ${c.total.toFixed(2)}</b><br>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:5px; font-size:16px">
                    <i class="fas fa-eye" style="color:green; cursor:pointer" onclick="abrirExtratoCliente('${c.nome}')" title="Ver Detalhes"></i>
                    <i class="fas fa-pen" style="color:blue; cursor:pointer" onclick="abrirOpcoesEdicao('${c.nome}')" title="Editar"></i>
                    <i class="fas fa-trash" style="color:red; cursor:pointer" onclick="apagarHistoricoCliente('${c.nome}', '${c.ids.join(',')}')" title="Apagar Hist√≥rico"></i>
                </div>
            </div>
        </div>`;
    }).join('');

    if(clientesArray.length === 0) document.getElementById('r-hist').innerHTML = '<div style="text-align:center; padding:20px; color:#ccc">NENHUM DADO ENCONTRADO</div>';
    
    document.getElementById('r-total').innerText = "R$ " + totalGeral.toFixed(2);
    
    // Rankings simples
    const rank = (k, d) => {
        const c={}; 
        window.db.logs.forEach(i => { 
            const isProd = (i.tipo === 'PRODUTO');
            const isServ = (i.tipo === 'SERVICO' || i.tipo === 'S'); 
            const qtd = i.qtd || 1;

            if(k === 'CLI') {
                const n = i.cliente; 
                c[n] = (c[n]||0) + 1; 
            }
            else if(k === 'PROD' && isProd) {
                const n = i.desc; 
                c[n] = (c[n]||0) + qtd;
            }
            else if(k === 'SERV' && isServ) {
                const n = i.desc;
                c[n] = (c[n]||0) + qtd;
            }
        });
        document.getElementById(d).innerHTML = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`<div class="rank-item"><span>${x[0]}</span><b>${x[1]}</b></div>`).join('');
    }
    rank('CLI','rank-cli'); rank('PROD','rank-prod'); rank('SERV','rank-serv');
}

// NOVA FUN√á√ÉO DE OP√á√ïES DE EDI√á√ÉO
window.abrirOpcoesEdicao = function(nome) {
    document.getElementById('modal-overlay').style.display = 'flex';
    document.getElementById('modal-content-default').innerHTML = `
        <h3 style="justify-content:center">O QUE DESEJA EDITAR?</h3>
        <div style="font-size:12px; text-align:center; margin-bottom:15px; font-weight:bold; color:var(--primary)">${nome}</div>
        
        <button class="btn btn-primary" onclick="editarClienteRapido('${nome}')">
            <i class="fas fa-user-edit"></i> DADOS DO CLIENTE
        </button>
        
        <button class="btn btn-dark" style="margin-top:10px" onclick="editarMovimentacaoCliente('${nome}')">
            <i class="fas fa-list-ul"></i> MOVIMENTA√á√ïES
        </button>
        
        <button class="btn" style="background:#666; margin-top:10px" onclick="fecharModal({target:{id:'modal-overlay'}})">CANCELAR</button>
    `;
}

window.editarClienteRapido = function(nome) {
    fecharModal({target:{id:'modal-overlay'}});
    const cli = window.db.clientes.find(c => c.nome === nome);
    if(cli) {
        window.nav('clientes');
        window.edtCli(cli.id);
    } else {
        if(confirm("Cliente n√£o encontrado no cadastro. Deseja cadastrar agora?")) {
            window.nav('clientes');
            document.getElementById('c-nome').value = nome;
        }
    }
}

// MOSTRA LISTA DE LOGS PARA EDITAR
window.editarMovimentacaoCliente = function(nome) {
    fecharModal({target:{id:'modal-overlay'}});
    
    // Reutiliza o modal de extrato mas com fun√ß√£o de clique diferente
    const logs = window.db.logs.filter(l => l.cliente === nome).sort((a,b) => new Date(b.data) - new Date(a.data));
    
    let html = `<div style="padding:10px; background:#ffebee; border-bottom:1px solid #d32f2f; text-align:center; color:#d32f2f; font-weight:bold; font-size:11px">CLIQUE NO ITEM PARA EDITAR</div>`;
    
    logs.forEach(i => {
         const data = new Date(i.data).toLocaleDateString('pt-BR');
         html += `<div onclick="editLog('${i.id}')" style="background:white; padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer">
            <div>
                <span style="font-size:10px; color:#999">${data}</span><br>
                <b>${i.desc}</b>
            </div>
            <div style="text-align:right">
                <b>R$ ${i.valor.toFixed(2)}</b><br>
                <span style="font-size:9px; color:blue"><i class="fas fa-pen"></i> EDITAR</span>
            </div>
         </div>`;
    });

    document.getElementById('ext-nome').innerText = "EDITAR: " + nome;
    document.getElementById('ext-lista').innerHTML = html;
    document.getElementById('modal-extrato').style.display = 'flex';
}

window.editLog = async function(id) {
    if(prompt("SENHA ADM:") !== SENHA) return;
    
    const l = window.db.logs.find(i=>i.id===id);
    const novaDesc = prompt("NOVA DESCRI√á√ÉO:", l.desc);
    const novoVal = prompt("NOVO VALOR:", l.valor);
    
    if(novaDesc && novoVal) {
        await updateDoc(doc(db,"logs",id), { valor: parseFloat(novoVal), desc: novaDesc });
        alert("Atualizado!");
        document.getElementById('modal-extrato').style.display='none';
    }
}

// APAGAR HISTORICO DO CLIENTE (LIXEIRA)
window.apagarHistoricoCliente = async function(nome, idsStr) {
    if(prompt("SENHA ADM PARA APAGAR TUDO:") !== SENHA) return;
    if(!confirm(`ATEN√á√ÉO: Isso apagar√° ${idsStr.split(',').length} registros de ${nome}. Confirma?`)) return;
    
    const ids = idsStr.split(',');
    const batch = writeBatch(db);
    
    ids.forEach(id => {
        const ref = doc(db, "logs", id);
        batch.delete(ref);
    });

    await batch.commit();
    alert("Hist√≥rico apagado com sucesso.");
}

// ABRIR EXTRATO DETALHADO (OLHO) COM QUANTIDADE
window.abrirExtratoCliente = function(nome) {
    const logs = window.db.logs.filter(l => l.cliente === nome).sort((a,b) => new Date(b.data) - new Date(a.data));
    
    // Agrupar por data
    const porData = {};
    let totalExtrato = 0;

    logs.forEach(l => {
        const dataStr = new Date(l.data).toLocaleDateString('pt-BR');
        if(!porData[dataStr]) porData[dataStr] = [];
        porData[dataStr].push(l);
        totalExtrato += l.valor;
    });

    let html = '';
    for (const [data, itens] of Object.entries(porData)) {
        html += `<div style="margin-bottom:15px; background:white; padding:10px; border-radius:8px; border:1px solid #eee">
                    <div style="font-weight:bold; color:var(--primary); font-size:11px; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px"><i class="far fa-calendar-alt"></i> ${data}</div>`;
        
        let subDia = 0;
        itens.forEach(i => {
            subDia += i.valor;
            const isDesc = (i.tipo === 'DESCONTO');
            const color = isDesc ? 'color:red' : 'color:black';
            const descTxt = isDesc ? '<i class="fas fa-tag"></i> ' : '';
            const qtdTxt = (!isDesc && i.qtd > 1) ? `<b>${i.qtd}x</b> ` : '';

            html += `<div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:3px; ${color}">
                        <span>${descTxt}${qtdTxt}${i.desc}</span>
                        <span style="font-weight:bold">${i.valor < 0 ? '' : 'R$ '}${i.valor.toFixed(2)}</span>
                     </div>`;
        });
        html += `<div style="text-align:right; font-size:10px; font-weight:900; color:#555; margin-top:5px; border-top:1px dashed #ccc; padding-top:2px">TOTAL DIA: R$ ${subDia.toFixed(2)}</div></div>`;
    }
    
    window.extratoAtual = {
        cliente: nome,
        html: html, 
        dados: porData, 
        total: totalExtrato
    };

    document.getElementById('ext-nome').innerText = nome;
    document.getElementById('ext-lista').innerHTML = html + `<div style="text-align:center; font-size:18px; font-weight:900; margin-top:20px; color:var(--primary)">TOTAL GERAL: R$ ${totalExtrato.toFixed(2)}</div>`;
    document.getElementById('modal-extrato').style.display = 'flex';
}

window.fecharExtrato = function(e) {
    if(e.target.id === 'modal-extrato') document.getElementById('modal-extrato').style.display = 'none';
}

// COMPARTILHAR EXTRATO (BOT√ïES ESPEC√çFICOS)
window.shareExtrato = function(tipo) {
    if(!window.extratoAtual) return;
    const d = window.extratoAtual;
    if(tipo === 'zap') document.getElementById('modal-extrato').style.display='none';

    if(tipo === 'zap') {
        let txt = `*EXTRATO - ${EMPRESA.nome}*\nCLI: ${d.cliente}\n\n`;
        for (const [data, itens] of Object.entries(d.dados)) {
            txt += `*${data}*\n`;
            itens.forEach(i => {
                const qtd = (i.qtd > 1 && i.tipo !== 'DESCONTO') ? `${i.qtd}x ` : '';
                txt += `- ${qtd}${i.desc}: R$ ${i.valor.toFixed(2)}\n`;
            });
            txt += `\n`;
        }
        txt += `*TOTAL GERAL: R$ ${d.total.toFixed(2)}*`;
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
    } else {
        let htmlPrint = `
        <div class="p-header">
            <div class="p-title">${EMPRESA.nome}</div>
            <div class="p-info">${EMPRESA.end}</div>
            <div class="p-info">${EMPRESA.cid}</div>
            <div class="p-info">Tel: ${EMPRESA.tel}</div>
        </div>
        
        <div style="text-align:center; margin-bottom:15px; border-bottom:2px solid #000; padding-bottom:5px">
            <b>EXTRATO DO CLIENTE</b><br>
            ${d.cliente}
        </div>`;

        for (const [data, itens] of Object.entries(d.dados)) {
            htmlPrint += `<div style="font-weight:bold; margin-top:10px; border-bottom:1px solid #000">${data}</div>`;
            htmlPrint += `<table class="p-table"><tbody>`;
            itens.forEach(i => {
                const qtd = (i.qtd > 1 && i.tipo !== 'DESCONTO') ? `<b>${i.qtd}x</b> ` : '';
                htmlPrint += `<tr><td>${qtd}${i.desc}</td><td style="text-align:right">${i.valor.toFixed(2)}</td></tr>`;
            });
            htmlPrint += `</tbody></table>`;
        }

        htmlPrint += `
        <div class="p-total" style="font-size:18px; border-top:2px solid #000; margin-top:15px; padding-top:5px">
            TOTAL GERAL: R$ ${d.total.toFixed(2)}
        </div>
        <div style="text-align:center; margin-top:20px; font-size:10px">EMITIDO EM ${new Date().toLocaleString()}</div>
        `;
        
        const area = document.getElementById('area-print');
        area.innerHTML = htmlPrint;
        
        setTimeout(() => {
            window.print();
            setTimeout(() => { area.innerHTML = ''; }, 500); 
        }, 300);
    }
}
window.shareExtratoTotal = function() { window.shareExtrato('zap'); }

// --- EXTRAS E SHARE ---
window.del = async function(c, id) { if(c === 'logs') { if(!confirm("Apagar?")) return; await deleteDoc(doc(db,c,id)); return; } if(prompt("SENHA ADM:")===SENHA) await deleteDoc(doc(db,c,id)); }
window.toggleCusto = function() { if(prompt("SENHA ADM:")===SENHA) document.getElementById('box-custo').style.display='block'; }

window.abrirModalShare = function(m) {
    if(m=='orcamento' && window.carrinho.length) {
        const sub = window.carrinho.reduce((a,b)=>a+b.val,0);
        const desc = parseFloat(document.getElementById('v-desc').value) || 0;
        window.shareData = { tipo: 'ORCAMENTO', cliente: document.getElementById('v-cli').value, itens: window.carrinho, subtotal: sub, desconto: desc, total: sub - desc };
        abrirModalShare();
    }
}
window.abrirModalShare = function() { 
    // REINICIA CONTEUDO DO MODAL A√á√ïES GENERICAS
    document.getElementById('modal-content-default').innerHTML = `
        <h3 style="justify-content:center">A√á√ïES</h3>
        <button class="btn" style="background:#25d366; margin-top:10px" onclick="acaoShare('zap')"><i class="fab fa-whatsapp"></i> WHATSAPP</button>
        <button class="btn" style="background:#333; margin-top:10px" onclick="acaoShare('print')"><i class="fas fa-print"></i> T√âRMICA 80MM</button>
        <button class="btn" style="background:#d32f2f; margin-top:10px" onclick="acaoShare('pdf')"><i class="fas fa-file-pdf"></i> PDF / A4</button>
    `;
    document.getElementById('modal-overlay').style.display='flex'; 
}
window.fecharModal = function(e) { if(e.target.id=='modal-overlay') document.getElementById('modal-overlay').style.display='none'; }

// --- IMPRESS√ÉO AVAN√áADA (VENDA/OS) ---
window.acaoShare = function(tipo) {
    const d = window.shareData;
    document.getElementById('modal-overlay').style.display='none';

    // TEXTO PARA WHATSAPP
    let txt = `*${EMPRESA.nome}*\n` +
              `*${d.tipo}*\n` +
              `DATA: ${new Date().toLocaleString()}\n` +
              `CLI: ${d.cliente||'Consumidor'}\n` +
              `----------------\n` + 
              d.itens.map(i=>`${i.qtd||1}x ${i.nome} ... R$ ${i.val.toFixed(2)}`).join('\n') +
              `\n----------------\n`;
    
    if(d.desconto > 0) txt += `SUBTOTAL: R$ ${d.subtotal.toFixed(2)}\nDESCONTO: -R$ ${d.desconto.toFixed(2)}\n`;
    txt += `*TOTAL FINAL: R$ ${d.total.toFixed(2)}*`;
    
    if(d.garantia) txt += `\nGARANTIA: ${d.garantia}`;
    if(d.obs) txt += `\nOBS: ${d.obs}`;

    if(tipo=='zap') window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
    
    if(tipo=='print' || tipo=='pdf') {
        let htmlPrint = `
        <div class="p-header">
            <div class="p-title">${EMPRESA.nome}</div>
            <div class="p-info">${EMPRESA.end}</div>
            <div class="p-info">${EMPRESA.cid}</div>
            <div class="p-info">CNPJ: ${EMPRESA.cnpj}</div>
            <div class="p-info">Tel: ${EMPRESA.tel}</div>
            <div class="p-info">${EMPRESA.email}</div>
        </div>
        
        <div style="text-align:center; margin-bottom:10px; border-bottom:1px dashed #000; padding-bottom:5px">
            <b>${d.tipo}</b><br>
            ${new Date().toLocaleString()}
        </div>
        
        <div style="margin-bottom:10px; font-weight:bold; font-size:12px">
            CLIENTE: ${d.cliente || 'CONSUMIDOR'}
        </div>

        <table class="p-table">
            <thead><tr><th>QTD</th><th>ITEM</th><th style="text-align:right">R$</th></tr></thead>
            <tbody>
                ${d.itens.map(i => `<tr>
                    <td style="width:20px">${i.qtd||1}x</td>
                    <td>${i.nome}</td>
                    <td style="text-align:right">${i.val.toFixed(2)}</td>
                </tr>`).join('')}
            </tbody>
        </table>
        
        <div class="p-line"></div>
        
        <div style="display:flex; justify-content:space-between; font-size:11px">
            <span>SUBTOTAL:</span><span>R$ ${d.subtotal.toFixed(2)}</span>
        </div>`;
        
        if(d.desconto > 0) {
            htmlPrint += `
            <div style="display:flex; justify-content:space-between; font-size:11px; color:black">
                <span>DESCONTO:</span><span>- R$ ${d.desconto.toFixed(2)}</span>
            </div>`;
        }

        htmlPrint += `
        <div class="p-total" style="font-size:18px; border-top:1px solid #000; margin-top:5px; padding-top:5px">
            TOTAL: R$ ${d.total.toFixed(2)}
        </div>`;
        
        if(d.garantia || d.obs) {
            htmlPrint += `<div style="margin-top:10px; text-align:left; font-size:11px; border:1px solid #000; padding:5px; border-radius:5px">`;
            if(d.garantia) htmlPrint += `<b>GARANTIA:</b> ${d.garantia}<br>`;
            if(d.obs) htmlPrint += `<b>OBS:</b> ${d.obs}<br>`;
            htmlPrint += `</div>`;
        }

        htmlPrint += `
        <div class="p-sign">
            ASSINATURA DO CLIENTE
        </div>
        <div style="text-align:center; margin-top:15px; font-size:9px">OBRIGADO PELA PREFER√äNCIA!</div>
        `;
        
        const area = document.getElementById('area-print');
        area.innerHTML = htmlPrint;
        
        setTimeout(() => {
            window.print();
            setTimeout(() => { area.innerHTML = ''; }, 500); 
        }, 300);
    }
}
</script>

</body>
</html>
